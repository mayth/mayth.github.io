---
title: "RailsAdminの日時選択が日本語でバグる"
date: 2014-01-23 20:08:42 +0900
author: Mei Akizuru
tags:
    - Rails
    - i18n
    - Ruby
aliases:
    - /blog/2014/01/23/rails-admin-jp-problem/
---

# 概略
Rails Adminでdatetime型（日時）のカラムを含むモデルを操作する際、ロケールが日本語で、かつ[svenfuchs/rails-i18n](https://github.com/svenfuchs/rails-i18n)のファイルをそのまま使っていると例外`ArgumentError`(argument out of range)で死ぬ。

# 原因
そもそも内部で使ってる`Date._parse`（これはRubyの標準ライブラリである'time'に含まれる）が日本語形式（`y年m月d日`）での日付のパースに対応していない。

# 対策
**「日本語を使わなければいいんじゃないかな」**

Rails AdminではjQuery UIのdatepicker/timepickerを使っています。`input`要素の`data-options`属性にオプションをJSON形式で渡していて、このオプションの中に月名や曜日名、日付または時刻のフォーマットが含まれています。なのでこのオプションを変更して、フォーマットを`Date._parse`が対応している形式に変更すれば対策出来ます。このオプションは使用しているロケールに依存します（JavaScriptの実行時点ではなくてビューのテンプレートがレンダリングされた時点でオプションの中身が決定されて引き渡されます）。

が、もはや一体どこを弄ったらjQueryの(date|time)pickerに日本語が渡らないように出来るか調べる気力もなくなってしまったので、ロケール側を弄ることで対処しました。

具体的には`config/locales/ja.yml`の`date.formats`、および`time.formats`以下に存在する各種日付や時刻の形式を`Date._parse`がパース出来、日本語を含まないような形式に変更します。`%Y-%m-%d`とか`%Y-%m-%d %H:%M:%S`とか、数値と記号だけで表記するように変更すると幸せになれると思います。

これはロケール単位で変更出来るので、日本語のみ月名・曜日を含むような形式を避ければ問題ないと思います。英語のロケールの方では`%B %d, %Y`('January 23, 2014')とかが標準ですが、`Date._parse`はこの辺の形式には対応しているので問題ないです。

または、日本語ロケールの月名・曜日名の定義をそのまま英語に差し替えてしまうという手もあります。日本語ロケールにおいてもフォーマットは英語ロケールと統一したいという場合にはこの方がいいと思います。

欠点としては、影響がRails Adminに限らずアプリ全体に及んでしまう点が挙げられます。

試してはいませんが、他にはRails Adminのビューを弄れば出来そうな予感はします。要は`input`要素の`data-options`属性の中身を変更出来ればいいわけなので、ビューをカスタマイズして適切な形式のフォーマットを渡すとか、あるいは単純にJavaScriptで実行時に書き換えてやるとか、いろいろやりようはありそうです。が、そもそもビューのカスタマイズが面倒そうだったのでやってません。

# おまけ: 調査の経過
エラーを吐いたときのスタックトレースを見ながら各メソッドに渡っている引数を見ると、引数に渡っている文字列が`2014年01Mon23Sun(Thu) 09:00`になっていたのでこの辺を調べた。

日本語ロケールで使用する場合、管理画面上のdatetime pickerを使うとコントローラへは`2014年01月23日(木) 09:00`といった形式で選択した日時が渡る。RailsAdminはこれを`RailsAdmin::Config::Fields::Types::Datetime.parse_input`メソッドを使ってパースしようとする。

ここでパースするとき、`normalize`メソッドを通す。`normalize`メソッドはパースしようとする文字列と、フォーマット文字列を渡す（フォーマット文字列については[Time.strftime](http://docs.ruby-lang.org/ja/2.1.0/class/Time.html#I_STRFTIME)の説明を見るとよさげ）。日時に関しては、概略で示した日本語ロケールのファイルの場合、これは`%Y年%m月%d日(%a) %H:%M`である。`normalize`メソッドからさらにメソッド呼び出しを辿ると最終的に`Date._parse`メソッドに文字列を渡してパースすることがわかった。

DateTimeに対応する`normalize`メソッドは、英語ロケール以外が選択されており、かつ月名（とその省略形）、曜日名（とのその省略形）、午前/午後のフォーマット文字列が含まれるときに、パース対象の文字列に含まれる英語以外のロケールのそれらを、英語ロケールに置換する。フォーマット文字列でいえば`%[AaBbp]`のいずれかが含まれる場合に該当する。つまり`2014年01月23日(木) 09:00`と`%Y年%m月%d日(%a) %H:%M`が渡ったときに、`2014年01月23日(Thu) 09:00`を返すはずである。

前述のフォーマット文字列には`%a`（曜日）が含まれるのでこの置換が発生するが、このとき単純に全ての曜日の文字を置換してしまう。要は「月」→"Mon"、「火」→"Tue"、「水」→"Wed"、…という置換をパース対象文字列に行うわけだが、「月」と「日」が曜日以外に現れるせいでこれが巻き込まれて形式が狂う。その結果として最初に示した`2014年01Mon23Sun(Thu) 09:00`になってしまう。「01月」の「月」と「23日」の「日」が置換されてしまったわけだ。

で、ここで文字列が壊れてしまったのが原因なんじゃないかと思ったが、ふとそこでデバッガを使ってパース対象文字列を強引に元の正しい文字列に直しても同じエラーが発生する。別のコンソールでpryを立ち上げて同じ文字列を`Date._parse`に食わせたところ、同じ結果が返ってくる。今回の場合、月の値が20になってしまっている。こうして問題は前述の置換処理でもなんでもなく、そもそも冒頭に述べたように`Date._parse`が「2014年01月23日」というような日本語の形式に対応していないかららしい、ということになった。