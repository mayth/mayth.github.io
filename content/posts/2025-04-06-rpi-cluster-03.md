---
title: "Raspberry Piã§Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ã‚’çµ„ã‚€ï¼ˆãã®3: k8sã‚¯ãƒ©ã‚¹ã‚¿æ§‹ç¯‰ç·¨ï¼‰"
date: 2025-04-06T18:41:00+09:00
author: Mei Akizuru
slug: rpi-cluster-01
tags:
    - tech
    - Raspberry Pi
---

ãã®2ãŒ2022å¹´ã®å¤ãªã®ã§ã‚‚ã†3å¹´è¿‘ãæ”¾ç½®ã—ã¦ã„ãŸRaspberryPiã§k8sã€ãªã‚“ã¨ãªããã‚ãã‚æ‰‹ã‚’ä»˜ã‘ã‚‹ã‹ã¨æ€ã£ãŸã®ã§å†é–‹ã™ã‚‹ã“ã¨ã«ã—ãŸã€‚

ãªã‚“ã§æ”¾ç½®ã—ãŸã‹ã¨ã„ã†ã¨ã€`kubeadm init`ã¯æ­£å¸¸ã«çµ‚äº†ã™ã‚‹ã‚‚ã®ã®apiserverãŒç„¡é™å†èµ·å‹•ç·¨ã«çªå…¥ã—ã¦æ­£å¸¸ã«ç¨¼åƒã—ãªãã¦å¿ƒãŒæŠ˜ã‚ŒãŸã¨ã„ã†ã®ãŒã‚ã‚‹ã€‚

<blockquote class="twitter-tweet"><p lang="ja" dir="ltr">ä¸€ç”Ÿkubeadm initãŒæˆåŠŸã—ãªã„ã€ã„ã‚„æˆåŠŸã™ã‚‹ã‚“ã ã‘ã©ãã®å¾Œapiserverã‚„ã‚‰schedulerã‚„ã‚‰ãŒå‹æ‰‹ã«å†èµ·å‹•ã—ã¾ãã£ã¦ã¦ä½¿ã„ç‰©ã«ãªã‚‰ãªã„ã€ãªã‚“ã ã“ã‚Œâ€¦â€¦</p>&mdash; ç§‹å¼¦ã‚ã„â˜‚ (@maytheplic) <a href="https://twitter.com/maytheplic/status/1543970689610563585?ref_src=twsrc%5Etfw">July 4, 2022</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

çµå±€åŸå› ã‚’è¿½åŠã§ããªãã¦ãŠæ‰‹ä¸Šã’ã«ãªã£ãŸã‚ã‘ã ãŒã€ãã‚Œã‹ã‚‰ã¾ã3å¹´ã‚‚çµŒã¦ã°ä½•ã‹ã—ã‚‰å¤‰åŒ–ãŒã‚ã‚‹ã ã‚ã†ã¨æ€ã£ã¦å†æŒ‘æˆ¦ã—ã¦ã¿ã‚‹ã€‚

ãªãŠã€ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆã¯ã»ã¼å¤‰ã‚ã‚‰ãªã„ãŒã€Raspberry Pi OSã¯ãƒ™ãƒ¼ã‚¹ã«ãªã‚‹Debianã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒä¸ŠãŒã£ã¦Bullseyeã‹ã‚‰Bookwormã«ãªã£ã¦ã„ã‚‹ã€‚

## ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ§‹æˆ

æˆ‘ãŒå®¶ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¯`192.168.39.0/24`ãŒåŸºæœ¬ã«ãªã£ã¦ã„ã‚‹ï¼ˆ`39`ã¯ä¹±æ•°ã§æŒ¯ã£ãŸã ã‘ï¼‰ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ãŠã‚ˆã³DNSã‚µãƒ¼ãƒãƒ¼ã¯`192.168.39.1`ã§ã‚ã‚‹ã€‚

å„ãƒãƒ¼ãƒ‰ã¯`thistle-[0-2]`ã¨ã„ã†ãƒ›ã‚¹ãƒˆåãŒæŒ¯ã‚‰ã‚Œã¦ãŠã‚Šã€`thistle-[0-2].intra.aquarite.info`ã§åå‰è§£æ±ºãŒã§ãã‚‹ã€‚ãªãŠã€ã“ã‚Œã¯å®…å†…ã®DNSã‚µãƒ¼ãƒãƒ¼ã«è¨­å®šã‚’ä»•è¾¼ã‚“ã§ã‚ã‚‹ã ã‘ã§ã€å½“ç„¶å¤–éƒ¨ã‹ `intra.aquarite.info`ã®åå‰è§£æ±ºã¯ã§ããªã„ã€‚ã¾ãŸã€`thistle-[0-2]`ã¯IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å›ºå®šã—ã¦ã„ã¦ã€`thistle-0`ã‹ã‚‰é †ã«`192.168.39.[20-22]`ã¨ãªã£ã¦ã„ã‚‹ã€‚

Kubernetesã®ãŸã‚ã«ã¯`10.0.0.0/8`ã‚’å‰²ã‚Šå½“ã¦ã‚‹ã€‚


## ã‚·ã‚¹ãƒ†ãƒ ã®æº–å‚™

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã‚¹ãƒ¯ãƒƒãƒ—ãŒæœ‰åŠ¹ã ãŒã€kubeletã¯ã‚¹ãƒ¯ãƒƒãƒ—ãŒæœ‰åŠ¹ãªã¾ã¾ã§ã¯èµ·å‹•ã§ããªã„ã€‚ã‚¹ãƒ¯ãƒƒãƒ—ãŒã‚ã£ã¦ã‚‚èµ·å‹•ã™ã‚‹ã‚ˆã†ã«è¨­å®šã™ã‚‹ã‹ã€ã‚¹ãƒ¯ãƒƒãƒ—ã‚’ç„¡åŠ¹ã«ã™ã‚Œã°ã‚ˆã„ã€‚ä»Šå›ã¯ã‚¹ãƒ¯ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã€ç„¡åŠ¹ã«ã—ã¦ãŠãã€‚

ã¾ãšã¯çŠ¶æ…‹ã‚’ç¢ºèªã™ã‚‹ã€‚`free`ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€Swapã®totalãŒ`511Mi`ã¨è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‹ã‚‰ã€ã‚¹ãƒ¯ãƒƒãƒ—ãŒæœ‰åŠ¹ã§ã‚ã‚‹ã“ã¨ãŒã‚ã‹ã‚‹ã€‚

```
$ free -h
               total        used        free      shared  buff/cache   available
Mem:           7.6Gi       178Mi       7.3Gi       1.1Mi       249Mi       7.5Gi
Swap:          511Mi          0B       511Mi
```

ã‚¹ãƒ¯ãƒƒãƒ—ç„¡åŠ¹åŒ–ã¨ã€ã‚¹ãƒ¯ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç®¡ç†ã™ã‚‹ `dphys-swapfile` ã®åœæ­¢ã‚’è¡Œã†ã€‚

```
$ sudo swapoff --all
$ sudo systemctl stop dphys-swapfile.service
$ sudo systemctl disable dphys-swapfile.service
```

IPv4ã®IPãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã€‚

```
$ sudo sysctl -w net.ipv4.ip_forward=1
```

æ¬¡ã«memory cgroupã‚’æœ‰åŠ¹ã«ã™ã‚‹ã€‚`/boot/firmware/cmdline.txt` ã‚’é–‹ãã€è¡Œæœ«ã« `cgroup_enable=memory cgroup_memory=1` ã‚’è¿½è¨˜ã™ã‚‹ã€‚

```
$ cat /boot/firmware/cmdline.txt
console=serial0,115200 console=tty1 root=PARTUUID=99a9f0e9-02 rootfstype=ext4 fsck.repair=yes rootwait cgroup_enable=memory cgroup_memory=1
```

æœ€å¾Œã«`br_netfilter`ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã€‚èµ·å‹•æ™‚ã«èª­ã¿è¾¼ã¾ã‚Œã‚‹ã‚ˆã†ã«`/etc/modules-load.d/`ä»¥ä¸‹ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã‚‹ã€‚

```
$ echo br_netfilter | sudo tee /etc/modules-load.d/br_netfilter.conf
```

ã“ã“ã§ä¸€å›å†èµ·å‹•ã™ã‚‹ã€‚

ãªãŠã€cgroupsã®çŠ¶æ…‹ã¯ `/proc/cgroups` ã§ç¢ºèªã§ãã‚‹ã€‚ç„¡åŠ¹ã®çŠ¶æ…‹ã ã¨ã€æ¬¡ã®ã‚ˆã†ã« `memory` ã®è¡Œã® `enabled` ãŒ `0` ã«ãªã£ã¦ã„ã‚‹ã€‚

```
$ cat /proc/cgroups
#subsys_name	hierarchy	num_cgroups	enabled
cpuset	0	38	1
cpu	0	38	1
cpuacct	0	38	1
blkio	0	38	1
memory	0	38	0
devices	0	38	1
freezer	0	38	1
net_cls	0	38	1
perf_event	0	38	1
net_prio	0	38	1
pids	0	38	1
```

ä¸Šè¨˜ã®é€šã‚Šç·¨é›†ã—ã¦å†èµ·å‹•ã™ã‚‹ã¨ã€`1` ã«å¤‰ã‚ã£ã¦ã„ã‚‹ã€‚

```
$ cat /proc/cgroups
#subsys_name	hierarchy	num_cgroups	enabled
cpuset	0	69	1
cpu	0	69	1
cpuacct	0	69	1
blkio	0	69	1
memory	0	69	1
devices	0	69	1
freezer	0	69	1
net_cls	0	69	1
perf_event	0	69	1
net_prio	0	69	1
pids	0	69	1
```


## ã‚³ãƒ³ãƒ†ãƒŠãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã®æº–å‚™

ä»Šå›ã¯CRI-Oã‚’æ¡ç”¨ã™ã‚‹ã€‚ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯v1.32ç³»ã‚’æ¡ç”¨ã™ã‚‹ã“ã¨ã¨ã—ã€æ¬¡ã®é€šã‚Šç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ã¦ãŠãã€‚

```
KUBERNETES_VERSION=v1.32
CRIO_VERSION=v1.32
```

https://github.com/cri-o/packaging/blob/main/README.md#distributions-using-deb-packages ã«å¾“ã£ã¦ãƒªãƒã‚¸ãƒˆãƒªã®è¿½åŠ ã¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’è¡Œã†ã€‚

```
$ curl -fsSL https://pkgs.k8s.io/core:/stable:/$KUBERNETES_VERSION/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
$ echo "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/$KUBERNETES_VERSION/deb/ /" | sudo tee -a /etc/apt/sources.list.d/kubernetes.list

$ curl -fsSL https://download.opensuse.org/repositories/isv:/cri-o:/stable:/$CRIO_VERSION/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/cri-o-apt-keyring.gpg
$ echo "deb [signed-by=/etc/apt/keyrings/cri-o-apt-keyring.gpg] https://download.opensuse.org/repositories/isv:/cri-o:/stable:/$CRIO_VERSION/deb/ /" | sudo tee /etc/apt/sources.list.d/cri-o.list

$ sudo apt update
$ sudo apt install cri-o kubelet kubeadm kubectl
$ sudo systemctl enable --now crio.service
$ sudo systemctl enable --now kubelet
```

`kubeadm init` ã§ã‚¯ãƒ©ã‚¹ã‚¿ã‚’åˆæœŸåŒ–ã™ã‚‹ã€‚

```
$ sudo kubeadm init --control-plane-endpoint=thistle-0.intra.aquarite.info --pod-network-cidr=10.0.0.0/8
[init] Using Kubernetes version: v1.32.3
[preflight] Running pre-flight checks
	[WARNING SystemVerification]: missing optional cgroups: hugetlb
[preflight] Pulling images required for setting up a Kubernetes cluster
[preflight] This might take a minute or two, depending on the speed of your internet connection
[preflight] You can also perform this action beforehand using 'kubeadm config images pull'
[certs] Using certificateDir folder "/etc/kubernetes/pki"
[certs] Generating "ca" certificate and key
[certs] Generating "apiserver" certificate and key
[certs] apiserver serving cert is signed for DNS names [kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local thistle-0 thistle-0.intra.aquarite.info] and IPs [10.96.0.1 192.168.39.20]
[certs] Generating "apiserver-kubelet-client" certificate and key
[certs] Generating "front-proxy-ca" certificate and key
[certs] Generating "front-proxy-client" certificate and key
[certs] Generating "etcd/ca" certificate and key
[certs] Generating "etcd/server" certificate and key
[certs] etcd/server serving cert is signed for DNS names [localhost thistle-0] and IPs [192.168.39.20 127.0.0.1 ::1]
[certs] Generating "etcd/peer" certificate and key
[certs] etcd/peer serving cert is signed for DNS names [localhost thistle-0] and IPs [192.168.39.20 127.0.0.1 ::1]
[certs] Generating "etcd/healthcheck-client" certificate and key
[certs] Generating "apiserver-etcd-client" certificate and key
[certs] Generating "sa" key and public key
[kubeconfig] Using kubeconfig folder "/etc/kubernetes"
[kubeconfig] Writing "admin.conf" kubeconfig file
[kubeconfig] Writing "super-admin.conf" kubeconfig file
[kubeconfig] Writing "kubelet.conf" kubeconfig file
[kubeconfig] Writing "controller-manager.conf" kubeconfig file
[kubeconfig] Writing "scheduler.conf" kubeconfig file
[etcd] Creating static Pod manifest for local etcd in "/etc/kubernetes/manifests"
[control-plane] Using manifest folder "/etc/kubernetes/manifests"
[control-plane] Creating static Pod manifest for "kube-apiserver"
[control-plane] Creating static Pod manifest for "kube-controller-manager"
[control-plane] Creating static Pod manifest for "kube-scheduler"
[kubelet-start] Writing kubelet environment file with flags to file "/var/lib/kubelet/kubeadm-flags.env"
[kubelet-start] Writing kubelet configuration to file "/var/lib/kubelet/config.yaml"
[kubelet-start] Starting the kubelet
[wait-control-plane] Waiting for the kubelet to boot up the control plane as static Pods from directory "/etc/kubernetes/manifests"
[kubelet-check] Waiting for a healthy kubelet at http://127.0.0.1:10248/healthz. This can take up to 4m0s
[kubelet-check] The kubelet is healthy after 2.001340198s
[api-check] Waiting for a healthy API server. This can take up to 4m0s
[api-check] The API server is healthy after 9.003387504s
[upload-config] Storing the configuration used in ConfigMap "kubeadm-config" in the "kube-system" Namespace
[kubelet] Creating a ConfigMap "kubelet-config" in namespace kube-system with the configuration for the kubelets in the cluster
[upload-certs] Skipping phase. Please see --upload-certs
[mark-control-plane] Marking the node thistle-0 as control-plane by adding the labels: [node-role.kubernetes.io/control-plane node.kubernetes.io/exclude-from-external-load-balancers]
[mark-control-plane] Marking the node thistle-0 as control-plane by adding the taints [node-role.kubernetes.io/control-plane:NoSchedule]
[bootstrap-token] Using token: ***
[bootstrap-token] Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles
[bootstrap-token] Configured RBAC rules to allow Node Bootstrap tokens to get nodes
[bootstrap-token] Configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order for nodes to get long term certificate credentials
[bootstrap-token] Configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token
[bootstrap-token] Configured RBAC rules to allow certificate rotation for all node client certificates in the cluster
[bootstrap-token] Creating the "cluster-info" ConfigMap in the "kube-public" namespace
[kubelet-finalize] Updating "/etc/kubernetes/kubelet.conf" to point to a rotatable kubelet client certificate and key
[addons] Applied essential addon: CoreDNS
[addons] Applied essential addon: kube-proxy

Your Kubernetes control-plane has initialized successfully!

To start using your cluster, you need to run the following as a regular user:

  mkdir -p $HOME/.kube
  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
  sudo chown $(id -u):$(id -g) $HOME/.kube/config

Alternatively, if you are the root user, you can run:

  export KUBECONFIG=/etc/kubernetes/admin.conf

You should now deploy a pod network to the cluster.
Run "kubectl apply -f [podnetwork].yaml" with one of the options listed at:
  https://kubernetes.io/docs/concepts/cluster-administration/addons/

You can now join any number of control-plane nodes by copying certificate authorities
and service account keys on each node and then running the following as root:

  kubeadm join thistle-0.intra.aquarite.info:6443 --token *** \
	--discovery-token-ca-cert-hash sha256:*** \
	--control-plane

Then you can join any number of worker nodes by running the following on each as root:

kubeadm join thistle-0.intra.aquarite.info:6443 --token *** \
	--discovery-token-ca-cert-hash sha256:***
```

â€» ä¸€å¿œãƒˆãƒ¼ã‚¯ãƒ³ã¨ã‹ãƒãƒƒã‚·ãƒ¥ã®ã¨ã“ã‚ã¯æ½°ã—ã¦ã„ã‚‹ã€‚

æ®‹ã‚Šã®2ãƒãƒ¼ãƒ‰ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æœ€å¾Œã«è¡¨ç¤ºã•ã‚ŒãŸã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã€‚

```
$ sudo kubeadm join thistle-0.intra.aquarite.info:6443 --token *** \
        --discovery-token-ca-cert-hash sha256:***
[preflight] Running pre-flight checks
	[WARNING SystemVerification]: missing optional cgroups: hugetlb
[preflight] Reading configuration from the "kubeadm-config" ConfigMap in namespace "kube-system"...
[preflight] Use 'kubeadm init phase upload-config --config your-config.yaml' to re-upload it.
[kubelet-start] Writing kubelet configuration to file "/var/lib/kubelet/config.yaml"
[kubelet-start] Writing kubelet environment file with flags to file "/var/lib/kubelet/kubeadm-flags.env"
[kubelet-start] Starting the kubelet
[kubelet-check] Waiting for a healthy kubelet at http://127.0.0.1:10248/healthz. This can take up to 4m0s
[kubelet-check] The kubelet is healthy after 1.503925623s
[kubelet-start] Waiting for the kubelet to perform the TLS Bootstrap

This node has joined the cluster:
* Certificate signing request was sent to apiserver and a response was received.
* The Kubelet was informed of the new secure connection details.

Run 'kubectl get nodes' on the control-plane to see this node join the cluster.
```

ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒãƒ¼ãƒ‰ã§ãƒãƒ¼ãƒ‰ã®æƒ…å ±ã‚’å–å¾—ã™ã‚‹ã€‚CNIãŒå…¥ã£ã¦ã„ãªã„ã®ã§å…¨ã¦ã®ãƒãƒ¼ãƒ‰ãŒNotReadyã«ãªã£ã¦ã„ã‚‹ã€‚

```
 $ kubectl get nodes
NAME        STATUS     ROLES           AGE     VERSION
thistle-0   NotReady   control-plane   4m21s   v1.32.3
thistle-1   NotReady   <none>          2m30s   v1.32.3
thistle-2   NotReady   <none>          2m21s   v1.32.3
```

## Ciliumã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆå¤±æ•—ï¼‰

ã¾ãšã¯å…¬å¼ã®ã‚¹ãƒ‹ãƒšãƒƒãƒˆã‚’ãã®ã¾ã¾å®Ÿè¡Œã™ã‚‹ã€‚

```
CILIUM_CLI_VERSION=$(curl -s https://raw.githubusercontent.com/cilium/cilium-cli/main/stable.txt)
CLI_ARCH=amd64
if [ "$(uname -m)" = "aarch64" ]; then CLI_ARCH=arm64; fi
curl -L --fail --remote-name-all https://github.com/cilium/cilium-cli/releases/download/${CILIUM_CLI_VERSION}/cilium-linux-${CLI_ARCH}.tar.gz{,.sha256sum}
sha256sum --check cilium-linux-${CLI_ARCH}.tar.gz.sha256sum
sudo tar xzvfC cilium-linux-${CLI_ARCH}.tar.gz /usr/local/bin
rm cilium-linux-${CLI_ARCH}.tar.gz{,.sha256sum}
```

Cilium CLIã‚’ç¢ºèªã™ã‚‹ã€‚

```
$ which cilium
/usr/local/bin/cilium
```

ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã€‚ã“ã®æ™‚ç‚¹ã§ã®æœ€æ–°ç‰ˆã¯1.17.2ã€‚

```
$ cilium install --version 1.17.2
â„¹ï¸  Using Cilium version 1.17.2
ğŸ”® Auto-detected cluster name: kubernetes
ğŸ”® Auto-detected kube-proxy has been installed
```

ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèªã™ã‚‹ã€‚`--wait`ã‚’ä¸ãˆã‚‹ã¨æ­£å¸¸ãªçŠ¶æ…‹ã«ãªã‚‹ã¾ã§ãƒ«ãƒ¼ãƒ—ã™ã‚‹ã€‚

```
$ cilium status --wait
    /Â¯Â¯\
 /Â¯Â¯\__/Â¯Â¯\    Cilium:             1 errors, 2 warnings
 \__/Â¯Â¯\__/    Operator:           OK
 /Â¯Â¯\__/Â¯Â¯\    Envoy DaemonSet:    1 errors, 1 warnings
 \__/Â¯Â¯\__/    Hubble Relay:       disabled
    \__/       ClusterMesh:        disabled

DaemonSet              cilium                   Desired: 3, Ready: 1/3, Available: 1/3, Unavailable: 2/3
DaemonSet              cilium-envoy             Desired: 3, Unavailable: 3/3
Deployment             cilium-operator          Desired: 1, Ready: 1/1, Available: 1/1
Containers:            cilium                   Pending: 2, Running: 1
                       cilium-envoy             Pending: 1, Running: 2
                       cilium-operator          Running: 1
...
```

ã—ã°ã‚‰ãå¾…ã¦ã°æ­£å¸¸çµ‚äº†ã™ã‚‹ã¯ãšãŒã€Envoy DaemonSetã§ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ä¸€å‘ã«çµ‚äº†ã—ãªã„ã€‚ä¸€æ—¦Ctrl-Cã§æ­¢ã‚ã¦ã€ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ã¿ã‚‹ã€‚ã¾ãšã¯podã®ä¸€è¦§ã‚’è¦‹ã‚‹ã€‚

```
$ kubectl -n kube-system get pods
NAME                                READY   STATUS             RESTARTS      AGE
cilium-4kw74                        1/1     Running            0             3m17s
cilium-envoy-jp7xv                  0/1     CrashLoopBackOff   4 (20s ago)   3m17s
cilium-envoy-v6rtr                  0/1     CrashLoopBackOff   4 (18s ago)   3m17s
cilium-envoy-w2fzn                  0/1     CrashLoopBackOff   5 (10s ago)   3m17s
cilium-nw99x                        1/1     Running            0             3m17s
cilium-operator-59944f4b8f-t77mw    1/1     Running            0             3m17s
cilium-pwcfx                        1/1     Running            0             3m17s
coredns-86c5fccbb-2css6             1/1     Running            0             2m17s
coredns-86c5fccbb-ztp94             1/1     Running            0             2m17s
etcd-thistle-0                      1/1     Running            1             9m24s
kube-apiserver-thistle-0            1/1     Running            1             9m24s
kube-controller-manager-thistle-0   1/1     Running            1             9m24s
kube-proxy-ctmwg                    1/1     Running            0             7m29s
kube-proxy-jzcqj                    1/1     Running            0             7m38s
kube-proxy-rc25q                    1/1     Running            0             9m21s
kube-scheduler-thistle-0            1/1     Running            1             9m26s
```

`cilium-envoy-*` ãŒCrashLoopBackOffã«ãªã£ã¦ã„ã‚‹ã€‚`jp7xv`ã®podã®ãƒ­ã‚°ã‚’è¦‹ã‚‹ã€‚

```
$ kubectl -n kube-system logs cilium-envoy-jp7xv
external/com_github_google_tcmalloc/tcmalloc/system-alloc.cc:625] MmapAligned() failed - unable to allocate with tag (hint, size, alignment) - is something limiting address placement? 0x161600000000 1073741824 1073741824 @ 0x557b0bccc4 0x557b0b90e0 0x557b0b89a0 0x557b0981d0 0x557b0b6694 0x557b0b6468 0x557b08d988 0x557afa3c84 0x557afa09a0 0x7f94868614
external/com_github_google_tcmalloc/tcmalloc/arena.cc:58] FATAL ERROR: Out of memory trying to allocate internal tcmalloc data (bytes, object-size); is something preventing mmap from succeeding (sandbox, VSS limitations)? 131072 632 @ 0x557b0bd034 0x557b098260 0x557b0b6694 0x557b0b6468 0x557b08d988 0x557afa3c84 0x557afa09a0 0x7f94868614
```

ã©ã†ã‚‚ãƒ¡ãƒ¢ãƒªã®ç¢ºä¿ã«å¤±æ•—ã—ã¦ã„ã‚‹ã‚ˆã†ã ã€‚2è¡Œç›®ã§ã¯Out of memoryã¨è¨€ã£ã¦ã„ã‚‹ã®ã§ã€å¿µã®ãŸã‚ãƒ¡ãƒ¢ãƒªã®çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ã¿ã‚‹ãŒã€ãƒ¡ãƒ¢ãƒªã«ã¯ä½™è£•ãŒã‚ã‚‹ã®ã§åˆ¥ã®åŸå› ã§ã‚ã‚ã†ã¨æ€ã‚ã‚Œã‚‹ã€‚

```
$ free -h
               total        used        free      shared  buff/cache   available
Mem:           7.6Gi       878Mi       4.3Gi       3.4Mi       2.6Gi       6.8Gi
Swap:             0B          0B          0B
```

èª¿ã¹ã¦ã¿ã‚‹ã¨ã€ã©ã†ã‚„ã‚‰Envoyã€ã¨ã„ã†ã‹tcmallocã®å•é¡Œã§ã€Raspberry Pi (ARM64)ã§å‹•ä½œã—ãªã„ã‚ˆã†ã ã€‚ã‹ãªã‚Šå‰ã®issueã§ã¯ã‚ã‚‹ãŒã€ã‚³ãƒ¡ãƒ³ãƒˆè‡ªä½“ã¯2024å¹´ã¾ã§ã¤ã„ã¦ã„ã¦çŠ¶æ³ãŒæ”¹å–„ã•ã‚Œã¦ãªã•ãã†ãªé›°å›²æ°—ãŒã‚ã‚‹ã€‚å®Ÿéš›ã“ã†ã—ã¦å•é¡Œã‚’è¸ã‚“ã§ã„ã‚‹ã—â€¦â€¦ã€‚

* [Envoy 1.17-1.23 unable to start on Raspberry Â· Issue #23339 Â· envoyproxy/envoy](https://github.com/envoyproxy/envoy/issues/23339)
* [Cilium fails to launch on ARM64: Binary cilium-envoy cannot be executed Â· Issue #17467 Â· cilium/cilium](https://github.com/cilium/cilium/issues/17467)

å•é¡Œã‚’å›é¿ã™ã‚‹ã«ã¯ã‚«ãƒ¼ãƒãƒ«ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’å¤‰ãˆã¦ãƒ“ãƒ«ãƒ‰ã—ç›´ã™ã‹tcmallocã‚’ãƒ“ãƒ«ãƒ‰ã—ç›´ã™å¿…è¦ãŒã‚ã‚‹ã¨ã„ã†ã“ã¨ã§ã€ã•ã™ãŒã«ãƒ˜ãƒ“ãƒ¼éãã‚‹ã¨ã„ã†ã‹ã€ä»Šå¾Œã®ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãŒæ€ ã™ãã‚‹ã®ã§å¤§äººã—ãFlannelã‚’ä½¿ã†ã“ã¨ã«ã—ãŸã€‚ã¨ã„ã†ã‚ã‘ã§Ciliumã‚’ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€‚

```
$ cilium uninstall
```

## Flannelã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

Podãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®ç¯„å›²ã‚’`10.0.0.0/8`ã«ã—ã¦ã„ã‚‹ã®ã§å°‘ã€…ä¿®æ­£ãŒå¿…è¦ã§ã‚ã‚‹ã€‚ã¾ãšã¯YAMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã‚‹ã€‚

```
$ curl -LO 'https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml'
```

ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã„ã¦CIDRã®æŒ‡å®šã‚’ç·¨é›†ã™ã‚‹ã€‚

```
...
  net-conf.json: |
    {
      "Network": "10.0.0.0/8",
      "EnableNFTables": false,
      "Backend": {
        "Type": "vxlan"
      }
    }
...
```

ãã‚Œã‹ã‚‰`kubectl apply`ã‚’è¡Œã†ã€‚

```
$ kubectl apply -f kube-flannel.yml
namespace/kube-flannel created
serviceaccount/flannel created
clusterrole.rbac.authorization.k8s.io/flannel created
clusterrolebinding.rbac.authorization.k8s.io/flannel created
configmap/kube-flannel-cfg created
daemonset.apps/kube-flannel-ds created
```

ãƒãƒ¼ãƒ‰ã®çŠ¶æ…‹ã‚’ç¢ºèªã™ã‚‹ã¨ã€å…¨ãƒãƒ¼ãƒ‰ãŒReadyã«ãªã£ã¦ã„ã‚‹ã€‚

```
$ kubectl get nodes
NAME        STATUS   ROLES           AGE   VERSION
thistle-0   Ready    control-plane   25m   v1.32.3
thistle-1   Ready    <none>          23m   v1.32.3
thistle-2   Ready    <none>          23m   v1.32.3
```

3å¹´å‰ã‚ã‚“ã ã‘è©°ã¾ã£ãŸã®ã¯ä¸€ä½“ãªã‚“ã ã£ãŸã‚“ã ã‚ã†ã€‚

## CoreDNSãŒä¸ŠãŒã£ã¦ã“ãªã„

Podã®çŠ¶æ…‹ã‚’ç¢ºèªã™ã‚‹ã¨CoreDNSãŒèµ·å‹•ã—ã¦ã„ãªã„ã€‚

```
$ kubectl -n kube-system get pods
NAME                                READY   STATUS              RESTARTS   AGE
coredns-86c5fccbb-2css6             0/1     ContainerCreating   1          6h13m
coredns-86c5fccbb-ztp94             0/1     ContainerCreating   1          6h13m
etcd-thistle-0                      1/1     Running             3          6h20m
kube-apiserver-thistle-0            1/1     Running             3          6h20m
kube-controller-manager-thistle-0   1/1     Running             3          6h20m
kube-proxy-ctmwg                    1/1     Running             2          6h19m
kube-proxy-jzcqj                    1/1     Running             2          6h19m
kube-proxy-rc25q                    1/1     Running             2          6h20m
kube-scheduler-thistle-0            1/1     Running             3          6h21m
```

describeã§podã®çŠ¶æ…‹ã‚’è¦‹ã¦ã¿ã‚‹ã€‚

```
$ kubectl -n kube-system describe pods coredns-86c5fccbb-2css6
Name:                 coredns-86c5fccbb-2css6
Namespace:            kube-system
Priority:             2000000000
Priority Class Name:  system-cluster-critical
Service Account:      coredns
Node:                 thistle-0/192.168.39.20
Start Time:           Tue, 25 Mar 2025 04:58:34 +0900
Labels:               k8s-app=kube-dns
                      pod-template-hash=86c5fccbb
Annotations:          kubectl.kubernetes.io/restartedAt: 2025-03-25T04:58:33+09:00
Status:               Running
IP:
IPs:                  <none>
Controlled By:        ReplicaSet/coredns-86c5fccbb
Containers:
  coredns:
    Container ID:
    Image:         registry.k8s.io/coredns/coredns:v1.11.3
    Image ID:
    Ports:         53/UDP, 53/TCP, 9153/TCP
    Host Ports:    0/UDP, 0/TCP, 0/TCP
    Args:
      -conf
      /etc/coredns/Corefile
    State:          Waiting
      Reason:       ContainerCreating
    Last State:     Terminated
      Reason:       ContainerStatusUnknown
      Message:      The container could not be located when the pod was deleted.  The container used to be Running
      Exit Code:    137
      Started:      Mon, 01 Jan 0001 00:00:00 +0000
      Finished:     Mon, 01 Jan 0001 00:00:00 +0000
    Ready:          False
    Restart Count:  1
    Limits:
      memory:  170Mi
    Requests:
      cpu:        100m
      memory:     70Mi
    Liveness:     http-get http://:8080/health delay=60s timeout=5s period=10s #success=1 #failure=5
    Readiness:    http-get http://:8181/ready delay=0s timeout=1s period=10s #success=1 #failure=3
    Environment:  <none>
    Mounts:
      /etc/coredns from config-volume (ro)
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-6whk9 (ro)
Conditions:
  Type                        Status
  PodReadyToStartContainers   False
  Initialized                 True
  Ready                       False
  ContainersReady             False
  PodScheduled                True
Volumes:
  config-volume:
    Type:      ConfigMap (a volume populated by a ConfigMap)
    Name:      coredns
    Optional:  false
  kube-api-access-6whk9:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
QoS Class:                   Burstable
Node-Selectors:              kubernetes.io/os=linux
Tolerations:                 CriticalAddonsOnly op=Exists
                             node-role.kubernetes.io/control-plane:NoSchedule
                             node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type     Reason                  Age                     From     Message
  ----     ------                  ----                    ----     -------
  Warning  FailedCreatePodSandBox  9m54s (x281 over 5h5m)  kubelet  (combined from similar events): Failed to create pod sandbox: rpc error: code = Unknown desc = failed to create pod network sandbox k8s_coredns-86c5fccbb-2css6_kube-system_632c1b51-bec4-4935-a93f-d1191f76e6d6_0(935b3ad214394f5d3730b1c1a4f7cbe261dd29a0e5cce8ebcc3eaf945ec7eba8): error adding pod kube-system_coredns-86c5fccbb-2css6 to CNI network "cilium": plugin type="cilium-cni" failed (add): unable to connect to Cilium agent: failed to create cilium agent client after 30.000000 seconds timeout: Get "http://localhost/v1/config": dial unix /var/run/cilium/cilium.sock: connect: no such file or directory
Is the agent running?
  Warning  FailedCreatePodSandBox  3m8s  kubelet  Failed to create pod sandbox: rpc error: code = Unknown desc = failed to create pod network sandbox k8s_coredns-86c5fccbb-2css6_kube-system_632c1b51-bec4-4935-a93f-d1191f76e6d6_0(888b9d00c92b667b0e0b6d865ba9b96ff0e1afcee33acc2818e00d5f6ee5d64f): error adding pod kube-system_coredns-86c5fccbb-2css6 to CNI network "cilium": plugin type="cilium-cni" failed (add): unable to connect to Cilium agent: failed to create cilium agent client after 30.000000 seconds timeout: Get "http://localhost/v1/config": dial unix /var/run/cilium/cilium.sock: connect: no such file or directory
Is the agent running?
  Warning  FailedCreatePodSandBox  2m4s  kubelet  Failed to create pod sandbox: rpc error: code = Unknown desc = failed to create pod network sandbox k8s_coredns-86c5fccbb-2css6_kube-system_632c1b51-bec4-4935-a93f-d1191f76e6d6_0(345a1307bba81a94435d8aff9a3d79c67fca3683ad66284d475805c371a4b38c): error adding pod kube-system_coredns-86c5fccbb-2css6 to CNI network "cilium": plugin type="cilium-cni" failed (add): unable to connect to Cilium agent: failed to create cilium agent client after 30.000000 seconds timeout: Get "http://localhost/v1/config": dial unix /var/run/cilium/cilium.sock: connect: no such file or directory
Is the agent running?
  Warning  FailedCreatePodSandBox  63s  kubelet  Failed to create pod sandbox: rpc error: code = Unknown desc = failed to create pod network sandbox k8s_coredns-86c5fccbb-2css6_kube-system_632c1b51-bec4-4935-a93f-d1191f76e6d6_0(2e436ec645ce0fac36945db53eaaee27b1d89680484749ad6e2d72c9371f77c1): error adding pod kube-system_coredns-86c5fccbb-2css6 to CNI network "cilium": plugin type="cilium-cni" failed (add): unable to connect to Cilium agent: failed to create cilium agent client after 30.000000 seconds timeout: Get "http://localhost/v1/config": dial unix /var/run/cilium/cilium.sock: connect: no such file or directory
Is the agent running?
  Warning  FailedCreatePodSandBox  2s  kubelet  Failed to create pod sandbox: rpc error: code = Unknown desc = failed to create pod network sandbox k8s_coredns-86c5fccbb-2css6_kube-system_632c1b51-bec4-4935-a93f-d1191f76e6d6_0(4184bee28309b45aa260c25d2a92f68d6dbac4399ae028b465212cc4a25219ae): error adding pod kube-system_coredns-86c5fccbb-2css6 to CNI network "cilium": plugin type="cilium-cni" failed (add): unable to connect to Cilium agent: failed to create cilium agent client after 30.000000 seconds timeout: Get "http://localhost/v1/config": dial unix /var/run/cilium/cilium.sock: connect: no such file or directory
Is the agent running?
```

Eventsã‚’è¦‹ã‚‹ã¨ã€ã©ã†ã‚„ã‚‰Ciliumã‚’ä½¿ãŠã†ã¨ã—ã¦å¤±æ•—ã—ã¦ã„ã‚‹ã‚ˆã†ã«è¦‹ãˆã‚‹ã€‚Ciliumã¯æ—¢ã«ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸã®ã§å½“ç„¶ä½¿ãˆãªã„ãŒã€ãªãœãã‚‚ãã‚‚ä½¿ãŠã†ã¨ã—ã¦ã—ã¾ã†ã®ã‹ï¼Ÿ

ã¨ã„ã†ã‚ã‘ã§èª¿ã¹ã¦ã¿ã‚‹ã¨åŒã˜äº‹è±¡ã®è¨˜äº‹ãŒã‚ã£ãŸ: [kubernetesã§corednsãŒèµ·å‹•ã—ãªã„æ™‚ã«ç¢ºèªã™ã‚‹ã“ã¨ #Calico - Qiita](https://qiita.com/ishii1648/items/f0b9882834d63534461e)

`/etc/cni/net.d`ä»¥ä¸‹ã«ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ãã†ãªã®ã§ã€æ¢ã—ã¦ã¿ã‚‹ã€‚

```
$ cat /etc/cni/net.d/
05-cilium.conflist                10-flannel.conflist
10-crio-bridge.conflist.disabled  .kubernetes-cni-keep
$
```

`05-cilium.conflist`ãŒã‚ã‚‹ã€‚ã“ã‚Œã‚’å‰Šé™¤ã—ã¦ã—ã°ã‚‰ãã™ã‚‹ã¨ã€Runningã«ãªã£ãŸã€‚

```
$ sudo rm /etc/cni/net.d/05-cilium.conflist
$ kubectl -n kube-system get pods
NAME                                READY   STATUS              RESTARTS   AGE
coredns-86c5fccbb-2css6             1/1     Running             2          6h26m
coredns-86c5fccbb-q226s             0/1     ContainerCreating   0          10m
etcd-thistle-0                      1/1     Running             4          6h33m
kube-apiserver-thistle-0            1/1     Running             4          6h33m
kube-controller-manager-thistle-0   1/1     Running             4          6h33m
kube-proxy-ctmwg                    1/1     Running             2          6h31m
kube-proxy-jzcqj                    1/1     Running             2          6h31m
kube-proxy-rc25q                    1/1     Running             3          6h33m
kube-scheduler-thistle-0            1/1     Running             4          6h33m
```

å„ãƒãƒ¼ãƒ‰ã«`05-cilium.conflist`ãŒã‚ã£ãŸãŸã‚ã€ä»–ã®ãƒãƒ¼ãƒ‰ã§ã‚‚åŒæ§˜ã«å‰Šé™¤ã™ã‚‹ã¨ã€æ®‹ã£ã¦ã„ã‚‹ContainerCreatingã®ã‚‚ã®ã‚‚æ­£å¸¸åŒ–ã—ãŸã€‚

ã¨ã„ã†ã‚ã‘ã§k8sã‚¯ãƒ©ã‚¹ã‚¿ã®æ§‹ç¯‰ãŒå®Œäº†ã—ãŸã€‚æœ¬å½“ã«3å¹´å‰ã®apiserverç„¡é™å†èµ·å‹•ã¯ä½•ã ã£ãŸã‚“ã ã‚ã†ã­ã€‚
