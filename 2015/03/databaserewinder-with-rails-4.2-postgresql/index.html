<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content>
<meta name=generator content="Hugo 0.88.1">
<title>DatabaseRewinder with Rails 4.2 & PostgreSQL &#183; blog.aquarite.info</title>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/pure-min.css><!--[if lte IE 8]><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-old-ie-min.css><![endif]--><!--[if gt IE 8]><!-->
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-min.css><!--<![endif]--><!--[if lte IE 8]><link rel=stylesheet href=https://blog.aquarite.info/css/side-menu-old-ie.css><![endif]--><!--[if gt IE 8]><!-->
<link rel=stylesheet href=https://blog.aquarite.info/css/side-menu.css><!--<![endif]-->
<link rel=stylesheet href=https://blog.aquarite.info/css/blackburn.css>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css>
<link rel=preconnect href=https://fonts.gstatic.com>
<link href="https://fonts.googleapis.com/css2?family=Raleway&display=swap" rel=stylesheet type=text/css>
<script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<link rel=stylesheet href=//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/styles/tomorrow-night-bright.min.css>
<script async src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/highlight.min.js></script>
<script>hljs.initHighlightingOnLoad()</script>
<link rel="shortcut icon" href=https://blog.aquarite.info/img/favicon.ico type=image/x-icon>
</head>
<body>
<div id=layout>
<a href=#menu id=menuLink class=menu-link>
<span></span>
</a>
<div id=menu>
<a class="pure-menu-heading brand" href=https://blog.aquarite.info/>aquarite.info</a>
<div class=pure-menu>
<ul class=pure-menu-list>
<li class=pure-menu-item>
<a class=pure-menu-link href=https://blog.aquarite.info/><i class="fa fa-home fa-fw"></i>Home</a>
</li>
<li class=pure-menu-item>
<a class=pure-menu-link href=https://blog.aquarite.info/post/><i class="fa fa-list fa-fw"></i>Posts</a>
</li>
<li class=pure-menu-item>
<a class=pure-menu-link href=https://blog.aquarite.info/about/><i class="fa fa-user fa-fw"></i>About</a>
</li>
</ul>
</div>
<div class="pure-menu social">
<ul class=pure-menu-list>
<li class=pure-menu-item>
<a class=pure-menu-link href=https://twitter.com/maytheplic rel=me target=_blank><i class="fab fa-twitter-square fa-fw"></i>Twitter</a>
</li>
<li class=pure-menu-item>
<a class=pure-menu-link href=https://github.com/mayth rel=me target=_blank><i class="fab fa-github-square fa-fw"></i>GitHub</a>
</li>
<li class=pure-menu-item>
<a class=pure-menu-link href=https://steamcommunity.com/id/maythorzy rel=me target=_blank><i class="fab fa-steam-square fa-fw"></i>Steam</a>
</li>
</ul>
</div>
<div>
<div class=small-print>
<small>&copy; 2021 Mei Akizuru. All rights reserved.</small>
</div>
<div class=small-print>
<small>Built with&nbsp;<a href=https://gohugo.io/ target=_blank>Hugo</a></small>
<small>Theme&nbsp;<a href=https://github.com/yoshiharuyamashita/blackburn target=_blank>Blackburn</a></small>
</div>
</div>
</div>
<div id=main>
<div class=header>
<h1>DatabaseRewinder with Rails 4.2 & PostgreSQL</h1>
<h2></h2>
</div>
<div class=content>
<div class=post-meta>
<div>
<i class="fa fa-calendar fa-fw"></i>
<time>12 Mar 2015, 18:49</time>
</div>
<div>
<i class="fa fa-tags fa-fw"></i>
<a class=post-taxonomy-tag href=https://blog.aquarite.info/tags/ruby-on-rails>Ruby on Rails</a>&nbsp;/
<a class=post-taxonomy-tag href=https://blog.aquarite.info/tags/postgresql>PostgreSQL</a>
</div>
</div>
<p>Rails 4.2で新規プロジェクトを作ってPostgreSQLを使ったときにDatabaseRewinderが使えなかった話。私が使っていたのがDatabaseRewinderだったという話でたぶんDatabaseCleanerでも同じ現象は起こると思う。というか<code>disable_referential_integrity</code>を使っている限り起こると思う。</p>
<p>あとRails 4.2で外部キー制約をサポートしたから今ハマっただけで、実際のところ自分で外部キー制約を付与するとかしてたら同じ問題が起きていたはずで、ハマりやすくなった、というだけだとも思う。</p>
<h1 id=原因>原因</h1>
<ul>
<li>
<p>Rails 4.2からmigrationにおいて外部キー制約をサポートした(ref: <a href=http://guides.rubyonrails.org/4_2_release_notes.html#foreign-key-support>Ruby on Rails 4.2 Release Notes</a>)。scaffoldとかで<code>references</code>や<code>belongs_to</code>を使うと、生成されるmigrationファイルには<code>add_foreign_key</code>が使われる。</p>
</li>
<li>
<p>PostgreSQLでは外部キー制約はシステムトリガーでチェックされている。</p>
</li>
<li>
<p>システムトリガーはスーパーユーザーでないと無効に出来ない。そのデータベースやテーブルのオーナーでも不可。</p>
</li>
<li>
<p>DatabaseRewinderは<code>disable_referential_integrity</code>を使ってトリガーを無効にするが、上述の理由によりスーパーユーザーでないと無理。</p>
</li>
<li>
<p>トリガーを無効にしようとした時点で例外が出て、トランザクションはロールバック、同一トランザクションの後続クエリは無視される。</p>
</li>
<li>
<p>例外が出てるのでテストは失敗する。</p>
</li>
</ul>
<p>ちなみにここでいう「スーパーユーザー」はPostgreSQLのroleの話であって、システムのスーパーユーザーとは関係ない。</p>
<h1 id=解決策>解決策</h1>
<ul>
<li>スーパーユーザーでテストを走らせる。テストを動かすユーザーをスーパーユーザー権限を持ったユーザーに変更するか、テスト用のユーザーにスーパーユーザー権限を付与する:</li>
</ul>
<pre tabindex=0><code>ALTER ROLE username WITH SUPERUSER;
</code></pre><p>当たり前だがスーパーユーザー権限の付与にはスーパーユーザー権限が必要。</p>
<ul>
<li>
<p>（一時的に）外部キー制約を外す。</p>
</li>
<li>
<p>PostgreSQL使うのやめる（他のデータベースでどうなるのかは調べてない）。</p>
</li>
</ul>
<h1 id=ダメだった方法>ダメだった方法</h1>
<ul>
<li>migrationの<code>add_foreign_key</code>で<code>on_delete</code>オプションを<code>cascade</code>か<code>nullify</code>にしてみる。</li>
</ul>
<p><code>on_delete: :cascade</code>にしてみたがダメだった。解決しない理由は、「スーパーユーザーでないのにトリガーを無効にしようとした」後に来るDELETE文の発行までそもそも辿り着いてないからだと思う。</p>
<p>つまるところ、外部キー制約に違反するかどうかは問題ではないという感じがある。</p>
<p>(2015-03-13 追記)</p>
<h2 id=ダメじゃなくなるかもしれない方法>ダメじゃなくなるかもしれない方法</h2>
<p><code>ActiveRecord::ConnectionAdapters::PostgreSQL::ReferentialIntegrity#supports_disable_referential_integrity?</code>が<code>false</code>を返すようにすれば、そもそも問題の<code>disable_referential_integrity</code>が呼ばれない。このとき、上記のように<code>on_delete: :cascade</code>(or <code>:nullify</code>)を指定して、外部キー制約に違反したときにDELETEが失敗しないようになっていれば、特に問題なく動作を続行できるはず。</p>
<p>※試してない。</p>
<h1 id=links>Links</h1>
<ul>
<li><a href=http://blog.endpoint.com/2012/10/postgres-system-triggers-error.html>Postgres system triggers error: permission denied | End Point Blog</a></li>
</ul>
<p>この記事に「制約外せるのにその制約をチェックするトリガーを無効に出来ないのっておかしな話だよな」みたいなコメントがあって、確かになぁという気分になった。</p>
<h4><i class="fas fa-share-alt" aria-hidden=true></i>&nbsp;Share!</h4>
<ul class=share-buttons>
<li><a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.aquarite.info%2f2015%2f03%2fdatabaserewinder-with-rails-4.2-postgresql%2f" target=_blank title="Share on Facebook"><i class="fab fa-facebook" aria-hidden=true></i><span class=sr-only>Share on Facebook</span></a>
</li>&nbsp;&nbsp;&nbsp;
<li><a href="https://twitter.com/intent/tweet?source=https%3a%2f%2fblog.aquarite.info%2f2015%2f03%2fdatabaserewinder-with-rails-4.2-postgresql%2f" target=_blank title=Tweet><i class="fab fa-twitter" aria-hidden=true></i><span class=sr-only>Tweet</span></a>
</li>&nbsp;&nbsp;&nbsp;
<li><a href="https://plus.google.com/share?url=https%3a%2f%2fblog.aquarite.info%2f2015%2f03%2fdatabaserewinder-with-rails-4.2-postgresql%2f" target=_blank title="Share on Google+"><i class="fab fa-google-plus" aria-hidden=true></i><span class=sr-only>Share on Google+</span></a>
</li>&nbsp;&nbsp;&nbsp;
<li><a href="http://www.tumblr.com/share?v=3&u=https%3a%2f%2fblog.aquarite.info%2f2015%2f03%2fdatabaserewinder-with-rails-4.2-postgresql%2f" target=_blank title="Post to Tumblr"><i class="fab fa-tumblr" aria-hidden=true></i><span class=sr-only>Post to Tumblr</span></a>
</li>&nbsp;&nbsp;&nbsp;
<li><a href="http://pinterest.com/pin/create/button/?url=https%3a%2f%2fblog.aquarite.info%2f2015%2f03%2fdatabaserewinder-with-rails-4.2-postgresql%2f" target=_blank title="Pin it"><i class="fab fa-pinterest-p" aria-hidden=true></i><span class=sr-only>Pin it</span></a>
</li>&nbsp;&nbsp;&nbsp;
<li><a href="http://www.reddit.com/submit?url=https%3a%2f%2fblog.aquarite.info%2f2015%2f03%2fdatabaserewinder-with-rails-4.2-postgresql%2f" target=_blank title="Submit to Reddit"><i class="fab fa-reddit-alien" aria-hidden=true></i><span class=sr-only>Submit to Reddit</span></a>
</li>
</ul>
<style>ul.share-buttons{list-style:none;padding:0}ul.share-buttons li{display:inline}ul.share-buttons .sr-only{position:absolute;clip:rect(1px 1px 1px 1px);clip:rect(1px,1px,1px,1px);padding:0;border:0;height:1px;width:1px;overflow:hidden}</style>
<div class="prev-next-post pure-g">
<div class=pure-u-1-24 style=text-align:left>
<a href=https://blog.aquarite.info/2014/12/seccon-2014-online-qualification-december-write-up/><i class="fa fa-chevron-left"></i></a>
</div>
<div class=pure-u-10-24>
<nav class=prev>
<a href=https://blog.aquarite.info/2014/12/seccon-2014-online-qualification-december-write-up/>SECCON 2014 Online Qualification (December) write-up</a>
</nav>
</div>
<div class=pure-u-2-24>
&nbsp;
</div>
<div class=pure-u-10-24>
<nav class=next>
<a href=https://blog.aquarite.info/2021/09/octopress%E3%81%8B%E3%82%89hugo%E3%81%B8%E3%81%AE%E5%88%87%E3%82%8A%E6%9B%BF%E3%81%88%E3%81%A4%E3%81%84%E3%81%A7%E3%81%AB%E3%82%B5%E3%82%A4%E3%83%88%E6%95%B4%E7%90%86%E3%81%97%E3%81%BE%E3%81%97%E3%81%9F/>OctopressからHugoへの切り替えついでにサイト整理しました</a>
</nav>
</div>
<div class=pure-u-1-24 style=text-align:right>
<a href=https://blog.aquarite.info/2021/09/octopress%E3%81%8B%E3%82%89hugo%E3%81%B8%E3%81%AE%E5%88%87%E3%82%8A%E6%9B%BF%E3%81%88%E3%81%A4%E3%81%84%E3%81%A7%E3%81%AB%E3%82%B5%E3%82%A4%E3%83%88%E6%95%B4%E7%90%86%E3%81%97%E3%81%BE%E3%81%97%E3%81%9F/><i class="fa fa-chevron-right"></i></a>
</div>
</div>
</div>
</div>
</div>
<script src=https://blog.aquarite.info/js/ui.js></script>
<script src=https://blog.aquarite.info/js/menus.js></script>
</body>
</html>