<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=generator content="Hugo 0.153.5"><title>Railsã‚¢ãƒ—ãƒª with Mina and OpenRC &#183; Hello, (forgotten) world â˜‚</title><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/pure-min.css><!--[if lte IE 8]><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-old-ie-min.css><![endif]--><!--[if gt IE 8]><!--><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-min.css><!--<![endif]--><!--[if lte IE 8]><link rel=stylesheet href=https://aquarite.info/css/side-menu-old-ie.css><![endif]--><!--[if gt IE 8]><!--><link rel=stylesheet href=https://aquarite.info/css/side-menu.css><!--<![endif]--><link rel=stylesheet href=https://aquarite.info/css/blackburn.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css2?family=Raleway&display=swap" rel=stylesheet type=text/css><link rel="shortcut icon" href=https://aquarite.info/img/favicon.ico type=image/x-icon><meta property="og:url" content="https://aquarite.info/blog/2014/05/rails-app-with-mina/"><meta property="og:site_name" content="Hello, (forgotten) world â˜‚"><meta property="og:title" content="Railsã‚¢ãƒ—ãƒª with Mina and OpenRC"><meta property="og:description" content='ç›®çš„ã¨ã‹ KONMAIãŒé€ã‚‹å¤§äººæ°—ãƒªã‚ºãƒ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚²ãƒ¼ãƒ "REFLEC BEAT groovinâ€™!!â€œã«å‘ã‘ã¦Refixativeã®æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æ›¸ã„ã¦ã„ãŸã€‚ä»Šã¾ã§ã¯æ¯å›æ¯å›ã‚µãƒ¼ãƒãƒ¼ã«sshã—ã¦ã¯git pullã—ã¦ã†ã‚“ã¬ã‚“ã‹ã‚“ã¬ã‚“ã€ã¨ã‚„ã£ã¦ã„ãŸã®ã§ã€ç¾ä»£çš„ãªç’°å¢ƒã‚’æ§‹ç¯‰ã—ãŸã‹ã£ãŸã€‚'><meta property="og:locale" content="ja_jp"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2014-05-28T00:07:56+09:00"><meta property="article:modified_time" content="2014-05-28T00:07:56+09:00"><meta property="article:tag" content="Rails"><meta property="og:image" content="https://aquarite.info/images/cover.png"></head><body><div id=layout><a href=#menu id=menuLink class=menu-link><span></span></a><div id=menu><a class="pure-menu-heading brand" href=https://aquarite.info/>aquarite.info</a><div class=pure-menu><ul class=pure-menu-list><li class=pure-menu-item><a class=pure-menu-link href=https://aquarite.info/><i class='fa fa-home fa-fw'></i>Home</a></li><li class=pure-menu-item><a class=pure-menu-link href=https://aquarite.info/about/><i class='fa fa-user fa-fw'></i>About</a></li></ul></div><div class="pure-menu social"><ul class=pure-menu-list></ul></div><div><div class=small-print><small>&copy; 2021 Mei Akizuru. All rights reserved.</small></div><div class=small-print><small>Built with&nbsp;<a href=https://gohugo.io/ target=_blank>Hugo</a></small>
<small>Theme&nbsp;<a href=https://github.com/yoshiharuyamashita/blackburn target=_blank>Blackburn</a></small></div></div></div><div id=main><div class=header><h1>Railsã‚¢ãƒ—ãƒª with Mina and OpenRC</h1><h2></h2></div><div class=content><h1 id=ç›®çš„ã¨ã‹>ç›®çš„ã¨ã‹</h1><p>KONMAIãŒé€ã‚‹å¤§äººæ°—ãƒªã‚ºãƒ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚²ãƒ¼ãƒ "REFLEC BEAT groovin&rsquo;!!&ldquo;ã«å‘ã‘ã¦Refixativeã®æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æ›¸ã„ã¦ã„ãŸã€‚ä»Šã¾ã§ã¯æ¯å›æ¯å›ã‚µãƒ¼ãƒãƒ¼ã«sshã—ã¦ã¯git pullã—ã¦ã†ã‚“ã¬ã‚“ã‹ã‚“ã¬ã‚“ã€ã¨ã‚„ã£ã¦ã„ãŸã®ã§ã€ç¾ä»£çš„ãªç’°å¢ƒã‚’æ§‹ç¯‰ã—ãŸã‹ã£ãŸã€‚</p><p>ã¤ã„ã§ã«ã€ã‚µãƒ¼ãƒãƒ¼ã‚’å†èµ·å‹•ã™ã‚‹åº¦ã«unicornã®ãƒ—ãƒ­ã‚»ã‚¹å‘¨ã‚ŠãŒãªãœã ã‹ã‚„ã‚„ã“ã—ã„ã“ã¨ã«ãªã£ã¦ã„ãŸã®ã§ã€ã©ã†ã›ãã‚‚ãã‚‚ãƒ‡ãƒ¼ãƒ¢ãƒ³ãªã‚“ã ã‹ã‚‰initã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’æ›¸ã‘ã°ã„ã„ã‚“ã˜ã‚ƒã­ã€ã¨ã„ã†ã“ã¨ã§ãã£ã¡ã‚‚ã¤ã„ã§ã«å¯¾å¿œã—ãŸã€‚</p><p>OpenRCã®å®Ÿè£…ã‚’èª­ã¿å§‹ã‚ãŸè¾ºã‚Šã‹ã‚‰å¤‰ãªæ²¼ã«ãƒãƒã£ã¦ã€ãã“ã‹ã‚‰3æ—¥ãã‚‰ã„ã‹ã‹ã£ãŸã€‚</p><h1 id=ç’°å¢ƒãã®ä»–>ç’°å¢ƒãã®ä»–</h1><p>é–‹ç™ºç’°å¢ƒã¯Mac OS X Mavericksã€‚Homebrewã§ã„ã‚ã‚“ãªã‚‚ã®ã‚’çªã£è¾¼ã‚“ã§ã‚ã‚‹çŠ¶æ…‹ã€‚</p><p>ã‚µãƒ¼ãƒãƒ¼ã¯ã•ãã‚‰ã®VPS(2G)ã§OSã¨ã—ã¦Gentoo LinuxãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã€‚</p><p>Rubyã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯2.1.2ã€Railsã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯4.1.1ã€‚</p><p>DBã«PostgreSQL 9.3ã‚’ä½¿ç”¨ã€‚ç¾æ™‚ç‚¹ã§ã¯ã¾ã ç”¨æ„ã—ã¦ã„ãªã„ãŒã€memcachedã‚‚ä½¿ç”¨ã™ã‚‹äºˆå®šã€‚</p><h1 id=rails>Rails</h1><p><code>rails new</code>ã—ã¦é©å½“ã«Gemfileã‚’å¼„ã£ã¦<code>bundle install --path vendor/bundle</code>ã€‚</p><h2 id=rbenv-on-gentoo>rbenv on Gentoo</h2><p>ã¾ãšç¬¬ä¸€é–¢é–€ãŒRubyã ã£ãŸã€‚Gentooä¸Šã§rbenvã‚„RVMã‚’ä½¿ã£ã¦Rubyã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã¨ã€<code>auto_gem</code>ãªã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒãªã„ã¨è¨€ã‚ã‚Œã¦RubyãŒå‹•ã‹ãªã„ã¨ã„ã†å•é¡Œã«é­é‡ã—ãŸã€‚ã‚°ã‚°ã£ã¦ã¿ã‚‹ã¨åŒã˜å•é¡Œã«é­é‡ã—ã¦ã„ã‚‹äººãŒå¤šæ•°ã„ãŸã€‚<code>RUBYOPT</code>ã‚’ç©ºã«ã—ã¦<code>rubygems</code>ã‚’emergeã—ãªãŠã›ã°ã„ã„ã‚ˆã€ã¨ã‹ã¾ãã„ã‚ã„ã‚è¦‹ã¤ã‹ã£ãŸã®ã ã‘ã©ã€ãã‚‚ãã‚‚<code>auto_gem</code>ã¨ã„ã†ã®ãŒæ°—ã«ãªã‚Šã€Twitterã§ã„ã‚ã„ã‚å«ã³ãªãŒã‚‰èª¿ã¹ã¦ã„ãŸã¨ã“ã‚ã€Gentooã®ã“ã‚ã„ã²ã¨ã«æ•™ãˆã¦ã‚‚ã‚‰ã†ã“ã¨ãŒã§ããŸã€‚</p><blockquote class=twitter-tweet><p lang=ja dir=ltr><a href="https://twitter.com/maytheplic?ref_src=twsrc%5Etfw">@maytheplic</a> ã„ã¾gentoo ruby teamã¨IRCã—ãŸã‚‰ruby18ã¯ã‚‚ã†ãŠã¨ã¤ã¤ã‚ã‚‹ã—ã‘ã—ã¦ã„ã„ã­ã€ã£ã¦è©±ã«ãªã£ãŸã—3æ—¥ãã‚‰ã„ã—ãŸã‚‰ãã®ã‚ãŸã‚Šã‚‚ããˆã¡ã‚ƒã†ã‚“ã˜ã‚ƒãªã„ã‹ãª</p>&mdash; æ¼¢å­—å¤‰æ›ã®æ¨©ã‚’ä»–äººã«æ¡ã‚‰ã›ãªã„ğŸ™… (@naota344) <a href="https://twitter.com/naota344/status/469523144915427330?ref_src=twsrc%5Etfw">May 22, 2014</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script><p>ï¼ˆã¡ãªã¿ã«ãã®å¾ŒGentooã®ã“ã‚ã„ã²ã¨ãŒæ¬¡ã®ã‚ˆã†ã«ä»°ã£ã¦ã„ãŸã®ã§ã€ãã£ã¨ã“ã®å•é¡Œã¯èµ·ã“ã‚‰ãªããªã‚‹ã ã‚ã†ï¼‰</p><blockquote class=twitter-tweet><p lang=ja dir=ltr><a href="https://twitter.com/maytheplic?ref_src=twsrc%5Etfw">@maytheplic</a> ã„ã¾gentoo ruby teamã¨IRCã—ãŸã‚‰ruby18ã¯ã‚‚ã†ãŠã¨ã¤ã¤ã‚ã‚‹ã—ã‘ã—ã¦ã„ã„ã­ã€ã£ã¦è©±ã«ãªã£ãŸã—3æ—¥ãã‚‰ã„ã—ãŸã‚‰ãã®ã‚ãŸã‚Šã‚‚ããˆã¡ã‚ƒã†ã‚“ã˜ã‚ƒãªã„ã‹ãª</p>&mdash; æ¼¢å­—å¤‰æ›ã®æ¨©ã‚’ä»–äººã«æ¡ã‚‰ã›ãªã„ğŸ™… (@naota344) <a href="https://twitter.com/naota344/status/469523144915427330?ref_src=twsrc%5Etfw">May 22, 2014</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script><p>ã•ã¦ã€ãã‚Œã¯ã¨ã‚‚ã‹ãã¨ã—ã¦ã€å°‘ãªãã¨ã‚‚ã“ã‚Œã‚’ã‚„ã£ã¦ãŸæ™‚ç‚¹ã§ã¯ç›´ã£ã¦ãªã‹ã£ãŸã®ã§å¯¾ç­–ã‚’ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚</p><p>ãã‚‚ãã‚‚<code>auto_gem.rb</code>ã¨ã‚„ã‚‰ãŒä½•ã‚’ã—ã¦ã„ã‚‹ã®ã‹ã¨ã„ã†ã¨ã€</p><ul><li><code>require 'rubygems'</code>ã™ã‚‹</li><li>ãã®ã¨ãã«<code>LoadError</code>ãŒèµ·ããŸã‚‰æ¡ã‚Šæ½°ã™</li></ul><p>ä»¥ä¸Šã§ã‚ã‚‹ã€‚Gentooã®ã“ã‚ã„ã²ã¨ã®è¨€ã†é€šã‚Šã€è¦‹äº‹ã«ç¾ä»£ã«ã¯ä¸è¦ãªãƒ–ãƒ„ã§ã‚ã‚‹ã€‚ä¸è¦ãªã®ã ã‹ã‚‰ã€ç¾ä»£çš„ãªRubyç’°å¢ƒã§ã¯ã€Œä½•ã‚‚ã—ãªãã¦ã‚‚ã‚ˆã„ã€ã¨ã„ã†ã“ã¨ãŒã§ãã‚‹ã€‚ã¨ã„ã†ã‚ã‘ã§ã€é©å½“ã«<code>site_ruby</code>è¾ºã‚Šã«ç©ºã®<code>auto_gem.rb</code>ã‚’çªã£è¾¼ã‚“ã§ã—ã¾ãˆã°ã‚ˆã„ã€‚ä¾‹ãˆã°Ruby 2.1.2ã§ã‚ã‚Œã°ã€</p><pre tabindex=0><code>touch $HOME/.rbenv/versions/2.1.2/lib/ruby/site_ruby/2.1.0/auto_gem.rb
</code></pre><p>ã¨ã‹ã‚„ã‚‹ã¨å‹•ãã‚ˆã†ã«ãªã‚‹ã€‚</p><p>ã¡ãªã¿ã«ruby-buildã‚’ä½¿ã£ã¦ã„ã‚‹å ´åˆã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¾Œã«ãã‚Œã‚’è‡ªå‹•ã§ã‚„ã£ã¦ãã‚Œã‚‹pluginãŒã‚ã‚‹ã€‚ -> <a href=https://github.com/Cofyc/rbenv-auto_gem>Cofyc/rbenv-auto_gem</a></p><p>ã“ã‚Œã‚’<code>$HOME/.rbenv/plugins</code>ã®ä¸‹ã«cloneã—ã¦<code>rbenv install ...</code>ã¨ã‹ã‚„ã‚‹ã¨é©åˆ‡ãªå ´æ‰€ã«ç©ºã®<code>auto_gem.rb</code>ã‚’ä½œã£ã¦ãã‚Œã‚‹ã€‚</p><p>ã“ã‚Œã§RubyãŒå‹•ãã‚ˆã†ã«ãªã£ãŸã€‚</p><h2 id=therubyracer>therubyracer</h2><p><code>rake assets:precompile</code>ã‚’ã—ãŸã¨ãã€ãƒ­ãƒ¼ã‚«ãƒ«ã§ã¯ä¸Šæ‰‹ãã„ãã®ã«ã€ã‚µãƒ¼ãƒãƒ¼å´ã§ã¯Segmentation Faultã§RubyãŒè½ã¡ã‚‹ã¨ã„ã†äº‹æ…‹ã«é­é‡ã—ãŸã€‚åã‹ã‚ŒãŸã‚¨ãƒ©ãƒ¼ã‚’è¦‹ã‚‹ã¨therubyracerãŒã©ã†ã®ã€ã¨ã„ã£ãŸã¨ã“ã‚ã§è½ã¡ã¦ã„ãŸã€‚ã‚µãƒ¼ãƒãƒ¼å´ã«ã¯node.jsãŒå…¥ã£ã¦ã„ã‚‹ã—ã€ç‰¹ã«å•é¡Œãªã„ã ã‚ã†ã¨åˆ¤æ–­ã—ã¦Gemfileã‹ã‚‰therubyracerã‚’æ¶ˆã—ãŸã¨ã“ã‚ä¸Šæ‰‹ãå‹•ä½œã—ãŸã€‚ãªã‚“ã ã£ãŸã‚“ã ã‚ã†ã€‚</p><h1 id=mina>Mina</h1><p><a href=http://nadarei.co/mina/>Mina</a>ã¯ãƒ‡ãƒ—ãƒ­ã‚¤è‡ªå‹•åŒ–ãƒ„ãƒ¼ãƒ«ã§ã€åŒã˜ã‚ˆã†ãªãƒ„ãƒ¼ãƒ«ã§æœ€ã‚‚æœ‰åãªã®ã¯æã‚‰ã<a href=http://capistranorb.com>Capistrano</a>ã ã‚ã†ã€‚</p><p>ä»Šã¾ã§Refixativeã®ãƒ‡ãƒ—ãƒ­ã‚¤ã¨ã„ã†ã®ã¯Herokuã®ã‚ˆã†ã«<code>git push</code>ã—ãŸã‚‰è¡Œã‚ã‚Œã‚‹ã¨ã‹ãªã‚“ã‹ã®botã«ã‚³ãƒãƒ³ãƒ‰æŠ•ã’ã‚‹ã¨è¡Œã‚ã‚Œã‚‹ã¨ã‹ã§ã¯å…¨ããªãã€é–‹ç™ºè€…è‡ªèº«ï¼ˆã¤ã¾ã‚Šç§ï¼‰ãŒãƒ‡ãƒ—ãƒ­ã‚¤å…ˆã‚µãƒ¼ãƒãƒ¼ã«sshã—ã¦ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒç½®ã„ã¦ã‚ã‚‹ãƒ•ã‚©ãƒ«ãƒ€ã«ç§»å‹•ã—ã¦ã€git pullã—ã¦ã€unicornã‚’reloadã—ã¦â€¦â€¦ã¨ã‚„ã£ã¦ã„ãŸã€‚æ­£ç›´ã‚¢ãƒ›ã‚‰ã—ã„ã€‚</p><p>ãã†ã„ã†ã‚ã‘ã§ãã®è¾ºè‡ªå‹•åŒ–ã™ã‚‹ãŸã‚ã«Capistranoã§ã‚‚è§¦ã‚‹ã‹â€¦â€¦ã¨æ€ã£ã¦ã„ãŸã¨ã“ã‚ã§æŸç­‘æ³¢ã®ã¦ãŠãã‚Œã‹ã‚‰ã“ã‚“ãªreplyãŒæ¥ãŸã€‚</p><blockquote class=twitter-tweet><p lang=ja dir=ltr><a href=https://twitter.com/maytheplic>@maytheplic</a> minaãŒãƒŠã‚¦ã„ã‚‰ã—ã„ <a href=http://t.co/MDwGLIx7Y0>http://t.co/MDwGLIx7Y0</a></p>&mdash; ã¾ã¦ãƒãƒ¼ (@rkmathi) <a href=https://twitter.com/rkmathi/status/459561993729347587>2014, 4æœˆ 25</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script><p>ãƒŠã‚¦ã„ã‚‰ã—ã„ã€‚ãªã‚‰ã°ä½¿ã†ã—ã‹ã‚ã‚‹ã¾ã„ã€‚ã¨ã„ã†ã‚ã‘ã§Minaæ¡ç”¨ã¨ãªã£ãŸã€‚</p><h2 id=ãã®å‰ã«>ãã®å‰ã«</h2><p>ã‚µãƒ¼ãƒãƒ¼å´ã§Railsã‚¢ãƒ—ãƒªã‚’å‹•ã‹ã™ãƒ¦ãƒ¼ã‚¶ãƒ¼ç­‰ã€…ã‚’æº–å‚™ã—ã¦ãŠãã€‚</p><p>ã¾ãšãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆä»Šå›ã¯<code>refxgroovin</code>ï¼‰ã‚’äºˆã‚ä½œæˆã—ã¦ãŠãã€‚ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆã¯ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ›ãƒ¼ãƒ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä»¥ä¸‹ã¨ã—ã€ä»Šå›ã¯<code>/home/refxgroovin/refixative</code>ã¨ã—ã¦ã„ã‚‹ã€‚ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã‚‚åŒã˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§å‹•ã‹ã—ã€ãã¡ã‚‰ã®ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆã¯<code>refixative-staging</code>ã¨ã—ãŸã€‚</p><p>é–‹ç™ºç’°å¢ƒã‹ã‚‰ã‚µãƒ¼ãƒãƒ¼ã«å¯¾ã—ã¦refxgroovinã¨ã—ã¦sshã§ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹ã‚ˆã†ã«è¨­å®šã™ã‚‹ã€‚é–‹ç™ºç’°å¢ƒã§å…¬é–‹éµãƒ»ç§˜å¯†éµã®ãƒšã‚¢ã‚’ä½œæˆã—ã€ã‚µãƒ¼ãƒãƒ¼å´ã®<code>/home/refxgroovin/.ssh/authorized_keys</code>ã«å…¬é–‹éµã‚’è¿½è¨˜ã™ã‚‹ã€‚</p><p>ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—ã™ã‚‹å…ƒã«ãªã‚‹ãƒªãƒã‚¸ãƒˆãƒªã ãŒã€ä»Šå›githubä¸Šã«ã‚ã‚‹publicãªãƒªãƒã‚¸ãƒˆãƒªãªã®ã§å®Ÿéš›ã©ã£ã¡ã§ã‚‚ã‚ˆã•ãã†ã ã—ã€SSH Agentã‚’ä½¿ã†ã“ã¨ã‚‚ã§ãã‚‹ãŒã€ä»Šå›ã¯ã•ã‚‰ã«ã‚µãƒ¼ãƒãƒ¼ä¸Šã®refxgroovinãƒ¦ãƒ¼ã‚¶ãƒ¼ã§SSHã®éµã‚’ç”Ÿæˆã—ã¦ãƒªãƒã‚¸ãƒˆãƒªã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«è¨­å®šã™ã‚‹ã€‚</p><h2 id=minaã®æº–å‚™>Minaã®æº–å‚™</h2><p>ã¾ãšã¯Gemfileã«<code>gem 'mina'</code>ã®ä¸€è¡Œã‚’è¿½åŠ ã—ã¦<code>bundle</code>ã—ãŸå¾Œã€</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ bundle <span style=color:#8be9fd;font-style:italic>exec</span> mina init
</span></span></code></pre></div><p>ã¨ã™ã‚‹ã¨ã€<code>config/deploy.rb</code>ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ãŒå‡ºæ¥ã‚‹ã®ã§ã“ã‚Œã‚’ç·¨é›†ã™ã‚‹ã€‚ä»¥ä¸‹ã«ç¤ºã™<code>deploy.rb</code>ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’å…ƒã«ã„ã‚ã„ã‚è©¦è¡ŒéŒ¯èª¤ã—ãŸçµæœã§ã‚ã‚‹ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>require</span> <span style=color:#f1fa8c>&#39;mina/bundler&#39;</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>require</span> <span style=color:#f1fa8c>&#39;mina/rails&#39;</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>require</span> <span style=color:#f1fa8c>&#39;mina/git&#39;</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>require</span> <span style=color:#f1fa8c>&#39;mina/rbenv&#39;</span>  <span style=color:#6272a4># for rbenv support. (http://rbenv.org)</span>
</span></span><span style=display:flex><span><span style=color:#6272a4># require &#39;mina/rvm&#39;    # for rvm support. (http://rvm.io)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># Optional settings:</span>
</span></span><span style=display:flex><span><span style=color:#6272a4>#   set :user, &#39;foobar&#39;    # Username in the server to SSH to.</span>
</span></span><span style=display:flex><span><span style=color:#6272a4>#   set :port, &#39;30000&#39;     # SSH port number.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>set <span style=color:#f1fa8c>:user</span>, <span style=color:#f1fa8c>&#39;refxgroovin&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># Basic settings:</span>
</span></span><span style=display:flex><span><span style=color:#6272a4>#   domain       - The hostname to SSH to.</span>
</span></span><span style=display:flex><span><span style=color:#6272a4>#   deploy_to    - Path to deploy into.</span>
</span></span><span style=display:flex><span><span style=color:#6272a4>#   repository   - Git repo to clone from. (needed by mina/git)</span>
</span></span><span style=display:flex><span><span style=color:#6272a4>#   branch       - Branch name to deploy. (needed by mina/git)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>set <span style=color:#f1fa8c>:domain</span>, <span style=color:#f1fa8c>&#39;refxgroovin&#39;</span>
</span></span><span style=display:flex><span>set <span style=color:#f1fa8c>:repository</span>, <span style=color:#f1fa8c>&#39;git@github.com:mayth/refixative.git&#39;</span>
</span></span><span style=display:flex><span>set <span style=color:#f1fa8c>:branch</span>, <span style=color:#f1fa8c>&#39;next&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># Manually create these paths in shared/ (eg: shared/config/database.yml) in your server.</span>
</span></span><span style=display:flex><span><span style=color:#6272a4># They will be linked in the &#39;deploy:link_shared_paths&#39; step.</span>
</span></span><span style=display:flex><span>set <span style=color:#f1fa8c>:shared_paths</span>, <span style=color:#ff79c6>[</span>
</span></span><span style=display:flex><span>  <span style=color:#f1fa8c>&#39;config/database.yml&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f1fa8c>&#39;config/unicorn.rb&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f1fa8c>&#39;config/application.yml&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f1fa8c>&#39;log&#39;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># This task is the environment that is loaded for most commands, such as</span>
</span></span><span style=display:flex><span><span style=color:#6272a4># `mina deploy` or `mina rake`.</span>
</span></span><span style=display:flex><span>task <span style=color:#f1fa8c>:environment</span> <span style=color:#ff79c6>do</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>case</span> ENV<span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#39;to&#39;</span><span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>when</span> <span style=color:#f1fa8c>&#39;staging&#39;</span>
</span></span><span style=display:flex><span>    set <span style=color:#f1fa8c>:deploy_to</span>, <span style=color:#f1fa8c>&#34;/home/</span><span style=color:#f1fa8c>#{</span>user<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>/refixative-staging&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>when</span> <span style=color:#f1fa8c>&#39;production&#39;</span>
</span></span><span style=display:flex><span>    set <span style=color:#f1fa8c>:deploy_to</span>, <span style=color:#f1fa8c>&#34;/home/</span><span style=color:#f1fa8c>#{</span>user<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>/refixative&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>when</span> <span style=color:#ff79c6>nil</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>fail</span> <span style=color:#f1fa8c>&#39;specify `to`, deployment target&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>else</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>fail</span> <span style=color:#f1fa8c>&#39;unknown deployment target&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4># If you&#39;re using rbenv, use this to load the rbenv environment.</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4># Be sure to commit your .rbenv-version to your repository.</span>
</span></span><span style=display:flex><span>  invoke <span style=color:#f1fa8c>:&#39;rbenv:load&#39;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># Put any custom mkdir&#39;s in here for when `mina setup` is ran.</span>
</span></span><span style=display:flex><span><span style=color:#6272a4># For Rails apps, we&#39;ll make some of the shared paths that are shared between</span>
</span></span><span style=display:flex><span><span style=color:#6272a4># all releases.</span>
</span></span><span style=display:flex><span>task <span style=color:#f1fa8c>:setup</span> <span style=color:#ff79c6>=&gt;</span> <span style=color:#f1fa8c>:environment</span> <span style=color:#ff79c6>do</span>
</span></span><span style=display:flex><span>  queue! <span style=color:#f1fa8c>%[mkdir -p &#34;</span><span style=color:#f1fa8c>#{</span>deploy_to<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>/shared/log&#34;]</span>
</span></span><span style=display:flex><span>  queue! <span style=color:#f1fa8c>%[chmod g+rx,u+rwx &#34;</span><span style=color:#f1fa8c>#{</span>deploy_to<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>/shared/log&#34;]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  queue! <span style=color:#f1fa8c>%[mkdir -p &#34;</span><span style=color:#f1fa8c>#{</span>deploy_to<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>/shared/config&#34;]</span>
</span></span><span style=display:flex><span>  queue! <span style=color:#f1fa8c>%[chmod g+rx,u+rwx &#34;</span><span style=color:#f1fa8c>#{</span>deploy_to<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>/shared/config&#34;]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  queue! <span style=color:#f1fa8c>%[mkdir -p &#34;</span><span style=color:#f1fa8c>#{</span>deploy_to<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>/shared/pids&#34;]</span>
</span></span><span style=display:flex><span>  queue! <span style=color:#f1fa8c>%[chmod g+rx,u+rwx &#34;</span><span style=color:#f1fa8c>#{</span>deploy_to<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>/shared/pids&#34;]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  shared_configs <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>%w(database.yml unicorn.rb application.yml)</span>
</span></span><span style=display:flex><span>  shared_configs<span style=color:#ff79c6>.</span>each <span style=color:#ff79c6>do</span> <span style=color:#ff79c6>|</span>conf<span style=color:#ff79c6>|</span>
</span></span><span style=display:flex><span>    queue! <span style=color:#f1fa8c>%[touch &#34;</span><span style=color:#f1fa8c>#{</span>deploy_to<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>/shared/config/</span><span style=color:#f1fa8c>#{</span>conf<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;]</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span>  queue  <span style=color:#f1fa8c>%[echo &#34;-----&gt; Be sure to edit the following files in &#39;shared/config&#39;:&#34;]</span>
</span></span><span style=display:flex><span>  shared_configs<span style=color:#ff79c6>.</span>each <span style=color:#ff79c6>do</span> <span style=color:#ff79c6>|</span>conf<span style=color:#ff79c6>|</span>
</span></span><span style=display:flex><span>    queue  <span style=color:#f1fa8c>%[echo &#34;-----&gt;   * </span><span style=color:#f1fa8c>#{</span>conf<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;]</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>desc <span style=color:#f1fa8c>&#34;Deploys the current version to the server.&#34;</span>
</span></span><span style=display:flex><span>task <span style=color:#f1fa8c>:deploy</span> <span style=color:#ff79c6>=&gt;</span> <span style=color:#f1fa8c>:environment</span> <span style=color:#ff79c6>do</span>
</span></span><span style=display:flex><span>  deploy <span style=color:#ff79c6>do</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4># Put things that will set up an empty directory into a fully set-up</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4># instance of your project.</span>
</span></span><span style=display:flex><span>    invoke <span style=color:#f1fa8c>:&#39;git:clone&#39;</span>
</span></span><span style=display:flex><span>    invoke <span style=color:#f1fa8c>:&#39;deploy:link_shared_paths&#39;</span>
</span></span><span style=display:flex><span>    invoke <span style=color:#f1fa8c>:&#39;bundle:install&#39;</span>
</span></span><span style=display:flex><span>    invoke <span style=color:#f1fa8c>:&#39;rails:db_migrate&#39;</span>
</span></span><span style=display:flex><span>    invoke <span style=color:#f1fa8c>:&#39;rails:assets_precompile&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    to <span style=color:#f1fa8c>:launch</span> <span style=color:#ff79c6>do</span>
</span></span><span style=display:flex><span>      env <span style=color:#ff79c6>=</span> ENV<span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#39;to&#39;</span><span style=color:#ff79c6>]</span> <span style=color:#ff79c6>==</span> <span style=color:#f1fa8c>&#39;production&#39;</span> ? <span style=color:#f1fa8c>&#39;&#39;</span> : <span style=color:#f1fa8c>&#34;.</span><span style=color:#f1fa8c>#{</span>ENV<span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#39;to&#39;</span><span style=color:#ff79c6>]</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>      cmd <span style=color:#ff79c6>=</span> ENV<span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#39;reload&#39;</span><span style=color:#ff79c6>]</span> <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39;reload&#39;</span>
</span></span><span style=display:flex><span>      queue <span style=color:#f1fa8c>%[sudo /etc/init.d/refxgroovin</span><span style=color:#f1fa8c>#{</span>env<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c> </span><span style=color:#f1fa8c>#{</span>cmd<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>]</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># For help in making your deploy script, see the Mina documentation:</span>
</span></span><span style=display:flex><span><span style=color:#6272a4>#</span>
</span></span><span style=display:flex><span><span style=color:#6272a4>#  - http://nadarei.co/mina</span>
</span></span><span style=display:flex><span><span style=color:#6272a4>#  - http://nadarei.co/mina/tasks</span>
</span></span><span style=display:flex><span><span style=color:#6272a4>#  - http://nadarei.co/mina/settings</span>
</span></span><span style=display:flex><span><span style=color:#6272a4>#  - http://nadarei.co/mina/helpers</span>
</span></span></code></pre></div><h3 id=shared_paths>shared_paths</h3><p><code>shared_paths</code>ã«æŒ‡å®šã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãƒ»ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯ã€ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã¨ãã«&rdquo;#{deploy_to}/shared"ã«ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ãŒå¼µã‚‰ã‚Œã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚ä¾‹ãˆã°<code>config/database.yml</code>ã‚’æŒ‡å®šã™ã‚‹ã¨ã€ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã¨ãã«<code>/home/refxgroovin/current/config/database.yml</code>ã‹ã‚‰<code>/home/refxgroovin/shared/config/database.yml</code>ã«ãƒªãƒ³ã‚¯ãŒå¼µã‚‰ã‚Œã‚‹ã€‚ã“ã‚Œã«ã‚ˆã£ã¦ã‚µãƒ¼ãƒãƒ¼ã«ä¾å­˜ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã„ã¡ã„ã¡æ›¸ãæ›ãˆã‚‹å¿…è¦ãŒãªããªã‚‹ï¼ˆã‚“ã ã‚ã†ã€ãŸã¶ã‚“ï¼‰ã€‚</p><p>ï¼ˆâ€»Minaã¯ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸæœ€æ–°ç‰ˆã‚’"#{deploy_to}/current"ã¨ã™ã‚‹ã€‚ã“ã‚Œã‚‚ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã§ã€å®Ÿä½“ã¯<code>releases</code>ãƒ•ã‚©ãƒ«ãƒ€ä»¥ä¸‹ã«ã‚ã‚‹ï¼‰</p><p>ä¾‹ãˆã°Rails 4.1ã®<code>config/secrets.yml</code>ã€‚ã“ã‚Œã¯<code>rails new</code>ã—ãŸã¨ãã«ç”Ÿæˆã•ã‚Œã‚‹<code>.gitignore</code>ã«å«ã¾ã‚Œã¦ã„ã¦ãƒªãƒã‚¸ãƒˆãƒªã«ã¯ãªã„ã¯ãšã§ã‚ã‚‹ã€‚ã“ã“ã§ã€<code>shared_paths</code>ã«<code>config/secrets.yml</code>ã‚’è¨­å®šã—ã¦å®Ÿä½“ã‚’<code>shared/config/secrets.yml</code>ã«ç½®ã„ã¦ãŠã‘ã°ã€ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ãŒä½œæˆã•ã‚Œã‚‹ã®ã§æ—ã‚‹ã€ã¨æ€ã†ã€‚ï¼ˆã¡ãªã¿ã«Refixativeã®å ´åˆã¯<a href=https://github.com/laserlemon/figaro>Figaro</a>ã§ç®¡ç†ã—ã¦ã„ã‚‹ã®ã§<code>config/secrets.yml</code>ã¯ãƒªãƒã‚¸ãƒˆãƒªã«å­˜åœ¨ã—ã¦ã„ã‚‹ã€‚ãã®å†…å®¹ã¯å˜ã«ç’°å¢ƒå¤‰æ•°ã‚’è¦‹ã‚‹ã ã‘ã®ã‚‚ã®ã§ã‚ã‚‹ã€‚ã“ã®å ´åˆã¯ä»£ã‚ã‚Šã«<code>config/application.yml</code>ãŒå­˜åœ¨ã—ãªã„ã®ã§ã€ã“ã‚Œã‚’<code>shared_paths</code>ã«è¨­å®šã—ã¦ã‚ã‚‹ï¼‰</p><p>æ³¨æ„ç‚¹ã¨ã—ã¦ã¯ã€ã‚ãã¾ã§è‡ªå‹•ã§ãƒªãƒ³ã‚¯ã‚’å¼µã‚‹ã ã‘ã§ã‚ã£ã¦å®Ÿä½“ã«é–¢ã—ã¦ã¯ä½•ã‚‚é–¢çŸ¥ã—ãªã„ã®ã§ã€ãã‚Œã¯è‡ªåˆ†ã§ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚</p><h3 id=ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—>ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</h3><p>ãã®è¾ºã‚Šã®è¨­å®šãŒã§ããŸã‚‰é–‹ç™ºç’°å¢ƒã§ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ç™ºè¡Œã™ã‚‹ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ bundle <span style=color:#8be9fd;font-style:italic>exec</span> mina setup <span style=color:#8be9fd;font-style:italic>to</span><span style=color:#ff79c6>=</span>production
</span></span></code></pre></div><p><code>to=production</code>ã«é–¢ã—ã¦ã¯ã€ä»Šå›ã¯production/stagingã‚’åˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã—ãŸã®ã§å¿…é ˆã§ã‚ã‚‹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã¾ã¾ãªã‚‰å¿…è¦ãªã„ï¼‰ã€‚ã“ã‚Œã§ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆã«ã¯Minaã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ãŒç”Ÿæˆã•ã‚Œã€sharedãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä»¥ä¸‹ã«ã„ãã¤ã‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒç”Ÿæˆã•ã‚Œã‚‹ã€‚</p><p>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã‚ã‚‹ã¨ãŠã‚Šã€<code>shared</code>ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯è‡ªåˆ†ã§ç·¨é›†ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ã®ã§ã€ã‚µãƒ¼ãƒãƒ¼å´ã§ç·¨é›†ã™ã‚‹ã€‚</p><h3 id=ãƒ‡ãƒ—ãƒ­ã‚¤>ãƒ‡ãƒ—ãƒ­ã‚¤</h3><p>ã“ã“ã¾ã§çµ‚ã‚ã‚Œã°ã€é–‹ç™ºç’°å¢ƒã«æˆ»ã£ã¦ãã¦</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ bundle <span style=color:#8be9fd;font-style:italic>exec</span> mina deploy <span style=color:#8be9fd;font-style:italic>to</span><span style=color:#ff79c6>=</span>production
</span></span></code></pre></div><p>ã¨ã™ã‚‹ã€‚ã“ã®ã‚³ãƒãƒ³ãƒ‰ã«ã‚ˆã£ã¦sshã—ã¦git cloneã—ã¦äº‘ã€…â€¦â€¦ãŒå®Ÿè¡Œã•ã‚Œã€æœ€å¾Œã«<code>to :launch</code>ã§æ›¸ã„ãŸå†…å®¹ãŒå®Ÿè¡Œã•ã‚Œã€ãƒ‡ãƒ—ãƒ­ã‚¤ã¯çµ‚äº†ã™ã‚‹ã€‚ä¸Šè¿°ã®ä¾‹ã ã¨ã“ã“ã§ç‹¬è‡ªã®initã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç”¨ã„ã¦ã„ã‚‹ã®ã§ãã‚Œã‚’ç”¨æ„ã—ã¦ãŠãå¿…è¦ãŒã‚ã‚‹ãŒã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã ã¨<code>restart.txt</code>ã‚’touchã—ã¦çµ‚ã‚ã‚Šãªã®ã§ã€ç‰¹ã«ä½•ã‚‚èµ·ããšã«çµ‚äº†ã™ã‚‹ã¯ãšã§ã‚ã‚‹ã€‚</p><h1 id=ã‚µãƒ¼ãƒãƒ¼å´ç’°å¢ƒæ§‹ç¯‰>ã‚µãƒ¼ãƒãƒ¼å´ç’°å¢ƒæ§‹ç¯‰</h1><p>rbenvã¨ã‹rubyã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¯çœç•¥ã€‚ãã“ã§ãƒãƒã£ãŸã®ã¯å‰è¿°ã®ç‚¹ãã‚‰ã„ã§ã‚ã‚‹ã€‚</p><h2 id=initã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’æ›¸ã“ã†>initã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’æ›¸ã“ã†</h2><p>Gentoo Linuxã§ã¯æ¨™æº–ã§OpenRCã¨ã„ã†initã‚·ã‚¹ãƒ†ãƒ ã‚’æ¡ç”¨ã—ã¦ã„ã‚‹ã€‚ãã‚Œã‚’è¸ã¾ãˆãŸä¸Šã§ã€unicornã®ãƒ‡ãƒ¼ãƒ¢ãƒ³ã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã®initã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’æ›¸ãã€‚æ›¸ãæ–¹ã¯<a href="http://www.gentoo.org/doc/en/handbook/handbook-x86.xml?part=2&amp;chap=4">Gentoo Linux Documentation &ndash; Initscripts</a>è¾ºã‚Šã‚’è¦‹ãŸã‚Šã€ä»–ã®initã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å‚è€ƒã«ã™ã‚‹ã€‚ä»Šå›ã¯ç‰¹ã«apache2ã¨postgresql-9.3ã‚’å‚è€ƒã«ã—ã¦æ›¸ã„ã¦ã¿ãŸã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#ff79c6>#!/sbin/runscript
</span></span></span><span style=display:flex><span><span style=color:#6272a4># Distributed under the terms of the MIT License</span>
</span></span><span style=display:flex><span><span style=color:#6272a4># $Header: $</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>extra_started_commands</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;reload&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>description_graceful</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;Reexecutes the running binary and stops the old master after the old workers finish their current request.&#34;</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>description_gracefulstop</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;Stops the server after the workers finish their current request.&#34;</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>description_reload</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;Reexecutes the running binary and stops the old master immediately.&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>CONF</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>RC_SVCNAME</span>#*.<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>CONF</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span> <span style=color:#ff79c6>==</span> <span style=color:#f1fa8c>&#34;refxgroovin&#34;</span> <span style=color:#ff79c6>]</span> <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#8be9fd;font-style:italic>CONF</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#39;production&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>if</span> <span style=color:#ff79c6>[</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>CONF</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span> <span style=color:#ff79c6>==</span> <span style=color:#f1fa8c>&#34;production&#34;</span> <span style=color:#ff79c6>]</span>; <span style=color:#ff79c6>then</span>
</span></span><span style=display:flex><span>	<span style=color:#8be9fd;font-style:italic>REFXGROOVIN_BASE</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;/home/refxgroovin/refixative&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>else</span>
</span></span><span style=display:flex><span>	<span style=color:#8be9fd;font-style:italic>REFXGROOVIN_BASE</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;/home/refxgroovin/refixative-</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>CONF</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>fi</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>PIDFILE</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>REFXGROOVIN_BASE</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>/shared/pids/unicorn.pid&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>RBENV_DIR</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;/home/</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>REFXGROOVIN_USER</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>/.rbenv&#34;</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>PATH</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>RBENV_DIR</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>/bin:</span><span style=color:#8be9fd;font-style:italic>$PATH</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>depend<span style=color:#ff79c6>()</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>	need net postgresql
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>start<span style=color:#ff79c6>()</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>	ebegin <span style=color:#f1fa8c>&#34;Starting Refixative groovin&#39;!! </span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>CONF</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c> server&#34;</span>
</span></span><span style=display:flex><span>	start-stop-daemon --start <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span>		--name unicorn_rails <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span>		--chdir <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>REFXGROOVIN_BASE</span><span style=color:#f1fa8c>}</span>/current <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span>		--user <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>REFXGROOVIN_USER</span><span style=color:#f1fa8c>}</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span>		--pidfile <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>PIDFILE</span><span style=color:#f1fa8c>}</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span>		--exec rbenv -- <span style=color:#8be9fd;font-style:italic>exec</span> bundle <span style=color:#8be9fd;font-style:italic>exec</span> unicorn_rails -c <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>REFXGROOVIN_BASE</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>/current/config/unicorn.rb&#34;</span> -E production -D
</span></span><span style=display:flex><span>	eend <span style=color:#8be9fd;font-style:italic>$?</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>stop<span style=color:#ff79c6>()</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>	<span style=color:#8be9fd;font-style:italic>local</span> <span style=color:#8be9fd;font-style:italic>seconds</span><span style=color:#ff79c6>=</span><span style=color:#ff79c6>$((</span> <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>GRACEFUL_TIMEOUT</span><span style=color:#f1fa8c>}</span> <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>FORCE_TIMEOUT</span><span style=color:#f1fa8c>}</span> <span style=color:#ff79c6>))</span>
</span></span><span style=display:flex><span>	ebegin <span style=color:#f1fa8c>&#34;Stopping Refixative groovin&#39;!! </span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>CONF</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c> server gracefully (this can take up to </span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>seconds</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c> seconds)&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#8be9fd;font-style:italic>local</span> <span style=color:#8be9fd;font-style:italic>retries</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;SIGQUIT/</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>GRACEFUL_TIMEOUT</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> <span style=color:#ff79c6>[</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>FORCE_QUIT</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;YES&#34;</span> <span style=color:#ff79c6>]</span> ; <span style=color:#ff79c6>then</span>
</span></span><span style=display:flex><span>		einfo <span style=color:#f1fa8c>&#34;FORCE_QUIT enabled.&#34;</span>
</span></span><span style=display:flex><span>		<span style=color:#8be9fd;font-style:italic>retries</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>retries</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>/SIGTERM/</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>FORCE_TIMEOUT</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	start-stop-daemon --stop <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span>		--pidfile <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>PIDFILE</span><span style=color:#f1fa8c>}</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span>		--retry <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>retries</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>	eend <span style=color:#8be9fd;font-style:italic>$?</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>restart<span style=color:#ff79c6>()</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>	stop
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#8be9fd;font-style:italic>local</span> <span style=color:#8be9fd;font-style:italic>timeout</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>RESTART_TIMEOUT</span><span style=color:#ff79c6>:-</span><span style=color:#8be9fd;font-style:italic>10</span><span style=color:#f1fa8c>}</span>
</span></span><span style=display:flex><span>	<span style=color:#8be9fd;font-style:italic>local</span> <span style=color:#8be9fd;font-style:italic>i</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>0</span> <span style=color:#8be9fd;font-style:italic>retval</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>0</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>while</span> <span style=color:#ff79c6>[</span> -e <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>PIDFILE</span><span style=color:#f1fa8c>}</span> <span style=color:#ff79c6>]</span> <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>[</span> <span style=color:#8be9fd;font-style:italic>$i</span> -lt <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>timeout</span><span style=color:#f1fa8c>}</span> <span style=color:#ff79c6>]</span> ; <span style=color:#ff79c6>do</span>
</span></span><span style=display:flex><span>		sleep <span style=color:#bd93f9>1</span> <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#8be9fd;font-style:italic>i</span><span style=color:#ff79c6>=</span><span style=color:#ff79c6>$(</span>expr <span style=color:#8be9fd;font-style:italic>$i</span> + 1<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>done</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>[</span> -e <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>PIDFILE</span><span style=color:#f1fa8c>}</span> <span style=color:#ff79c6>]</span> <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#8be9fd;font-style:italic>retval</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span>	eend <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>retval</span><span style=color:#f1fa8c>}</span> <span style=color:#f1fa8c>&#34;Unable to confirm whether the server stopped or not.&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>[</span> <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>retval</span><span style=color:#f1fa8c>}</span> -ne <span style=color:#bd93f9>0</span> <span style=color:#ff79c6>]</span> <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>return</span> <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>retval</span><span style=color:#f1fa8c>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	sleep <span style=color:#bd93f9>2</span> <span style=color:#6272a4># waiting a little for COMPLETELY stopped the old master</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	start
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>reload<span style=color:#ff79c6>()</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>	<span style=color:#8be9fd;font-style:italic>local</span> <span style=color:#8be9fd;font-style:italic>retval</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	ebegin <span style=color:#f1fa8c>&#34;Reloading Refixative groovin&#39;!! </span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>CONF</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c> server&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#8be9fd;font-style:italic>kill</span> -USR2 <span style=color:#f1fa8c>`</span>cat <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>PIDFILE</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>`</span>
</span></span><span style=display:flex><span>	<span style=color:#8be9fd;font-style:italic>retval</span><span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>$?</span>
</span></span><span style=display:flex><span>	eend <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>retval</span><span style=color:#f1fa8c>}</span> <span style=color:#f1fa8c>&#34;Unable to reload the server.&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>[</span> <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>retval</span><span style=color:#f1fa8c>}</span> -ne <span style=color:#bd93f9>0</span> <span style=color:#ff79c6>]</span> <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>return</span> <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>retval</span><span style=color:#f1fa8c>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#8be9fd;font-style:italic>local</span> <span style=color:#8be9fd;font-style:italic>timeout</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>RELOAD_TIMEOUT</span><span style=color:#ff79c6>:-</span><span style=color:#8be9fd;font-style:italic>10</span><span style=color:#f1fa8c>}</span>
</span></span><span style=display:flex><span>	<span style=color:#8be9fd;font-style:italic>local</span> <span style=color:#8be9fd;font-style:italic>oldbin</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>PIDFILE</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>.oldbin&#34;</span>
</span></span><span style=display:flex><span>	ebegin <span style=color:#f1fa8c>&#34;Waiting for restarting (this can take up to </span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>timeout</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c> seconds)&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#8be9fd;font-style:italic>local</span> <span style=color:#8be9fd;font-style:italic>i</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>0</span>
</span></span><span style=display:flex><span>	<span style=color:#8be9fd;font-style:italic>retval</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>0</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>while</span> <span style=color:#ff79c6>[</span> ! -e <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>oldbin</span><span style=color:#f1fa8c>}</span> <span style=color:#ff79c6>]</span> <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>[</span> <span style=color:#8be9fd;font-style:italic>$i</span> -lt <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>timeout</span><span style=color:#f1fa8c>}</span> <span style=color:#ff79c6>]</span> ; <span style=color:#ff79c6>do</span>
</span></span><span style=display:flex><span>		sleep <span style=color:#bd93f9>1</span> <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#8be9fd;font-style:italic>i</span><span style=color:#ff79c6>=</span><span style=color:#ff79c6>$(</span>expr <span style=color:#8be9fd;font-style:italic>$i</span> + 1<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>done</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>[</span> ! -e <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>oldbin</span><span style=color:#f1fa8c>}</span> <span style=color:#ff79c6>]</span> <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#8be9fd;font-style:italic>retval</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span>	eend <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>retval</span><span style=color:#f1fa8c>}</span> <span style=color:#f1fa8c>&#34;Unable to found the old pidfile at </span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>oldbin</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>[</span> <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>retval</span><span style=color:#f1fa8c>}</span> -ne <span style=color:#bd93f9>0</span> <span style=color:#ff79c6>]</span> <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>return</span> <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>retval</span><span style=color:#f1fa8c>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	ebegin <span style=color:#f1fa8c>&#34;Stopping old Refixative groovin&#39;!! </span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>CONF</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c> server&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#8be9fd;font-style:italic>kill</span> -QUIT <span style=color:#f1fa8c>`</span>cat <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>oldbin</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>`</span>
</span></span><span style=display:flex><span>	eend <span style=color:#8be9fd;font-style:italic>$?</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># vim: ts=4 filetype=gentoo-init-d</span>
</span></span></code></pre></div><p><code>reload</code>ã¯USR2+QUITã®çµ„ã¿åˆã‚ã›ã§ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ ãªã—ã§ã®æ›´æ–°ã‚’è¡Œã†ã‚‚ã®ã§ã‚ã‚‹ã€‚ã‚ã¨<code>restart</code>ã¯ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®å•é¡Œã‹ä½•ã‹ã§ã€å‰ã®masterãŒãƒªãƒƒã‚¹ãƒ³ã—ã¦ã„ã‚‹ãƒãƒ¼ãƒˆã‚’æ‰‹æ”¾ã™å‰ã«æ–°ã—ã„masterãŒå‹•ãå§‹ã‚ã¦èµ·å‹•ã«å¤±æ•—ã™ã‚‹ã“ã¨ãŒã‚ã£ãŸã®ã§ã€ã¨ã‚Šã‚ãˆãšé–“ã«<code>sleep 2</code>ã‚’å…¥ã‚Œã¦ã‚ã‚‹ã€‚ã²ã¨ã¾ãšã“ã‚Œã§å®‰å®šã—ã¦å†èµ·å‹•ã§ãã‚‹ã€‚é©å½“ã€‚</p><p>æœ€åˆã¯å¼·åˆ¶çš„ãªstopï¼ˆTERMã‚·ã‚°ãƒŠãƒ«ï¼‰ã¨gracefulãªstopï¼ˆQUITã‚·ã‚°ãƒŠãƒ«ï¼‰ã‚’åˆ¥ã®ã‚³ãƒãƒ³ãƒ‰ã«åˆ†ã‘ã¦ã„ãŸã®ã ãŒã€<code>stop()</code>ã®ã¨ãã«å‘¼ã°ã‚Œã‚‹å‡¦ç†ãŒ<code>gracefulstop()</code>ã¨ã‹ã«ã—ã¦ã—ã¾ã†ã¨å‘¼ã°ã‚Œãªã„ãŸã‚ã«ã€gracefulstopã—ã¦ã‚‚ã‚µãƒ¼ãƒ“ã‚¹ãŒåœæ­¢ã—ã¦ã„ãªã„ã¨åˆ¤æ–­ã•ã‚Œã¦ã—ã¾ã£ãŸã€‚ãã‚“ãªã‚ã‘ã§ã€postgresqlã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å‚è€ƒã«ã—ã¦stopã‚’æ›¸ãæ›ãˆãŸã€‚<code>start-stop-daemon</code>ã¯<code>--retry</code>ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«æ‰€å®šã®å½¢å¼ã®ãƒªã‚¹ãƒˆã‚’æ¸¡ã™ã¨ã€æœ€åˆã®è¦ç´ ã‹ã‚‰é †ã«æŒ‡å®šã•ã‚ŒãŸã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆåˆ†ã ã‘å¾…ã¡ãªãŒã‚‰ã‚·ã‚°ãƒŠãƒ«ã‚’é€ã£ã¦ãã‚Œã‚‹ã€‚ã“ã‚Œã‚’ç”¨ã„ã¦ã€æœ€åˆã¯QUITã‚’é€ã‚Šã€ãã‚Œã‹ã‚‰ä¸€å®šæ™‚é–“çµŒã£ã¦ã‚‚çµ‚äº†å‡ºæ¥ãªã‘ã‚Œã°TERMã‚’é€ã‚‹ã‚ˆã†ãªå‡¦ç†ã«ãªã£ã¦ã„ã‚‹ã€‚</p><p>ã“ã‚“ãªæ„Ÿã˜ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’<code>/etc/init.d/refxgroovin</code>ã¨ã—ã¦ä½œæˆã—ã¦ã€ã‚ã¨ã„ãã¤ã‹å¤‰æ•°ã‚’å®šç¾©ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’<code>/etc/conf.d/refxgroovin</code>ã¨ã—ã¦ä½œæˆã™ã‚‹ã€‚conf.dã®æ–¹ã§ã¯<code>REFXGROOVIN_USER</code>ã®è¨­å®šãŒå¿…é ˆã§ã‚ã‚‹ã€‚ã“ã‚Œä»¥å¤–ã«ã„ãã¤ã‹ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã®è¨­å®šã‚’è¡Œã†ã€‚ãã†ã—ãŸã‚‰</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ /etc/init.d/refxgroovin start
</span></span></code></pre></div><p>ã¨ã—ã¦ã‚µãƒ¼ãƒ“ã‚¹ã‚’èµ·å‹•ã•ã›ã‚‹ã€‚ã“ã‚Œã§ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦masterãŒreadyã«ãªã£ã¦ã„ã¦ã€ã‹ã¤<code>curl</code>ã‹ä½•ã‹ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æŠ•ã’ã¦è¿”äº‹ãŒè¿”ã£ã¦ãã‚Œã°æˆåŠŸã§ã‚ã‚‹ã€‚</p><h3 id=stagingã®è©±>stagingã®è©±</h3><p>ã¨ã“ã‚ã§ä»Šå›ã¯stagingç’°å¢ƒã«ã‚‚å¯¾å¿œã•ã›ã¦ã„ã‚‹ã€‚initã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯<code>refxgroovin.(env)</code>ã¨ã„ã†åå‰ã§<code>refxgroovin</code>ã¸ã®ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã‚’å¼µã‚Œã°ãŠã—ã¾ã„ã§ã‚ã‚‹ã€‚ã¤ã¾ã‚Šã€<code>refxgroovin.staging</code>ã¨ã„ã†åå‰ã§ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã‚’ä½œæˆã™ã‚‹ã¨ã€ãã‚ŒãŒstagingç’°å¢ƒå‘ã‘ã®initã‚¹ã‚¯ãƒªãƒ—ãƒˆã«ãªã‚‹ã€‚</p><p>conf.dã®æ–¹ã¯ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã§ã¯ãªãã‚³ãƒ”ãƒ¼ã§å¯¾å¿œã™ã‚‹ã€‚</p><h2 id=sudoers>sudoers</h2><p>ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ãŸã¨ãã€refxgroovinãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã‚µãƒ¼ãƒ“ã‚¹ã®å†èµ·å‹•ã¾ãŸã¯reloadãŒå‡ºæ¥ã‚Œã°ã‚ˆã„ã€‚ã—ã‹ã—ãªãŒã‚‰ã‚µãƒ¼ãƒ“ã‚¹ã®æ“ä½œã¨ã„ã†ã®ã¯å½“ç„¶ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ãªã„ã¨ã§ããªã„ã€‚ãã“ã§sudoã§ã‚ã‚‹ã€‚ã§ã‚‚refxgroovinãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯unicornã‚’å‹•ã‹ã™ã®ã§ã€ä»®ã«unicornã‚„Railsã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è‡ªèº«ã«ä»»æ„ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œã®è„†å¼±æ€§ãŒã‚ã£ãŸå ´åˆã€sudoã‹ã‚‰ä½•ã‹ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚ã ã‹ã‚‰ã¨ã„ã£ã¦refxgroovinãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã™ã‚‹ã¨ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹åº¦ã«ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ãªãã‚ƒã„ã‘ãªãã¦ã€ãã‚Œã¯é¢å€’ï¼ˆã“ã“ã¯é‹ç”¨æ–¹é‡ã«ä¾å­˜ã™ã‚‹æ°—ãŒã™ã‚‹ã‘ã©ï¼‰ã€‚</p><p>ãã†ã„ã†ã‚ã‘ã§ã€refxgroovinãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¯¾ã—ã¦ã¯ã€Œä»»æ„ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãªã—ã§ã€/etc/init.d/refxgroovinã¨/etc/init.d/refxgroovin.stagingã®å®Ÿè¡Œã®ã¿ã‚’è¨±å¯ã™ã‚‹ã€ã‚ˆã†ã«è¨­å®šã™ã‚‹ã€‚</p><pre tabindex=0><code>refxgroovin ALL = (ALL) NOPASSWD: /etc/init.d/refxgroovin, (ALL) NOPASSWD: /etc/init.d/refxgroovin.staging
</code></pre><p>ã‚’<code>visudo</code>ã§è¿½è¨˜ã™ã‚‹ã€‚<code>(ALL) NOPASSWD:</code>ã¯2å›æ›¸ã‹ãªãã¦ã‚ˆã‹ã£ãŸã‚ˆã†ãªæ°—ã‚‚ã™ã‚‹ã®ã ãŒã€ä½•ã‹å‹•ã‹ãªã‹ã£ãŸã®ã§2å›æ›¸ã„ã¦ã‚ã‚‹ï¼ˆä»–ã«åŸå› ãŒã‚ã£ãŸã‹ã‚‚ã—ã‚Œãªã„ï¼‰ã€‚</p><p>ã“ã®çŠ¶æ…‹ã§ä¸€åº¦è©¦ã—ã«ã‚µãƒ¼ãƒãƒ¼ä¸Šã§</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sudo /etc/init.d/refxgroovin reload
</span></span></code></pre></div><p>ã¨ã‹ã‚„ã£ã¦å‹•ãã‹ã©ã†ã‹ã‚’ç¢ºèªã™ã‚‹ã€‚å‹•ã‹ãªã‹ã£ãŸã‚‰ã‚°ã‚°ã£ã¦ã¿ã‚‹ã¨ã‹manã‚’èª­ã‚€ã¨ã‹ã—ã¦ã»ã—ã„ã€‚</p><p>ã²ã¨ã¾ãšã“ã‚Œã§refxgroovinãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒrootï¼ˆã¨ã‹ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™ï¼‰ã§å‡ºæ¥ã‚‹ã“ã¨ã¯initã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½¿ã£ã¦refxgroovinãƒ‡ãƒ¼ãƒ¢ãƒ³ã‚’æ“ä½œã™ã‚‹ã“ã¨ã ã‘ã«ãªã£ãŸã€ã¯ãšã§ã‚ã‚‹ã€‚ãŸã¶ã‚“ã€‚</p><p>ã¡ã‚ƒã‚“ã¨å‹•ã„ãŸãªã‚‰ã°ã€<code>deploy.rb</code>ã®<code>to :launch</code>ã‚’æ›¸ãæ›ãˆã‚‹ã€‚ä¸Šè¨˜ã®ä¾‹ã®ã‚ˆã†ã«<code>queue</code>ã‚’ä½¿ã£ã¦<code>sudo</code>ã‚’å‘¼ã¹ã°ã‚ˆã„ã€‚ç·¨é›†ã—ãŸã‚‰ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã¿ã¦ã€ã¡ã‚ƒã‚“ã¨ãƒ‡ãƒ—ãƒ­ã‚¤ãŒæˆåŠŸã™ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã™ã‚‹ã€‚</p><p>ç§ã¯å½“åˆunicornã®pidfileã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ä½ç½®ã«è¨­å®šã—ã¦ã„ãŸãŒã€ã“ã®è¨­å®šã§ã¯reloadãŒå¤±æ•—ã—ãŸã€‚</p><p>pidfileã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ä½ç½®ã¯<code>#{APPROOT}/tmp/pids/unicorn.rb</code>ã ãŒï¼ˆä»Šå›ã§ã‚ã‚Œã°<code>APPROOT</code>ã¯<code>/home/refxgroovin/current</code>ï¼‰ã€MinaãŒlaunchã‚’è©¦ã¿ã‚‹ã®ã¯<em>currentãŒæœ€æ–°ç‰ˆã®ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã«ç½®ãæ›ã‚ã£ãŸå¾Œ</em>ã§ã‚ã‚‹ã€‚ã¤ã¾ã‚Šã€ä¾‹ãˆã°å…ƒã€…<code>releases/4</code>ãŒcurrentã ã£ãŸã¨ã—ã¦ã€ãã®çŠ¶æ…‹ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦<code>to :launch</code>ãŒå‹•ãã®ã¯currentãŒ<code>releases/5</code>ã«ç½®ãæ›ã‚ã£ãŸå¾Œã«ãªã‚‹ã€‚è¦ã¯pidfileã¯releases/4/tmp/pidsã«ã‚ã‚‹ã®ã«ã€releases/5/tmp/pidsã‚’è¦‹ã«è¡Œã£ã¦ã—ã¾ã†ã€‚å½“ç„¶ãã“ã«ã¯ä½•ã‚‚ãªã„ã®ã§pidfileãŒãªã„ã¨ã„ã£ã¦å¤±æ•—ã™ã‚‹ã€‚</p><p>ãã‚“ãªã‚ã‘ã§æ˜ç¤ºçš„ã«ã€ã‹ã¤ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã¨ã‹ã§å®Ÿä½“ã®ä½ç½®ãŒå¤‰ã‚ã‚‰ãªã„å ´æ‰€ã«pidfileã®å ´æ‰€ã‚’è¨­å®šã—ã¦ãŠãå¿…è¦ãŒã‚ã‚‹ã€‚ä»Šå›ã®å ´åˆã¯<code>shared/pids/unicorn.pid</code>ã«ã—ãŸã€‚sharedä»¥ä¸‹ã«é…ç½®ã—ã¦ã„ã‚‹ãŒã€<code>shared_paths</code>ã«ã¯è¨­å®šã—ã¦ã„ãªã„ï¼ˆã“ã†ã„ã†ä½¿ã„æ–¹ãŒMinaçš„ã«OKãªã®ã‹ã¯çŸ¥ã‚‰ãªã„ï¼‰ã€‚ã¾ãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªè‡ªä½“ãŒãªã„ã¨èµ·å‹•ã«å¤±æ•—ã™ã‚‹ã®ã§ã€setupæ™‚ã«<code>shared/pids</code>ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã™ã‚‹ã‚ˆã†ã«ã—ãŸã€‚</p></div></div></div><script src=https://aquarite.info/js/ui.js></script><script src=https://aquarite.info/js/menus.js></script><script data-goatcounter=https://aquarite.goatcounter.com/count async src=//gc.zgo.at/count.js></script></body></html>