<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=generator content="Hugo 0.109.0"><title>Different Behaviors of DownloadString and Uri between .NET and Mono &#183; Hello, (forgotten) world ☂</title><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/pure-min.css><!--[if lte IE 8]><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-old-ie-min.css><![endif]--><!--[if gt IE 8]><!--><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-min.css><!--<![endif]--><!--[if lte IE 8]><link rel=stylesheet href=https://aquarite.info/css/side-menu-old-ie.css><![endif]--><!--[if gt IE 8]><!--><link rel=stylesheet href=https://aquarite.info/css/side-menu.css><!--<![endif]--><link rel=stylesheet href=https://aquarite.info/css/blackburn.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css2?family=Raleway&display=swap" rel=stylesheet type=text/css><link rel="shortcut icon" href=https://aquarite.info/img/favicon.ico type=image/x-icon><meta property="og:title" content="Different Behaviors of DownloadString and Uri between .NET and Mono"><meta property="og:description" content="Note: This is the summary of my posts (they are written in Japanese): tkbctf3 Miocat MonoのWebClientにおけるURI 結局Monoと.NETの挙動の違いはなんだったのか I already reported this as a bug for Xamarin&rsquo;s Bugzilla. Introduction I found the different behavior of WebClient.DownloadString(String) between Mono and .NET Framework when an invalid URI passed to it. In the Mono&rsquo;s implementation, it may cause a security issue. This causes by two different behaviors, in new Uri(String), and Path.GetFullPath(String). DownloadString DownloadString(String) and some methods (e.g. DownloadFile(String), OpenRead(String), etc.) calls CreateUri(String), a private method of WebClient. (-> source code on github) CreateUri and GetUri CreateUri(String) tries to make"><meta property="og:type" content="article"><meta property="og:url" content="https://aquarite.info/blog/2014/05/different-behaviors-of-downloadstring-and-uri-between-net-and-mono/"><meta property="og:image" content="https://aquarite.info/images/cover.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2014-05-08T07:43:38+09:00"><meta property="article:modified_time" content="2014-05-08T07:43:38+09:00"><meta property="og:site_name" content="Hello, (forgotten) world ☂"></head><body><div id=layout><a href=#menu id=menuLink class=menu-link><span></span></a><div id=menu><a class="pure-menu-heading brand" href=https://aquarite.info/>aquarite.info</a><div class=pure-menu><ul class=pure-menu-list><li class=pure-menu-item><a class=pure-menu-link href=https://aquarite.info/><i class='fa fa-home fa-fw'></i>Home</a></li><li class=pure-menu-item><a class=pure-menu-link href=https://aquarite.info/about/><i class='fa fa-user fa-fw'></i>About</a></li></ul></div><div class="pure-menu social"><ul class=pure-menu-list><li class=pure-menu-item><a class=pure-menu-link href=https://twitter.com/maytheplic rel=me target=_blank><i class="fab fa-twitter-square fa-fw"></i>Twitter</a></li><li class=pure-menu-item><a class=pure-menu-link href=https://github.com/mayth rel=me target=_blank><i class="fab fa-github-square fa-fw"></i>GitHub</a></li><li class=pure-menu-item><a class=pure-menu-link href=https://steamcommunity.com/id/maythorzy rel=me target=_blank><i class="fab fa-steam-square fa-fw"></i>Steam</a></li></ul></div><div><div class=small-print><small>&copy; 2021 Mei Akizuru. All rights reserved.</small></div><div class=small-print><small>Built with&nbsp;<a href=https://gohugo.io/ target=_blank>Hugo</a></small>
<small>Theme&nbsp;<a href=https://github.com/yoshiharuyamashita/blackburn target=_blank>Blackburn</a></small></div></div></div><div id=main><div class=header><h1>Different Behaviors of DownloadString and Uri between .NET and Mono</h1><h2></h2></div><div class=content><p>Note: This is the summary of my posts (they are written in Japanese):</p><ul><li><a href=http://tech.aquarite.info/blog/2014/05/07/tkbctf3-miocat/>tkbctf3 Miocat</a></li><li><a href=http://tech.aquarite.info/blog/2014/05/07/uri-parsing-in-webclient/>MonoのWebClientにおけるURI</a></li><li><a href=http://tech.aquarite.info/blog/2014/05/08/download-string-in-mono-and-dotnet-framework/>結局Monoと.NETの挙動の違いはなんだったのか</a></li></ul><p>I already reported this as a bug for Xamarin&rsquo;s Bugzilla.</p><h1 id=introduction>Introduction</h1><p>I found the different behavior of <code>WebClient.DownloadString(String)</code> between Mono and .NET Framework when an invalid URI passed to it. In the Mono&rsquo;s implementation, it may cause a security issue.</p><p>This causes by two different behaviors, in <code>new Uri(String)</code>, and <code>Path.GetFullPath(String)</code>.</p><h1 id=downloadstring>DownloadString</h1><p><code>DownloadString(String)</code> and some methods (e.g. <code>DownloadFile(String)</code>, <code>OpenRead(String)</code>, etc.) calls <code>CreateUri(String)</code>, a private method of <code>WebClient</code>. (-> <a href=https://github.com/mono/mono/blob/master/mcs/class/System/System.Net/WebClient.cs#L798>source code on github</a>)</p><h2 id=createuri-and-geturi>CreateUri and GetUri</h2><p><code>CreateUri(String)</code> tries to make an instance of <code>Uri</code> with <code>new Uri(String)</code>. If an invalid URI passed, the constructor raises an exception. For example, <code>new Uri("http://../../../etc/passwd")</code> will be failed because its hostname part (<code>..</code>) is invalid. However, the failure will be ignored, and <code>CreateUri(String)</code> returns <code>new Uri(Path.GetFullPath(String))</code>. It means the local file address with the full path will be returned.</p><p>In .NET Framework, <code>DownloadString(String)</code> calls <code>GetUri(String)</code>, and it may have the same behavior as <code>CreateUri(String)</code>. (I didn&rsquo;t read its implementation, but I guess it from the stack trace when an exception is thrown.)</p><h1 id=uri-constructor>Uri constructor</h1><p>In .NET, <code>new Uri(String)</code> fails when an invalid URI with a known scheme is given (e.g. <code>http://../../etc/passwd</code>), however, it <em>succeeds</em> when a invalid URI with <em>an unknown scheme</em> is given (e.g. <code>abc://../../etc/passwd</code>).</p><p>In Mono, <code>new Uri(String)</code> fails for both cases.</p><p>This is the first different behavior.</p><h1 id=pathgetfullpath>Path.GetFullPath</h1><p>While <code>Path.GetFullPath</code> fails for URIs which has known schemes in .NET, it succeeds for any URIs in Mono.</p><p>For example, <code>http://../etc/passwd</code> is given, .NET&rsquo;s <code>Path.GetFullPath</code> fails with ArgumentException (&ldquo;URI formats are not supported.&rdquo;), but Mono&rsquo;s succeeds and returns the full path like <code>/home/mayth/etc/passwd</code>.</p><p>Another example: <code>abc://../etc/passwd</code> is given, .NET&rsquo;s <code>Path.GetFullPath</code> will succeeds, and Mono&rsquo;s also succeeds.</p><p>This result shows that .NET&rsquo;s implemantation may recognize the scheme of the given URI, and Mono&rsquo;s one may not.</p><p>This is the second different behavior.</p><h1 id=the-flow-of-downloadstringstring>The Flow of DownloadString(String)</h1><h2 id=net>.NET</h2><h3 id=invalid-uris-with-known-scheme>Invalid URIs with known scheme</h3><p>By default, &lsquo;known scheme&rsquo; means these schemes:</p><ul><li>http://</li><li>https://</li><li>ftp://</li><li>file://</li></ul><p>This is documented on MSDN (See: <a href=http://msdn.microsoft.com/en-us/library/bw00b1dc.aspx>WebRequest.Create Method (String)</a>).</p><p>parameter: addr = <code>http://../../etc/passwd</code></p><ol><li><code>GetUri(addr)</code> is called</li><li>Try to <code>new Uri(addr)</code>, and it fails</li><li>An exception is ignored, and <code>Path.GetFullPath(addr)</code> is called</li><li><code>Path.GetFullPath(addr)</code> throws ArgumentException with the message: &ldquo;URI formats are not supported.&rdquo;</li></ol><h3 id=invalid-uris-with-unknown-scheme>Invalid URIs with unknown scheme</h3><p>parameter: addr = <code>abc://../../etc/passwd</code></p><ol><li><code>GetUri(addr)</code> is called</li><li>Try to <code>new Uri(addr)</code>, and it succeeds.</li><li><code>GetUri(addr)</code> returns the result of step2.</li><li><code>WebRequest.Create</code> is called.</li><li>It throws NotSupportedException because it does not know how to handle the given URI&rsquo;s scheme.</li></ol><h2 id=mono>Mono</h2><p>In Mono, there is no difference whether the URI&rsquo;s scheme is known or not.</p><p>parameter: addr = <code>http://../../etc/passwd</code></p><ol><li><code>GetUri(addr)</code> is called</li><li>Try to <code>new Uri(addr)</code>, and it fails</li><li>An exception is ignored, and <code>Path.GetFullPath(addr)</code> is called</li><li><code>Path.GetFullPath(addr)</code> returns the full path (e.g. <code>/home/etc/passwd</code>)</li><li>The full path passed to <code>new Uri(String)</code>. This may result <code>file:///home/etc/passwd</code>.</li><li>Attempt to acquire the resource, <code>file:///home/etc/passwd</code>.</li></ol><h1 id=security-issue>Security Issue</h1><p>Like the samples shown above, <code>DownloadString(String)</code> can access to the local resource, like <code>/etc/passwd</code>.</p><h2 id=directory-traversal>Directory Traversal</h2><p>If the program runs at /home/mayth, for example, the code below will returns the content of <code>/etc/passwd</code>.</p><pre tabindex=0><code>WebClient.DownloadString(&#34;http://../../../etc/passwd&#34;)
</code></pre><p>Of course, any files that is readable from the user who runs the program can be read. For example, the files in the home directory can be read.</p><p>The attackers can&rsquo;t know the listings of the directory, but they suggest it, or guess from <code>.bash_history</code> file.</p><h2 id=full-path-disclosure>Full Path Disclosure</h2><p>If the program runs at <code>/home/mayth</code>, the code below will fail because it won&rsquo;t be found.</p><pre tabindex=0><code>WebClient.DownloadString(&#34;http://../../etc/passwd&#34;)
</code></pre><p>In this case, an exception&rsquo;s message is: &lsquo;Could not find a part of the path &ldquo;/home/etc/passwd&rdquo;&rsquo;. If you output this message somewhere (stdout, log file, etc.), the attackers may be possible to see the full path.</p></div></div></div><script src=https://aquarite.info/js/ui.js></script>
<script src=https://aquarite.info/js/menus.js></script>
<script data-goatcounter=https://aquarite.goatcounter.com/count async src=//gc.zgo.at/count.js></script></body></html>